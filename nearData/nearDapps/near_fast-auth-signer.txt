*GitHub Repository "near/fast-auth-signer"*

'''--- .eslintrc.js ---
module.exports = {
  env:      { browser: true, node: true },
  parser:   '@typescript-eslint/parser',
  settings: {
    'import/parsers': {
      '@typescript-eslint/parser': ['.ts', '.tsx']
    },
    'import/extensions': [
      '.ts',
      '.tsx'
    ]
  },
  overrides: [{
    files: ['*.ts', '*.tsx'],
  }],
  ignorePatterns: ['dist'],
  extends:        ['airbnb', 'plugin:import/errors', 'plugin:import/typescript'],
  plugins:        ['react-hooks'],
  rules:          {
    'no-unused-vars':                    ['error', { argsIgnorePattern: '^_' }],
    'react-hooks/exhaustive-deps':       'warn',
    'linebreak-style':                   0,
    'react/require-default-props':       'off',
    'react/prop-types':                  'off',
    'react/jsx-filename-extension':      'off',
    'react/jsx-props-no-spreading':      'off',
    'import/no-extraneous-dependencies': 'off',
    'import/prefer-default-export':      'off',
    'prefer-destructuring':                [
      'error', {
        VariableDeclarator:   {
          array:  false,
          object: true
        },
        AssignmentExpression: {
          array:  false,
          object: false
        }
      }, {
        enforceForRenamedProperties: false
      }
    ],
    'max-classes-per-file':                'off',
    indent:                                [
      'error', 2, {
        SwitchCase:         1,
        VariableDeclarator: { var: 2, let: 2, const: 3 },
        ObjectExpression:   'first'
      }
    ],
    semi:                                  ['error', 'always'],
    'comma-dangle':                        ['error', 'only-multiline'],
    'max-len':                             [
      'error', 120, {
        ignoreComments: true, ignoreStrings: true, ignoreTemplateLiterals: true
      }
    ],
    'no-multi-spaces':                     [
      'error', {
        exceptions: {
          ExportNamedDeclaration: true,
          VariableDeclarator:     true,
          AssignmentExpression:   true,
          AssignmentPattern:      true
        }
      }
    ],
    'global-require':                      'warn',
    'one-var':                             ['error', 'never'],
    strict:                                'off',
    camelcase:                             'off',
    'no-console':                          'off',
    'func-names':                          'off',
    'no-param-reassign':                   'off',
    'arrow-body-style':                    ['error', 'as-needed', { requireReturnForObjectLiteral: true }],
    'no-underscore-dangle':                'off',
    'import/extensions':    ['error',
      { json: 'always' }
    ],
    'import/order':                        [
      'error', {
        alphabetize:        {
          order:           'asc',
          caseInsensitive: true
        },
        'newlines-between': 'always',
        groups:             [
          'builtin',
          ['external', 'internal'],
          ['sibling', 'parent', 'index'],
          'object'
        ]
      }
    ],
    'arrow-parens':                        ['error', 'always'],
    'key-spacing':                         ['warn', { align: 'value', mode: 'minimum' }],
    'one-var-declaration-per-line':        ['error', 'initializations']
  },
};

'''
'''--- .github/ISSUE_TEMPLATE/bug-defect-problem.md ---
---
name: Bug / Defect / Problem
about: Find a problem? Something not working? Please fill out as much info as possible.
title: "[Defect] "
labels: bug, Emerging Tech, Near BOS
assignees: ''

---

**Describe the bug**

<!-- A clear and concise description of what the bug is. -->

**Steps To Reproduce**

_Steps to reproduce the behavior:_

1. Go to '...'
2. Click on '....'
3. Scroll down to '....'

_Error description_

**Expected behavior**

<!-- A clear and concise description of what you expected to happen. -->

**Screenshots**

<!-- _If applicable, add screenshots or videos to help explain your problem._ -->

**Desktop**: <!-- please complete the following information -->
* OS <!-- e.g. iOS -->: 
* Browser <!-- e.g. chrome, safari -->: 
* Browser Version <!-- e.g. 22 -->: 

**Smartphone**: <!-- please complete the following information -->
* Device <!-- e.g. iPhone6 -->: 
* OS <1-- e.g. iOS8.1 -->: 
* Browser <!-- e.g. stock browser, safari -->: 
* Browser Version <!-- e.g. 22 -->: 

**Additional Context**

<!-- Add any other context about the problem here. -->

'''
'''--- .github/ISSUE_TEMPLATE/epic-template.md ---
---
name: Epic Template
about: Epics are milestones or groups of alike issues
title: "\U0001F537 [Epic] Template"
labels: Emerging Tech, Epic, Near BOS
assignees: ''

---

### Description
(Overview of milestone or function governed by this epic)

### Resources
(Relevant documentation, Figma links, and other reference material)
- Item 1
- Item 2
- Item 3

```[tasklist]
### Related Issues
```

'''
'''--- .github/ISSUE_TEMPLATE/feature_request.md ---
---
name: Feature request
about: Suggest an idea for this project
title: "[Feature Request] "
labels: Emerging Tech, feature request, Near BOS
assignees: ''

---

**Is your feature request related to a problem? Please describe.**
A clear and concise description of what the problem is. Ex. I'm always frustrated when [...]

**Describe the solution you'd like**
A clear and concise description of what you want to happen.

**Describe alternatives you've considered**
A clear and concise description of any alternative solutions or features you've considered.

**Additional context**
Add any other context or screenshots about the feature request here.

'''
'''--- .github/ISSUE_TEMPLATE/issue-template.md ---
---
name: Issue Template
about: Regular Issues (tasks, defects)
title: ''
labels: Emerging Tech, Near BOS
assignees: ''

---

### Description

(Summary of task, purpose, impact)

### Optional: User Story

(As a [user], I need [function, outcome, enhancement] that [provides value].)

'''
'''--- .github/workflows/bundle-and-deploy.yml ---
name: Bundle and Deploy Site

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

env:
  REACT_APP_BASE_PATH: 'fastauth'
  NETWORK_ID: ${{ inputs.environment == 'staging' && 'testnet' || inputs.environment }}
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

jobs:
  bundle-frontend:
    defaults:
      run:
        working-directory: ./packages/near-fast-auth-signer
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - run: yarn bundle
      - uses: google-github-actions/setup-gcloud@v1
      - uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_KEY_JSON }}
      - run: gcloud auth activate-service-account ${{ secrets.SERVICE_ACCOUNT }} --key-file=$GOOGLE_GHA_CREDS_PATH
      - run: gsutil rsync -r -d ./dist ${{ secrets.GCP_BUCKET }}/fastauth

'''
'''--- .github/workflows/deploy-main.yml ---
name: Deploy Site

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

concurrency:
  group: 'fast-auth-signer-deployment'
  cancel-in-progress: true

jobs:
  deploy-testnet:
    uses: ./.github/workflows/bundle-and-deploy.yml
    with:
      environment: testnet
    secrets: inherit

  deploy-staging:
    uses: ./.github/workflows/bundle-and-deploy.yml
    with:
      environment: staging
    secrets: inherit

  deploy-mainnet:
    uses: ./.github/workflows/bundle-and-deploy.yml
    with:
      environment: mainnet
    secrets: inherit

  deploy-docker-image-to-docker-hub:
    uses: ./.github/workflows/push-to-docker-hub.yml
    secrets: inherit
'''
'''--- .github/workflows/playwright.yml ---
name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    defaults:
      run:
        working-directory: ./packages/near-fast-auth-signer-e2e-tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18
    - name: Install dependencies
      run: npm install -g yarn && yarn
    - name: Install Playwright Browsers
      run: yarn playwright install --with-deps
    - name: Run Playwright tests
      run: yarn playwright test
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: ./packages/near-fast-auth-signer-e2e-tests/playwright-report/
        retention-days: 30

'''
'''--- .github/workflows/pull-request.yml ---
name: PR Actions

on:
  pull_request:

concurrency:
  group: ${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  checks:
    defaults:
      run:
        working-directory: ./packages/near-fast-auth-signer
    runs-on: ubuntu-latest

    steps:
      - name: Code Checkout
        uses: actions/checkout@v3

      - name: Install NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install NPM Dependencies
        run: yarn install

      - name: Run Linting
        run: yarn lint

'''
'''--- .github/workflows/push-to-artifact-registry.yml ---
name: Push to Artifact Registry GitHub Action

on:
  workflow_call:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push-to-artifact-registry:
    defaults:
      run:
        working-directory: ./packages/near-fast-auth-signer
    runs-on: ubuntu-latest
    environment: mainnet
    steps:
      - uses: actions/checkout@v3

      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-central1-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.SERVICE_ACCOUNT_KEY_JSON }}

      - name: Get tag
        id: get-tag
        run: echo ::set-output name=short_ref::${GITHUB_REF#refs/*/}

      - id: docker-push-tagged
        name: Tag Docker image and push to Google Artifact Registry
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: |
             us-central1-docker.pkg.dev/pagoda-discovery-platform-prod/cloud-run-source-deploy/fast-auth-sdk-frontend:${{ steps.get-tag.outputs.short_ref }}
             us-central1-docker.pkg.dev/pagoda-discovery-platform-prod/cloud-run-source-deploy/fast-auth-sdk-frontend:latest

'''
'''--- .github/workflows/push-to-docker-hub.yml ---
name: Push to Docker Hub GitHub Action

on:
  workflow_call:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push-to-docker-hub:
    defaults:
      run:
        working-directory: ./packages/near-fast-auth-signer
    runs-on: ubuntu-latest
    environment: mainnet
    steps:
      - uses: actions/checkout@v3
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Get tag
        id: get-tag
        run: echo "sha_short=$(git rev-parse --short "$GITHUB_SHA")" >> "$GITHUB_ENV"
          
      - id: docker-push-tagged
        name: Tag Docker image and push to Google Artifact Registry
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/near-fast-auth-signer/Dockerfile
          push: true
          tags: |
             nearprotocol/fast-auth-sdk-frontend:${{ env.sha_short }}
             nearprotocol/fast-auth-sdk-frontend:latest

'''
'''--- .idea/codeStyles/codeStyleConfig.xml ---
<component name="ProjectCodeStyleConfiguration">
  <state>
    <option name="PREFERRED_PROJECT_CODE_STYLE" value="Default" />
  </state>
</component>

'''
'''--- .idea/inspectionProfiles/Project_Default.xml ---
<component name="InspectionProjectProfileManager">
  <profile version="1.0">
    <option name="myName" value="Project Default" />
    <inspection_tool class="Eslint" enabled="true" level="WARNING" enabled_by_default="true" />
  </profile>
</component>
'''
'''--- .idea/jsLibraryMappings.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="JavaScriptLibraryMappings">
    <includedPredefinedLibrary name="Node.js Core" />
  </component>
</project>
'''
'''--- .idea/jsLinters/eslint.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="EslintConfiguration">
    <option name="fix-on-save" value="true" />
  </component>
</project>
'''
'''--- .idea/modules.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ProjectModuleManager">
    <modules>
      <module fileurl="file://$PROJECT_DIR$/.idea/fast-auth-signer.iml" filepath="$PROJECT_DIR$/.idea/fast-auth-signer.iml" />
    </modules>
  </component>
</project>
'''
'''--- .idea/prettier.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="PrettierConfiguration">
    <option name="myConfigurationMode" value="AUTOMATIC" />
  </component>
</project>
'''
'''--- .idea/vcs.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="VcsDirectoryMappings">
    <mapping directory="" vcs="Git" />
  </component>
</project>
'''
'''--- .vscode/launch.json ---
{
  // Use IntelliSense to learn about possible attributes.
  // Hover to view descriptions of existing attributes.
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
  "version": "0.2.0",
  "configurations": [
    {
      "type": "chrome",
      "request": "launch",
      "name": "Launch Chrome against localhost",
      "url": "http://localhost:1234",
      "webRoot": "${workspaceFolder}"
    }
  ]
}

'''
'''--- README.md ---
# fast-auth-signer ![Docker Pulls](https://img.shields.io/docker/pulls/nearprotocol/fast-auth-sdk-frontend?link=https%3A%2F%2Fhub.docker.com%2Fr%2Fnearprotocol%2Ffast-auth-sdk-frontend)
Monorepo for fast-auth-signer functionality - contains frontend app, and associated E2E test suites defined using Playwright

## Packages
#### [near-fast-auth-signer](./packages/near-fast-auth-signer/README.md)
Web application designed primarily for usage via embedding into parent site using an iframe 
#### [near-fast-auth-signer-e2e-tests](./packages/near-fast-auth-signer-e2e-tests/README.md)
E2E test suites for `near-fast-auth-signer` using Playwright tests.

## Usage
This repository leverages Yarn workspaces.  

#### Local Development
Run `yarn` from the repository root. This will install dependencies for all packages by way of Yarn workspaces functionality.
#### Run your own instance
Instructions to run your own instance of the signer app can be found [here](https://docs.near.org/tools/fastauth-sdk#setting-up-the-frontend).
#### End-to-End tests
Run `yarn test` from the repository root.

'''
'''--- lerna.json ---
{
  "$schema": "node_modules/lerna/schemas/lerna-schema.json",
  "version": "1.0.1",
  "packages": [
    "packages/*"
  ],
  "npmClient": "yarn"
}

'''
'''--- package.json ---
{
  "name": "fast-auth-signer-monorepo",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "yarn && yarn workspace fast-auth-signer-e2e-tests test"
  },
  "devDependencies": {
    "@types/node": "^20.9.0",
    "lerna": "^7.4.1"
  },
  "author": "Pagoda, Inc.",
  "license": "MIT",
  "workspaces": [
    "packages/*"
  ],
  "private": true
}

'''
'''--- packages/near-fast-auth-signer-e2e-tests/.eslintrc.js ---
module.exports = {
  env:      { browser: true, node: true },
  parser:   '@typescript-eslint/parser',
  settings: {
    'import/parsers': {
      '@typescript-eslint/parser': ['.ts', '.tsx']
    },
    'import/extensions': [
      '.ts',
      '.tsx'
    ]
  },
  overrides: [{
    files: ['*.ts', '*.tsx'],
  }],
  ignorePatterns: ['dist'],
  extends:        ['airbnb', 'plugin:import/errors', 'plugin:import/typescript'],
  rules:          {
    'linebreak-style':                   0,
    'react/require-default-props':       'off',
    'react/prop-types':                  'off',
    'react/jsx-filename-extension':      'off',
    'react/jsx-props-no-spreading':      'off',
    'import/no-extraneous-dependencies': 'off',
    'import/prefer-default-export':      'off',
    'prefer-destructuring':                [
      'error', {
        VariableDeclarator:   {
          array:  false,
          object: true
        },
        AssignmentExpression: {
          array:  false,
          object: false
        }
      }, {
        enforceForRenamedProperties: false
      }
    ],
    'max-classes-per-file':                'off',
    indent:                                [
      'error', 2, {
        SwitchCase:         1,
        VariableDeclarator: { var: 2, let: 2, const: 3 },
        ObjectExpression:   'first'
      }
    ],
    semi:                                  ['error', 'always'],
    'comma-dangle':                        ['error', 'only-multiline'],
    'max-len':                             [
      'error', 120, {
        ignoreComments: true, ignoreStrings: true, ignoreTemplateLiterals: true
      }
    ],
    'no-multi-spaces':                     [
      'error', {
        exceptions: {
          ExportNamedDeclaration: true,
          VariableDeclarator:     true,
          AssignmentExpression:   true,
          AssignmentPattern:      true
        }
      }
    ],
    'global-require':                      'warn',
    'one-var':                             ['error', 'never'],
    strict:                                'off',
    camelcase:                             'off',
    'no-console':                          'off',
    'func-names':                          'off',
    'no-param-reassign':                   'off',
    'arrow-body-style':                    ['error', 'as-needed', { requireReturnForObjectLiteral: true }],
    'no-underscore-dangle':                'off',
    'import/extensions':    ['error',
      { json: 'always' }
    ],
    'import/order':                        [
      'error', {
        alphabetize:        {
          order:           'asc',
          caseInsensitive: true
        },
        'newlines-between': 'always',
        groups:             [
          'builtin',
          ['external', 'internal'],
          ['sibling', 'parent', 'index'],
          'object'
        ]
      }
    ],
    'arrow-parens':                        ['error', 'always'],
    'key-spacing':                         ['warn', { align: 'value', mode: 'minimum' }],
    'one-var-declaration-per-line':        ['error', 'initializations']
  },
};

'''
'''--- packages/near-fast-auth-signer-e2e-tests/README.md ---
# `fast-auth-signer-e2e-tests`

> TODO: description

## Usage

```
const fastAuthSignerE2eTests = require('fast-auth-signer-e2e-tests');

// TODO: DEMONSTRATE API
```

'''
'''--- packages/near-fast-auth-signer-e2e-tests/package.json ---
{
  "name": "near-fast-auth-signer-e2e-tests",
  "version": "0.0.1",
  "description": "End-to-end test suite for fast-auth-signer frontend",
  "author": "Pagoda, Inc.",
  "license": "MIT",
  "main": "lib/index.js",
  "directories": {
    "lib": "lib",
    "test": "__tests__"
  },
  "files": [
    "lib"
  ],
  "scripts": {
    "test": "yarn playwright test",
    "start": "webpack serve --mode development --history-api-fallback"
  },
  "dependencies": {
    "https-browserify": "^1.0.0",
    "near-fast-auth-signer": "*",
    "near-fastauth-wallet": "^0.0.10",
    "@near-wallet-selector/core": "8.7.0",
    "process": "^0.11.10",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "stream-browserify": "^3.0.0",
    "stream-http": "^3.2.0",
    "typescript": "^5.0.4",
    "url": "^0.11.3"
  },
  "devDependencies": {
    "@babel/preset-env": "^7.23.3",
    "@babel/preset-react": "^7.23.3",
    "@playwright/test": "^1.39.0",
    "@types/node": "^20.9.0",
    "playwright": "^1.39.0",
    "webpack": "^5.89.0",
    "webpack-cli": "^5.1.4",
    "webpack-dev-server": "^4.15.1"
  },
  "private": true
}

'''
'''--- packages/near-fast-auth-signer-e2e-tests/playwright.config.ts ---
import { defineConfig, devices } from '@playwright/test';

/**
 * Read environment variables from file.
 * https://github.com/motdotla/dotenv
 */
// require('dotenv').config();

/**
 * See https://playwright.dev/docs/test-configuration.
 */
export default defineConfig({
  testDir:       './tests',
  /* Run tests in files in parallel */
  fullyParallel: true,
  /* Fail the build on CI if you accidentally left test.only in the source code. */
  forbidOnly:    !!process.env.CI,
  /* Retry on CI only */
  retries:       process.env.CI ? 2 : 0,
  /* Opt out of parallel tests on CI. */
  workers:       process.env.CI ? 1 : undefined,
  /* Reporter to use. See https://playwright.dev/docs/test-reporters */
  reporter:      'html',
  /* Shared settings for all the projects below. See https://playwright.dev/docs/api/class-testoptions. */
  use:           {
    /* Base URL to use in actions like `await page.goto('/')`. */
    // baseURL: 'http://127.0.0.1:3000',

    /* Collect trace when retrying the failed test. See https://playwright.dev/docs/trace-viewer */
    trace: 'on-first-retry',
  },

  /* Configure projects for major browsers */
  projects: [
    {
      name: 'chromium',
      use:  { ...devices['Desktop Chrome'] },
    },

    {
      name: 'firefox',
      use:  { ...devices['Desktop Firefox'] },
    },

    {
      name: 'webkit',
      use:  { ...devices['Desktop Safari'] },
    },

    /* Test against mobile viewports. */
    // {
    //   name: 'Mobile Chrome',
    //   use: { ...devices['Pixel 5'] },
    // },
    // {
    //   name: 'Mobile Safari',
    //   use: { ...devices['iPhone 12'] },
    // },

    /* Test against branded browsers. */
    // {
    //   name: 'Microsoft Edge',
    //   use: { ...devices['Desktop Edge'], channel: 'msedge' },
    // },
    // {
    //   name: 'Google Chrome',
    //   use: { ...devices['Desktop Chrome'], channel: 'chrome' },
    // },
  ],

  /* Run your local dev serve`r` before starting the tests */
  webServer: [{
    command:             'cd ../near-fast-auth-signer && yarn run start',
    url:                 'http://127.0.0.1:3000',
    reuseExistingServer: !process.env.CI,
  },
  {
    command:             'yarn run start',
    url:                 'http://127.0.0.1:3030',
    reuseExistingServer: !process.env.CI,
  }
  ],
});

'''
'''--- packages/near-fast-auth-signer-e2e-tests/public/index.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Fast Auth Test App</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
<div id="root"></div>
</body>
</html>

'''
'''--- packages/near-fast-auth-signer-e2e-tests/test-app/index.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/">
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Fast Auth Signer Test App</title>
</head>
<body>
<div id="root"></div>
<script src="index.tsx"></script>
</body>
</html>

'''
'''--- packages/near-fast-auth-signer-e2e-tests/tests/example.spec.ts ---
import { test, expect } from '@playwright/test';

test('has title', async ({ page }) => {
  await page.goto('http://localhost:3030/');

  const walletSelector = page.locator('#ws-loaded');
  await walletSelector.waitFor();

  // Expect a title "to contain" a substring.
  await expect(page).toHaveTitle(/Fast Auth Test App/);
});

'''
'''--- packages/near-fast-auth-signer-e2e-tests/tsconfig.json ---
{
  "compilerOptions": {
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "esModuleInterop": true,
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "types": ["node"],
    "jsx": "react",
    "incremental": true,
  },
  "exclude": ["node_modules", "dist"],
  "include": ["**/*.ts", "**/*.tsx", "**/*.js", "*.ts", "playwright.config.ts"]
}

'''
'''--- packages/near-fast-auth-signer-e2e-tests/webpack.config.js ---
const path = require('path');

const HtmlWebpackPlugin = require('html-webpack-plugin');
const webpack = require('webpack');

module.exports = {
  entry:  './test-app/index.tsx',
  output: {
    filename:   'main.js',
    path:       path.resolve(__dirname, 'dist'),
    publicPath: '/',
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: path.join(__dirname, 'public', 'index.html'),
    }),
    new webpack.ProvidePlugin({
      process: 'process/browser',
      Buffer:  ['buffer', 'Buffer']
    }),
  ],
  devServer: {
    static: {
      directory: path.join(__dirname, 'dist'),
    },
    port: 3030,
  },
  devtool: 'eval-source-map',
  module:  {
    // exclude node_modules
    rules: [
      {
        test:    /\.(js|ts|tsx)$/,
        exclude: /node_modules/,
        use:     ['ts-loader'],
      },
      {
        test: /\.css$/i,
        use:  ['style-loader', 'css-loader'],
      },
      {
        test: /\.(woff(2)?|ttf|eot|svg)(\?v=\d+\.\d+\.\d+)?$/,
        type: 'asset/resource',
      },
    ],
  },
  // pass all js files through Babel
  resolve: {
    extensions: ['.ts', '.tsx', '.js', '.css'],
    fallback:   {
      https:             require.resolve('https-browserify'),
      http:              require.resolve('stream-http'),
      // crypto:   require.resolve('crypto-browserify'),
      crypto:            false,
      stream:            require.resolve('stream-browserify'),
      process:           require.resolve('process/browser'),
      'process/browser': require.resolve('process/browser'),
      url:               require.resolve('url/')
    }
  }
};

'''
'''--- packages/near-fast-auth-signer/.eslintrc.js ---
module.exports = {
  env:      { browser: true, node: true, es2020: true },
  parser:   '@typescript-eslint/parser',
  settings: {
    'import/parsers': {
      '@typescript-eslint/parser': ['.ts', '.tsx']
    },
    'import/extensions': [
      '.ts',
      '.tsx'
    ]
  },
  overrides: [{
    files: ['*.ts', '*.tsx'],
  }],
  ignorePatterns: ['dist'],
  extends:        ['airbnb', 'plugin:import/errors', 'plugin:import/typescript'],
  rules:          {
    'no-unused-vars':                    ['error', { argsIgnorePattern: '^_' }],
    'linebreak-style':                   0,
    'react/require-default-props':       'off',
    'react/prop-types':                  'off',
    'react/jsx-filename-extension':      'off',
    'react/jsx-props-no-spreading':      'off',
    'import/no-extraneous-dependencies': 'off',
    'import/prefer-default-export':      'off',
    'prefer-destructuring':                [
      'error', {
        VariableDeclarator:   {
          array:  false,
          object: true
        },
        AssignmentExpression: {
          array:  false,
          object: false
        }
      }, {
        enforceForRenamedProperties: false
      }
    ],
    'max-classes-per-file':                'off',
    indent:                                [
      'error', 2, {
        SwitchCase:         1,
        VariableDeclarator: { var: 2, let: 2, const: 3 },
        ObjectExpression:   'first'
      }
    ],
    semi:                                  ['error', 'always'],
    'comma-dangle':                        ['error', 'only-multiline'],
    'max-len':                             [
      'error', 120, {
        ignoreComments: true, ignoreStrings: true, ignoreTemplateLiterals: true
      }
    ],
    'no-multi-spaces':                     [
      'error', {
        exceptions: {
          ExportNamedDeclaration: true,
          VariableDeclarator:     true,
          AssignmentExpression:   true,
          AssignmentPattern:      true
        }
      }
    ],
    'global-require':                      'warn',
    'one-var':                             ['error', 'never'],
    strict:                                'off',
    camelcase:                             'off',
    'no-console':                          'off',
    'func-names':                          'off',
    'no-param-reassign':                   'off',
    'arrow-body-style':                    ['error', 'as-needed', { requireReturnForObjectLiteral: true }],
    'no-underscore-dangle':                'off',
    'import/extensions':    ['error',
      { json: 'always' }
    ],
    'import/order':                        [
      'error', {
        alphabetize:        {
          order:           'asc',
          caseInsensitive: true
        },
        'newlines-between': 'always',
        groups:             [
          'builtin',
          ['external', 'internal'],
          ['sibling', 'parent', 'index'],
          'object'
        ]
      }
    ],
    'arrow-parens':                        ['error', 'always'],
    'key-spacing':                         ['warn', { align: 'value', mode: 'minimum' }],
    'one-var-declaration-per-line':        ['error', 'initializations']
  },
};

'''
'''--- packages/near-fast-auth-signer/README.md ---
# Fast-Auth-Signer

This application facilitates generation of ED25519 keys using WebAuthN APIs (typically using biometrics), signing of transactions using those keys, and an implementation of 'sign in' functionality using the same paradigm as wallet apps in the ecosystem support.
It is designed to be integrated into [near-discovery](https://github.com/near/near-discovery) by way of inter-iframe RPC calls leveraging [iframe-rpc](https://github.com/near/near-api-js/tree/master/packages/iframe-rpc).

## How to run

This repository uses Yarn for package management. You'll need to install the dependencies first before you start the dev server.

```bash
yarn install
yarn start
```

## UI Routes
#### `/create-account`
- Displays a UI to create a new account
- Account creation is handled via the recovery service, using an e-mail link to get a valid OAuth assertion for that service
- FAK is generated via WebAuthN prompt (typically biometrics)
#### `/add-device`
- Displays a UI to authorize the current machine to control a recovery-service enabled account (adds a new biometric-based FAK to the account)
- FAK is generated via WebAuthN prompt (typically biometrics)
#### `/sign`
- Displays a UI to display transaction details, allowing the user to review the transaction and approve signing it.
#### `/login`
- Displays a UI to display a detailed overview of access key permissions that are being requested to be added to the user's account.

## RPC API
#### `createAccount(limitedAccessPublicKeys[]) -> { accountId: string, fullAccessPublicKey:string }`
- Returns the account ID of the account that the user created, along with the publicKey of the FAK that was used to secure the account (generated via WebAuthN prompt)
#### `getPublicKey() -> <PublicKey in Hex format`
- Returns the user's public key in hex format, which is derived from a WebAuthN (typically biometric) interaction
- Throws error if user has not yet authenticated
#### `getAccount() -> accountId: string`
- Returns the account ID of the account that the user is currently authenticated to use.  
- Throws error if user has not yet authenticated
#### `signTransactions(transactions[]) -> signedTransactions[]`
- Navigates to the appropate UI route (/sign)
- Returns signed transactions that can be submitted by the requester if approved
- Throws error if failed or cancelled by user
#### `signDelegateAction(actions) -> signedDelegateAction`
- Navigates to the appropate UI route (/sign)
- Returns a signed DelegateAction composed of the requested actions so that the requester can submit them for execution by a relayer if approved
- Throws error if failed or cancelled by user
#### `login(accessKey) -> boolean`
- Navigates to the appropate UI route (/login)
- Returns true if login was successful
- Throws error if failed or cancelled by user

'''
'''--- packages/near-fast-auth-signer/package.json ---
{
  "name": "near-fast-auth-signer",
  "version": "1.0.1",
  "description": "Signer for fast auth functionality in near-discovery gateways",
  "main": "src/index.html",
  "scripts": {
    "start": "webpack serve --mode development --history-api-fallback",
    "bundle": "webpack build --mode production --output-public-path /fastauth/",
    "lint": "eslint ./",
    "fix": "eslint ./ --fix",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/near/fast-auth-signer.git"
  },
  "keywords": [
    "React",
    "Parcel",
    "Starter"
  ],
  "author": "Pagoda, Inc.",
  "contributors": [
    "Andy Haynes",
    "Daryl Collins (daryl@darylcollins.com)",
    "Philip Obosi (philip.c.obosi@gmail.com)"
  ],
  "license": "MIT",
  "browserslist": [
    "last 1 Chrome version"
  ],
  "dependencies": {
    "@ethereumjs/common": "^4.2.0",
    "@ethereumjs/tx": "^5.2.1",
    "@hookform/resolvers": "^3.3.2",
    "@near-js/accounts": "^0.1.4",
    "@near-js/biometric-ed25519": "^1.2.2",
    "@near-js/crypto": "^0.0.5",
    "@near-js/iframe-rpc": "^0.0.2",
    "@near-js/keystores": "^0.0.5",
    "@near-js/transactions": "^0.2.1",
    "@near-js/utils": "^0.1.0",
    "@radix-ui/react-toast": "^1.1.4",
    "@sentry/react": "^7.75.1",
    "bn.js": "^5.2.1",
    "bootstrap": "^5.3.0",
    "borsh": "^0.7.0",
    "bs58check": "^3.0.1",
    "canonicalize": "^2.0.0",
    "coinselect": "^3.1.13",
    "crypto-browserify": "^3.12.0",
    "data-loader": "^3.8.4",
    "debug": "^4.3.4",
    "ethers": "^6.11.1",
    "firebase": "^10.1.0",
    "https-browserify": "^1.0.0",
    "i18next": "^23.2.8",
    "js-sha256": "^0.10.1",
    "keccak": "^3.0.4",
    "lodash.debounce": "^4.0.8",
    "lodash.pickby": "^4.6.0",
    "multichain-tools": "^1.0.8",
    "nanoid": "^5.0.6",
    "near-api-js": "^2.1.4",
    "process": "^0.11.10",
    "query-string": "^7.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-hook-form": "^7.45.4",
    "react-i18next": "^13.0.2",
    "react-router": "^6.14.1",
    "react-router-dom": "^6.14.2",
    "rudder-sdk-js": "^2.48.3",
    "stream-browserify": "^3.0.0",
    "stream-http": "^3.2.0",
    "style-loader": "^3.3.3",
    "styled-components": "^6.0.5",
    "ua-parser-js": "^1.0.35",
    "url": "^0.11.0",
    "validator": "^13.11.0",
    "yup": "^1.3.3",
    "zustand": "^4.3.9"
  },
  "devDependencies": {
    "@babel/core": "^7.21.8",
    "@babel/eslint-parser": "^7.21.8",
    "@babel/preset-env": "^7.21.5",
    "@babel/preset-react": "^7.10.1",
    "@sentry/webpack-plugin": "^2.14.0",
    "@svgr/webpack": "^8.1.0",
    "@types/bn.js": "^5.1.1",
    "@types/bs58": "^4.0.4",
    "@types/debug": "^4.1.7",
    "@types/elliptic": "^6.4.18",
    "@types/keccak": "^3.0.4",
    "@types/lodash.debounce": "^4.0.9",
    "@types/react": "^18.2.6",
    "@types/react-dom": "^18.2.4",
    "@typescript-eslint/eslint-plugin": "^5.59.6",
    "@typescript-eslint/parser": "^5.59.6",
    "babel-loader": "^9.1.2",
    "css-loader": "^6.7.3",
    "eslint": "^8.40.0",
    "eslint-config-airbnb": "^19.0.4",
    "eslint-import-resolver-typescript": "^3.5.5",
    "eslint-plugin-import": "^2.27.5",
    "eslint-plugin-jsx-a11y": "^6.7.1",
    "eslint-plugin-react": "^7.32.2",
    "eslint-plugin-react-hooks": "^4.6.0",
    "file-loader": "^6.2.0",
    "html-webpack-plugin": "^5.5.1",
    "ts-loader": "^9.5.1",
    "typescript": "^5.0.4",
    "webpack": "^5.82.1",
    "webpack-cli": "^5.1.1",
    "webpack-dev-server": "^4.15.0"
  }
}

'''
'''--- packages/near-fast-auth-signer/public/index.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Fast Auth</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/config.js"></script>
</head>
<body>
<div id="root"></div>
</body>
</html>

'''
'''--- packages/near-fast-auth-signer/src/api/index.ts ---
import { captureException } from '@sentry/react';
import { KeyPair } from 'near-api-js';

import { withTimeout } from '../utils';
import { network } from '../utils/config';
import {
  CLAIM, getUserCredentialsFrpSignature
} from '../utils/mpc-service';

/**
 * Fetches the account IDs associated with a given public key.
 *
 * @param publicKey - The public key to fetch the account IDs for.
 * @returns A promise that resolves to an array of account IDs.
 * @throws Will throw an error if the fetch request fails.
 */
const KIT_WALLET_WAIT_DURATION = 10000; // 10s
export const fetchAccountIds = async (publicKey: string): Promise<string[]> => {
  if (publicKey) {
    if (window.firestoreController) {
      const accountId = await window.firestoreController.getAccountIdByPublicKey(publicKey);
      if (accountId) {
        return [accountId];
      }
    }

    try {
      const res = await withTimeout(fetch(`${network.fastAuth.authHelperUrl}/publicKey/${publicKey}/accounts`), KIT_WALLET_WAIT_DURATION);
      if (res) {
        const ids = await res.json();
        return ids;
      }
      return [];
    } catch (error) {
      console.log('fetchAccountIds', error);
      captureException(error);
      return [];
    }
  }

  return [];
};

/**
 * This function fetches account id from given two public keys.
 * Webuathn currently prompts two public keys by default and we need to discover which key is currently on chain.
 * Since we store public key <-> account id in firestore, one of the public key will return the result fast and we do not need to wait for both request to resolve.
 * It is possible that both public keys are not on chain, in that case we return null.
 * @param keyPairA
 * @param keyPairB
 * @returns object with account id and public key
 */
export const fetchAccountIdsFromTwoKeys = async (
  keyPairA: KeyPair,
  keyPairB: KeyPair
): Promise<{ accId: string, keyPair: KeyPair} | null> => {
  const accountIdsFromPublicKeyA = fetchAccountIds(keyPairA.getPublicKey().toString());
  const accountIdsFromPublicKeyB = fetchAccountIds(keyPairB.getPublicKey().toString());

  const firstResult = await Promise.race([accountIdsFromPublicKeyA, accountIdsFromPublicKeyB]);
  const firstKey = firstResult === await accountIdsFromPublicKeyA ? keyPairA : keyPairB;
  if (firstResult.length > 0) {
    return {
      accId:     firstResult[0],
      keyPair: firstKey
    };
  }

  const secondResult = await (
    firstResult === await accountIdsFromPublicKeyA ? accountIdsFromPublicKeyB : accountIdsFromPublicKeyA
  );
  const secondKey = firstKey === keyPairA ? keyPairB : keyPairA;
  if (secondResult.length > 0) {
    return {
      accId:     secondResult[0],
      keyPair: secondKey
    };
  }

  return null;
};

type LimitedAccessKey = {
  public_key: string,
  receiver_id: string,
  allowance: string,
  method_names: string
}

type NewAccountResponse =
  | {
  type: 'ok',
  create_account_options: {
    full_access_keys: string[] | null,
    limited_access_keys: LimitedAccessKey[] | null,
    contract_bytes: string[] | null
  },
  user_recovery_public_key: string,
  near_account_id: string
}
  | {
  type: 'err',
  msg: string
};

/**
 * This function creates a new account on the NEAR blockchain by sending a request to the /new_account endpoint of the MPC recovery service.
 *
 * @param accountId - The ID of the new account to be created on the NEAR blockchain.
 * @param fullAccessKeys - An array of full access keys to be added to the account.
 * @param limitedAccessKeys - An array of objects, each representing a limited access key to be associated with the account. Each object has the following properties:
 * - public_key: The public key of the limited access key.
 * - receiver_id: The contract_ID that the limited access key is authorized to call.
 * - allowance: The maximum amount of NEAR tokens that the limited access key is allowed to spend on gas fees.
 * - method_names: A string of comma-separated method names that the limited access key is allowed to call.
 * @param accessToken - The OIDC access token.
 * @param oidcKeypair - The public and private key pair of the FRP.
 * @returns A promise that resolves to an object of type NewAccountResponse. This object contains the result of the account creation process. It can either be of type 'ok' with the account details or of type 'err' with an error message.
 * @throws An error if the fetch request fails.
 */
export const createNEARAccount = async ({
  accountId,
  fullAccessKeys = [],
  limitedAccessKeys = [],
  accessToken,
  oidcKeypair,
}: {
  accountId: string,
  fullAccessKeys?: string[],
  limitedAccessKeys?: LimitedAccessKey[],
  accessToken: string,
  oidcKeypair: KeyPair
}): Promise<NewAccountResponse> => {
  const CLAIM_SALT = CLAIM + 2;
  const signature = getUserCredentialsFrpSignature({
    salt:            CLAIM_SALT,
    oidcToken:       accessToken,
    shouldHashToken: false,
    keypair:         oidcKeypair,
  });

  const data = {
    near_account_id:        accountId,
    create_account_options: {
      full_access_keys:    fullAccessKeys,
      limited_access_keys: limitedAccessKeys,
    },
    oidc_token:                     accessToken,
    user_credentials_frp_signature: signature,
    frp_public_key:                 oidcKeypair.getPublicKey().toString(),
  };

  const options = {
    method:  'POST',
    mode:    'cors' as const,
    body:    JSON.stringify(data),
    headers: new Headers({ 'Content-Type': 'application/json' }),
  };

  const response = await fetch(`${network.fastAuth.mpcRecoveryUrl}/new_account`, options);
  if (!response?.ok) {
    throw new Error('Network response was not ok');
  }

  return response.json();
};

'''
'''--- packages/near-fast-auth-signer/src/components/Layout/index.ts ---
export { default as StyledContainer } from './StyledContainer';
export { default as FormContainer } from './FormContainer';

'''
'''--- packages/near-fast-auth-signer/src/components/Login/Login.style.ts ---
import styled from 'styled-components';

export const SeparatorWrapper = styled.div`
  display: flex;
  width: 100%;
  justify-content: space-between;
  align-items: center;
  color: #868682;
  font-size: 12px;
`;

export const Separator = styled.div`
  width: 140px;
  height: 1px;
  background-color: #EEEEEC;
`;

'''
'''--- packages/near-fast-auth-signer/src/components/Sign/Sign.styles.ts ---
import styled from 'styled-components';

interface ModalSignWrapperProps {
  hide?: boolean | undefined;
  warning?: boolean | undefined;
}

export const ModalSignWrapper = styled.div<ModalSignWrapperProps>`
  ${(props) => props.hide && 'opacity: 0;'}
  width: 550px;
  margin: 0 auto;
  border-radius: 8px;
  padding: 24px;
  display: flex;
  flex-direction: column;
  position: relative;
  row-gap: 8px;
    .info-text {
    font-size: 12px;
    font-weight: 500;
    color: #1b1b1b;
    text-align: center;
      &.error {
        color: #A81500;
      }
    }

  .modal-top {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    line-height: 17px;
    text-align: center;
    svg {
      height: 48px;
      width:48px;
    }
    .transaction-details {
      display: inline-flex;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 50px;
      border: 1px solid #e3e3e0;
      align-items: center;
      font-family: Mona Sans;
      font-size: 12px;
      font-weight: 450;
      line-height: 17px;
      letter-spacing: 0.02em;
      text-align: left;
      color: #1b1b1b;
      margin-bottom: 24px;
      ${({ warning }) => warning && `
        border: 1px solid var(--Red-Light-6, #FF988A);
        background: var(--Red-Light-1, #FFF6F5);
        color: var(--Red-Light-12, var(--Red-Light-12, #4B0B02));
      `}
      svg {
        height: 13.5px;
        width: 13.5px;
        vertical-align: middle;
        color: #868682;
      }
    }
  }

  .table-wrapper {
    background-color: #fdfdfc;
    border: 1px solid #eeeeec;
    border-radius: 4px;

    &.margin-top {
      margin-top: 20px;
    }

    h4 {
      font-size: 12px;
      font-weight: 600;
      line-height: 17px;
      letter-spacing: 0.02em;
      text-align: left;
      color: #1b1b1b;
      padding: 12px;
    }
  }

  .more-details {
    font-size: 14px;
    color: #1b1b1b;
    font-weight: 600;
    line-height: 21px;
    letter-spacing: 0.02em;
    text-align: left;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 8px 16px 0px;
    svg path {
      fill: #1b1b1b;;
    }
    &:hover {
      cursor: pointer;
    }
  }

  .more-details-opened {
    .table-wrapper {
      &:first-child {
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
      }

      &:last-child {
        border-top-left-radius: 0px;
        border-top-right-radius: 0px;

        border-top: 0px;
      }
    }
  }

  .modal-footer {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;

    > button {
      min-width: 100%;
    }
  }
`;

'''
'''--- packages/near-fast-auth-signer/src/components/Sign/Values/fiatValueManager.ts ---
import { stringifyUrl } from 'query-string';

// @ts-ignore
import sendJson from './tmp_fetch_send_json';

const COINGECKO_PRICE_URL = 'https://api.coingecko.com/api/v3/simple/price';
const ACCOUNT_ID_SUFFIX = 'mainnet';
const REF_FINANCE_API_ENDPOINT = `https://${ACCOUNT_ID_SUFFIX}-indexer.ref-finance.com/`;

export const fetchGeckoPrices = async (tokenIds) => {
  try {
    const tokenFiatValues = await sendJson(
      'GET',
      stringifyUrl({
        url:   COINGECKO_PRICE_URL,
        query: {
          ids:                     tokenIds,
          vs_currencies:           'usd',
          include_last_updated_at: true,
        },
      })
    );
    return tokenFiatValues;
  } catch (error) {
    return console.error(`Failed to fetch coingecko prices: ${error}`);
  }
};

export const fetchRefFinancePrices = async () => {
  try {
    const refFinanceTokenFiatValues = await sendJson(
      'GET',
      `${REF_FINANCE_API_ENDPOINT}/list-token-price`
    );
    const [prices] = [refFinanceTokenFiatValues];

    const last_updated_at = Date.now() / 1000;

    const formattedValues =      refFinanceTokenFiatValues
      && Object.keys(prices).reduce((acc, curr) => {
        return {
          ...acc,
          [curr]: {
            usd: +Number(prices[curr]?.price).toFixed(2) || null,
            last_updated_at,
          },
        };
      }, {});

    return {
      near: formattedValues['wrap.near'],
    };
  } catch (error) {
    return console.warn(`Failed to fetch ref-finance prices: ${error}`);
  }
};

'''
'''--- packages/near-fast-auth-signer/src/components/Sign/Values/formatNearAmount.ts ---
import { utils } from 'near-api-js';

const NEAR_FRACTIONAL_DIGITS = 5;

export const formatNearAmount = (amount) => {
  amount = amount.toString();
  if (amount === '0') {
    return amount;
  }
  const formattedAmount = utils.format.formatNearAmount(amount, NEAR_FRACTIONAL_DIGITS);
  if (formattedAmount === '0') {
    return `< ${!NEAR_FRACTIONAL_DIGITS ? '0' : `0.${'0'.repeat((NEAR_FRACTIONAL_DIGITS || 1) - 1)}1`}`;
  }
  return formattedAmount;
};

'''
'''--- packages/near-fast-auth-signer/src/components/Sign/Values/store.ts ---
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

const store = (set) => {
  return {
    fiatValueUsd:          '',
    storeFetchedUsdValues: (fiatValueUsd) => set({ fiatValueUsd }),
  };
};

const fiatValuesStore = create(devtools(store));

export default fiatValuesStore;

'''
'''--- packages/near-fast-auth-signer/src/components/Sign/Values/tmp_fetch_send_json.ts ---
// Taken from Near Wallet
// @ts-ignore
const fetch = (typeof window === 'undefined' || window.name === 'nodejs') ? require('node-fetch') : window.fetch;

const createError = require('http-errors');

module.exports = async function sendJson(method, url, json) {
  const response = await fetch(url, {
    method,
    body:    method !== 'GET' ? JSON.stringify(json) : undefined,
    headers: {
      'Content-type': 'application/json; charset=utf-8',
    }
  });
  if (!response.ok) {
    const body = await response.text();
    let parsedBody;

    try {
      parsedBody = JSON.parse(body);
    } catch (e) {
      throw createError(response.status, body);
    }

    throw createError(response.status, parsedBody);
  }
  if (response.status === 204) {
    // No Content
    return null;
  }
  return response.json();
};

'''
'''--- packages/near-fast-auth-signer/src/components/SignMultichain/bitcoin/schema.ts ---
import * as yup from 'yup';

import { BaseSendMultichainMessageSchema } from '../schema';

export const SendBTCMultichainMessageSchema = BaseSendMultichainMessageSchema.shape({
  chain:   yup.number().required().test('is-btc', 'Invalid BTC chain value', (value) => value === 0),
  network: yup.string().oneOf(['mainnet', 'testnet']).required(),
  fee:     yup.number().optional(),
  utxos:   yup.array().optional(),
}).test('fee and utxos check', 'If fee is present, utxos must be present and vice versa', (value) => {
  const { fee, utxos } = value;
  // Check if both are present or both are undefined
  if ((fee && utxos) || (!fee && !utxos)) {
    return true; // Validation succeeds
  }
  return false; // Validation fails
});

'''
'''--- packages/near-fast-auth-signer/src/components/SignMultichain/evm/schema.ts ---
import * as yup from 'yup';

import { BaseSendMultichainMessageSchema } from '../schema';

export const SendEVMMultichainMessageSchema =  BaseSendMultichainMessageSchema.shape({
  chain: yup
    .number()
    .required()
    .test('is-evm', 'Invalid EVM chain value', (value) => value === 60),
  chainId: yup.lazy((value) => yup.mixed<bigint>().test(
    'is-valid-chainId',
    `Invalid chainId value: ${value}`,
    (val) => [BigInt(1), BigInt(56), BigInt(97), BigInt(11155111)].includes(val)
  )),
  maxFeePerGas:         yup.mixed<bigint>().optional(),
  maxPriorityFeePerGas: yup.mixed<bigint>().optional(),
  gasLimit:             yup.mixed<bigint>().optional(),
});

'''
'''--- packages/near-fast-auth-signer/src/components/SignMultichain/schema.ts ---
import * as yup from 'yup';

export const BaseSendMultichainMessageSchema = yup.object().shape({
  from:   yup.string().required('from is required'),
  domain: yup.string().optional(),
  meta:   yup.object().optional(),
  to:     yup.string().required('to is required'),
  value:  yup.mixed<bigint>().required('value is required'),
});

'''
'''--- packages/near-fast-auth-signer/src/components/SignMultichain/types.ts ---
export type EVMChain = 'ETH' | 'BNB';
export type Chain = EVMChain | 'BTC';

export type EVMChainMap<T = any> = {
  // Disabling because the key needs to be defined but not used
  // eslint-disable-next-line no-unused-vars
  [key in EVMChain]: T
};

export type ChainMap<T = any> = {
  // Disabling because the key needs to be defined but not used
  // eslint-disable-next-line no-unused-vars
  [key in Chain]: T
};

export type SLIP044ChainId = 60 | 0;

interface BaseSendMultichainMessage {
  chain: SLIP044ChainId;
  domain?: string;
  to: string;
  value: bigint;
  meta?: { [k: string]: any };
  from: string;
}

export type EvmSendMultichainMessage = BaseSendMultichainMessage & {
  chainId: bigint;
  maxFeePerGas?: bigint;
  maxPriorityFeePerGas?: bigint;
  gasLimit?: number;
};

export type BTCSendMultichainMessage = BaseSendMultichainMessage & {
  network: 'mainnet' | 'testnet';
};

export type SendMultichainMessage = BTCSendMultichainMessage | EvmSendMultichainMessage;

'''
'''--- packages/near-fast-auth-signer/src/components/SignMultichain/utils.ts ---
import canonicalize from 'canonicalize';
import { formatEther, formatUnits } from 'ethers';
import pickBy from 'lodash.pickby';
import {
  fetchDerivedBTCAddress,
  fetchDerivedEVMAddress,
  fetchBTCFeeProperties,
  fetchEVMFeeProperties,
  signAndSendEVMTransaction,
  signAndSendBTCTransaction
} from 'multichain-tools';
import * as yup from 'yup';

import { SendBTCMultichainMessageSchema } from './bitcoin/schema';
import { SendEVMMultichainMessageSchema } from './evm/schema';
import {
  BTCSendMultichainMessage,
  Chain,
  ChainMap,
  EVMChainMap,
  EvmSendMultichainMessage,
  SLIP044ChainId,
  SendMultichainMessage,
} from './types';
import { assertNever } from '../../utils';
import { networkId } from '../../utils/config';
import environment from '../../utils/environment';
import { fetchGeckoPrices } from '../Sign/Values/fiatValueManager';

// TODO: use this for blacklisting on limited access key creation AND sign
const MULTICHAIN_CONTRACT_TESTNET = 'multichain-testnet-2.testnet';
const MULTICHAIN_CONTRACT_MAINNET = 'multichain-testnet-2.testnet';

function toBTC(satoshis: number): number {
  return satoshis / 100000000;
}

type BTCFeeProperties = {
  inputs: {
      txid: string;
      vout: number;
      value: number;
      script: string;
  }[];
  outputs: {
      address: string;
      value: number;
  }[];
  fee: number;
};

type EVMFeeProperties = {
  gasLimit: bigint;
  maxFeePerGas: bigint;
  maxPriorityFeePerGas: bigint;
  maxFee: bigint;
}

export type TransactionFeeProperties = BTCFeeProperties | EVMFeeProperties;

const isEVMMultichainMessage = (
  message: SendMultichainMessage
): message is EvmSendMultichainMessage => message?.chain === 60;

const EVMChains: EVMChainMap<boolean> = {
  ETH: true,
  BNB: true,
};
export const isTokenSymbolEVMChain = (chain: Chain): boolean => !!EVMChains[chain];

const FAST_AUTH_RELAYER_URL = 'http://34.136.82.88:3030';

const CHAIN_CONFIG: ChainMap = {
  ETH: {
    providerUrl: 'https://sepolia.infura.io/v3/6df51ccaa17f4e078325b5050da5a2dd',
  },
  BNB: {
    providerUrl: 'https://data-seed-prebsc-1-s1.bnbchain.org:8545',
  },
  BTC: {
    networkType: 'testnet',
    // API ref: https://github.com/Blockstream/esplora/blob/master/API.md
    providerUrl: 'https://blockstream.info/testnet/api/',
  },
};

export const getMultiChainContract = () => (environment.NETWORK_ID === 'mainnet' ? MULTICHAIN_CONTRACT_MAINNET : MULTICHAIN_CONTRACT_TESTNET);

const SendMultichainMessageSchema = yup.lazy((value: { chain: SLIP044ChainId }) => {
  // chain is the slip044 chain id
  if (value.chain === 60) {
    return SendEVMMultichainMessageSchema;
  }
  if (value.chain === 0) {
    return SendBTCMultichainMessageSchema;
  }
  assertNever(value.chain, `Schema for chain ${value.chain} is not defined`);
  // unreachable
  return null;
});

export const validateMessage = async (message: SendMultichainMessage): Promise<boolean
| Error> => {
  try {
    await SendMultichainMessageSchema.validate(message);
    return true;
  } catch (err) {
    return err;
  }
};

type ChainDetails = { chain: SLIP044ChainId; chainId?: bigint };

export const getTokenSymbol = (chainDetails: ChainDetails) => {
  // chain is the slip044 chain id
  if (chainDetails.chain === 60) {
    return {
      1:        'ETH',
      56:       'BNB',
      97:       'BNB',
      11155111: 'ETH'
    }[Number(chainDetails.chainId)];
  }
  if (chainDetails.chain === 0) {
    return 'BTC';
  }
  try {
    assertNever(chainDetails.chain);
    // unreachable
    return null;
  } catch (e) {
    return null;
  }
};

export const multichainAssetToCoinGeckoId = (chainDetails: ChainDetails) => {
  const chainIdMap = {
    1:        'ethereum',
    56:       'binancecoin',
    97:       'binancecoin',
    11155111: 'ethereum'
  };

  const evmChainId = Number(chainDetails.chainId);

  // chain is the slip044 chain id
  if (chainDetails.chain === 60) {
    return chainIdMap[evmChainId];
  }

  if (chainDetails.chain === 0) {
    return 'bitcoin';
  }

  try {
    assertNever(chainDetails.chain);
    // unreachable
    return null;
  } catch (e) {
    return null;
  }
};

export const multichainAssetToNetworkName = (chainDetails: ChainDetails) => {
  // chain is the slip044 chain id
  if (chainDetails.chain === 60) {
    return {
      1:        'Ethereum Mainnet',
      56:       'Binance Smart Chain Mainnet',
      97:       'Binace Smart Chain Testnet',
      11155111: 'Ethereum Sepolia Network'
    }[Number(chainDetails.chainId)];
  }

  if (chainDetails.chain === 0) {
    return 'Bitcoin Network';
  }

  try {
    assertNever(chainDetails.chain);
    // unreachable
    return null;
  } catch (e) {
    return null;
  }
};

export async function getMultichainCoinGeckoPrice(chainDetails: ChainDetails) {
  return fetchGeckoPrices(multichainAssetToCoinGeckoId(chainDetails));
}

const convertTokenToReadable = (value : SendMultichainMessage['value'], chain: SLIP044ChainId) => {
  // chain is the slip044 chain id
  if (chain === 60) {
    return parseFloat(formatEther(value));
  }
  if (chain === 0) {
    return toBTC(Number(value));
  }
  try {
    assertNever(chain);
    // unreachable
    return null;
  } catch (e) {
    return Number(value);
  }
};

export const getTokenAndTotalPrice = async (message: SendMultichainMessage) => {
  const chainDetails = isEVMMultichainMessage(message) ? {
    chain:   message.chain,
    chainId: message.chainId,
  } : { chain: message.chain };
  const id = multichainAssetToCoinGeckoId(chainDetails);
  const tokenAmount = convertTokenToReadable(message.value, chainDetails.chain);

  if (id) {
    const res = await getMultichainCoinGeckoPrice(chainDetails);
    if (!res) {
      return {
        price:       0,
        tokenAmount
      };
    }
    const tokenPrice: number = res[id].usd;
    return {
      price: parseInt((tokenPrice * tokenAmount * 100).toString(), 10) / 100,
      tokenAmount,
      tokenPrice
    };
  }
  return {
    price:       0,
    tokenAmount
  };
};

export const shortenAddress = (address: string): string => {
  if (address.length < 10) {
    return address;
  }
  return `${address.substring(0, 7)}...${address.substring(address.length - 5)}`;
};

export const multichainSignAndSend = async ({
  signMultichainRequest,
  feeProperties
}: {
  signMultichainRequest: SendMultichainMessage;
  feeProperties: TransactionFeeProperties;
}) => {
  const accountId = window.fastAuthController.getAccountId();
  const keypair = await window.fastAuthController.getKey(accountId);
  const chainDetails = isEVMMultichainMessage(signMultichainRequest) ? {
    chain:   signMultichainRequest.chain,
    chainId: signMultichainRequest.chainId,
  } : { chain: signMultichainRequest.chain };
  const derivedPath = canonicalize(pickBy({
    chain:  signMultichainRequest.chain,
    domain: signMultichainRequest.domain,
    meta:   signMultichainRequest.meta,
  }, (v) => v !== undefined && v !== null));

  const chainConfig = {
    contract:    MULTICHAIN_CONTRACT_TESTNET,
    ...CHAIN_CONFIG[getTokenSymbol(chainDetails)],
  };
  // chain is the slip044 chain id
  if (chainDetails.chain === 60) {
    const derivedAddress = await fetchDerivedEVMAddress(accountId, derivedPath, networkId, getMultiChainContract());
    if (derivedAddress !== signMultichainRequest.from) {
      return {
        success:      false,
        errorMessage: 'Derived address does not match the provided from address',
      };
    }
    return signAndSendEVMTransaction({
      transaction: {
        to:                   signMultichainRequest.to,
        value:                signMultichainRequest.value.toString(),
        derivedPath,
        gasLimit:             (feeProperties as EVMFeeProperties)?.gasLimit,
        maxFeePerGas:         (feeProperties as EVMFeeProperties)?.maxFeePerGas,
        maxPriorityFeePerGas: (feeProperties as EVMFeeProperties)?.maxPriorityFeePerGas,
      },
      nearAuthentication: { networkId, keypair, accountId },
      fastAuthRelayerUrl: FAST_AUTH_RELAYER_URL,
      chainConfig
    });
  }

  if (chainDetails.chain === 0) {
    const derivedAddress = await fetchDerivedBTCAddress(
      accountId,
      derivedPath,
      (signMultichainRequest as BTCSendMultichainMessage).network,
      networkId,
      getMultiChainContract()
    );

    if (derivedAddress !== signMultichainRequest.from) {
      return {
        success:      false,
        errorMessage: 'Derived address does not match the provided from address',
      };
    }

    return signAndSendBTCTransaction({
      transaction: {
        to:                   signMultichainRequest.to,
        value:                signMultichainRequest.value.toString(),
        derivedPath,
        inputs:  (feeProperties as BTCFeeProperties)?.inputs,
        outputs: (feeProperties as BTCFeeProperties)?.outputs,
      },
      nearAuthentication: { networkId, keypair, accountId },
      fastAuthRelayerUrl: FAST_AUTH_RELAYER_URL,
      chainConfig
    });
  }
  try {
    assertNever(chainDetails.chain);
    // unreachable
    return null;
  } catch (e) {
    return {
      success:      false,
      errorMessage: 'Chain not supported',
    };
  }
};

export const multichainGetFeeProperties = async ({
  chain,
  to,
  value,
  from
}: {
  chain: SLIP044ChainId;
  to: string;
  value: string;
  from: string;
}) => {
  // chain is the slip044 chain id
  if (chain === 0) {
    const feeProperties =  (await fetchBTCFeeProperties(CHAIN_CONFIG.BTC.providerUrl, from, [{
      address: to,
      value:   Number(value)
    }]));

    return { ...feeProperties, feeDisplay: toBTC(feeProperties.fee) };
  } if (chain === 60) {
    const feeProperties = await fetchEVMFeeProperties(CHAIN_CONFIG.ETH.providerUrl, {
      to,
      value
    });
    return { ...feeProperties, feeDisplay: formatUnits(feeProperties.maxFee) };
  }
  try {
    assertNever(chain);
    // unreachable
    return null;
  } catch (e) {
    return null;
  }
};

'''
'''--- packages/near-fast-auth-signer/src/components/TableContent/TableContent.styles.ts ---
import styled from 'styled-components';

interface check {
  hasFunctionCall?: boolean;
}

const TableContentWrapper = styled.div.attrs<check>(({ hasFunctionCall }) => {
  return {
    hasFunctionCall,
  };
})`
  display: flex;
  flex-direction: row;
  padding: 16px;
  gap: 8px;
  line-height: 21px;
  font-size: 14px;
  background-color: #fdfdfc;
  justify-content: space-between;
  flex-wrap: ${({ hasFunctionCall }) => (hasFunctionCall ? 'wrap' : 'nowrap')};

  .left-side {
    font-weight: 450;
    letter-spacing: 0.02em;
    text-align: left;
    color: #1b1b1b;
    > svg {
      margin: 0px 3px 5px 3px;
    }
  }

  .right-side {
    .function-call {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 6px;
      flex-direction: row;
      color: #1b1b1b;
      column-gap: 8px;

      button {
        color: #604cc8;
        border: 1px solid #e3e3e0;
        border-radius: 50px;
        background-color: #fdfdfc;
        padding: 8px 15px;
        font-family: FK Grotesk SemiMono Trial;
        font-weight: 500;
        line-height: 17px;
        letter-spacing: 0.02em;
        text-align: left;
      }
    }
  }

  .function-desc {
    background-color: #f9f9f8;
    padding: 12px;
    overflow-wrap: anywhere;
    width: 100%;
  }

  .left-side {
    font-weight: 450;
    letter-spacing: 0.02em;
    color: #706f6c;
    gap: 4px;
    display: flex;
    flex-direction: row;
    align-content: center;
    flex-wrap: nowrap;
    align-items: center;
  }

  .right-side {
    font-weight: 600;
    color: #1b1b1b;
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    column-gap: 4px;

    small {
      font-size: 12px;
      display: block;
      font-weight: 450;
      line-height: 17px;
      letter-spacing: 0.02em;
      text-align: right;
      color: #1b1b1b;
    }
  }
`;

export default TableContentWrapper;

'''
'''--- packages/near-fast-auth-signer/src/hooks/useAuthState.ts ---
import { getKeys, isPassKeyAvailable } from '@near-js/biometric-ed25519/lib';
import { KeyPairEd25519 } from '@near-js/crypto';
import { captureException } from '@sentry/react';
import { useEffect, useState } from 'react';
import { useSearchParams } from 'react-router-dom/dist';

import { fetchAccountIdsFromTwoKeys } from '../api';
import { setAccountIdToController } from '../lib/controller';
import { networkId } from '../utils/config';
import { checkFirestoreReady, firebaseAuth } from '../utils/firebase';

type AuthState = 'loading' | boolean | Error

export const getAuthState = async (): Promise<AuthState> => {
  try {
    const controllerState = await window.fastAuthController.isSignedIn();
    const isFirestoreReady = await checkFirestoreReady();
    const isPasskeySupported = await isPassKeyAvailable();

    if (controllerState === true) {
      return true;
    } if (isPasskeySupported) {
      const keypairs = await getKeys('dontcare');
      const accountInfo = await fetchAccountIdsFromTwoKeys(
        keypairs[0],
        keypairs[1],
      );

      if (!accountInfo?.accId) {
        return false;
      }

      setAccountIdToController({
        accountId: accountInfo.accId,
        networkId,
      });

      await window.fastAuthController.setKey(new KeyPairEd25519(accountInfo.keyPair?.toString()?.split(':')[1]));
      return true;
    } if (isFirestoreReady && firebaseAuth.currentUser) {
      const oidcToken = await firebaseAuth.currentUser.getIdToken();
      const localStoreKey = await window.fastAuthController.getLocalStoreKey(`oidc_keypair_${oidcToken}`);

      if (localStoreKey) {
        const account = await window.fastAuthController.recoverAccountWithOIDCToken(oidcToken);

        if (!account) return false;

        setAccountIdToController({
          accountId: account?.accountId,
          networkId
        });

        return true;
      }
    }
  } catch (e) {
    captureException(e);
    return false;
  }

  return false;
};

export const useAuthState = (): {authenticated: AuthState} => {
  const [authenticated, setAuthenticated] = useState<AuthState>('loading');
  const [query] = useSearchParams();
  const email = query.get('email');

  useEffect(() => {
    const handleAuthState = async () => {
      setAuthenticated(await getAuthState());
    };

    handleAuthState();
  }, [email]);

  return { authenticated };
};

'''
'''--- packages/near-fast-auth-signer/src/hooks/useFirebaseUser.ts ---
import { useState, useEffect } from 'react';

import { firebaseAuth } from '../utils/firebase';

function useFirebaseUser() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = firebaseAuth.onAuthStateChanged((data) => {
      setUser(data);
      setLoading(false);
    });

    return () => {
      unsubscribe(); // Cleanup the subscription when component unmounts
    };
  }, []);

  return { user, loading };
}

export default useFirebaseUser;

'''
'''--- packages/near-fast-auth-signer/src/hooks/useIframeDialogConfig.ts ---
import { useCallback, useEffect, useState } from 'react';

import { inIframe } from '../utils';

type HookReturnType = {
  sendDialogHeight(): void;
};

type ConfigOptions = {
  source?: string;
  element: HTMLElement;
  onClose?: () => void;
};

const useIframeDialogConfig = ({ element, onClose, source }: ConfigOptions): HookReturnType => {
  const [isMounted, setIsMounted] = useState(false);

  useEffect(() => {
    // Set component as mounted to make sure element is available in DOM
    setIsMounted(true);
  }, []);

  const sendDialogHeight = useCallback(() => {
    if (!inIframe() || !isMounted) return;
    if (element) {
      const dialogHeight = element.offsetHeight;
      const data = { dialogHeight } as Record<string, unknown>;
      if (source) data.source = source;
      if (onClose) data.onClose = onClose.toString();
      window.parent.postMessage(data, '*');
    }
  }, [element, isMounted, onClose, source]);

  useEffect(() => {
    sendDialogHeight();
  }, [sendDialogHeight]);

  return { sendDialogHeight };
};

export default useIframeDialogConfig;

'''
'''--- packages/near-fast-auth-signer/src/hooks/useInvalidContractId.ts ---
import { useEffect } from 'react';
import { useSearchParams } from 'react-router-dom';

export const useInvalidContractId = (invalidContract: string, error: string) => {
  const [searchParams] = useSearchParams();
  const contractId = searchParams.get('contract_id');

  // TODO: we probably need a better security method. This contracts should e blacklisted from the BE side
  // On the current implementation the user can bypass it simply disabling this check from the dev console
  useEffect(() => {
    if (contractId && invalidContract === contractId) {
      window.parent.postMessage({
        type:    error,
        message: 'Invalid contract_id'
      }, '*');
    }
  }, [contractId, error, invalidContract]);
};

'''
'''--- packages/near-fast-auth-signer/src/hooks/usePageChangeEffect.ts ---
import { useEffect } from 'react';
import { useLocation } from 'react-router-dom';

function usePageChangeEffect(effect: () => void) {
  const location = useLocation();

  useEffect(() => {
    effect();
  }, [effect, location]);
}

export default usePageChangeEffect;

'''
'''--- packages/near-fast-auth-signer/src/index.html ---
<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/">
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Fast Auth Signer</title>
</head>
<body>
<div id="root"></div>
<script src="index.tsx"></script>
</body>
</html>

'''
'''--- packages/near-fast-auth-signer/src/lib/Spinner/index.ts ---
export * from './Spinner';

'''
'''--- packages/near-fast-auth-signer/src/lib/Toast/README.md ---
# Toast

Implemented via Radix primitives: https://www.radix-ui.com/docs/primitives/components/toast

_If the current props and Stitches style overrides aren't enough to cover your use case, feel free to implement your own component using the Radix primitives directly._

## Example

Using the `openToast` API allows you to easily open a toast from any context:

```tsx
import { openToast } from '@/components/lib/Toast';

...

<Button
  onClick={() =>
    openToast({
      type: 'ERROR',
      title: 'Toast Title',
      description: 'This is a great toast description.',
    })
  }
>
  Open a Toast
</Button>
```

You can pass other options too:

```tsx
<Button
  onClick={() =>
    openToast({
      type: 'SUCCESS', // SUCCESS | INFO | ERROR
      title: 'Toast Title',
      description: 'This is a great toast description.',
      icon: 'ph-bold ph-pizza', // https://phosphoricons.com/
      duration: 20000, // milliseconds (pass Infinity to disable auto close)
    })
  }
>
  Open a Toast
</Button>
```

## Deduplicate

If you need to ensure only a single instance of a toast is ever displayed at once, you can deduplicate by passing a unique `id` key. If a toast with the passed `id` is currently open, a new toast will not be opened:

```tsx
<Button
  onClick={() =>
    openToast({
      id: 'my-unique-toast',
      title: 'Toast Title',
      description: 'This is a great toast description.',
    })
  }
>
  Deduplicated Toast
</Button>
```

## Custom Toast

If you need something more custom, you can render a custom toast using `lib/Toast/Toaster.tsx` as an example like so:

```tsx
import * as Toast from '@/components/lib/Toast';

...

<Toast.Provider duration={5000}>
  <Toast.Root open={isOpen} onOpenChange={setIsOpen}>
    <Toast.Title>My Title</Toast.Title>
    <Toast.Description>My Description</Toast.Description>
    <Toast.CloseButton />
  </Toast.Root>

  <Toast.Viewport />
</Toast.Provider>
```

'''
'''--- packages/near-fast-auth-signer/src/lib/Toast/api.ts ---
import type { OpenToastOptions } from './store';
import { useToasterStore } from './store';

export function openToast(options: OpenToastOptions) {
  useToasterStore.getState().open(options);
}

'''
'''--- packages/near-fast-auth-signer/src/lib/Toast/index.ts ---
export * from './api';
export * from './Toast';
export * from './Toaster';

'''
'''--- packages/near-fast-auth-signer/src/lib/Toast/store.ts ---
/* eslint-disable no-unused-vars */
import { create } from 'zustand';

export type ToastType = 'INFO' | 'ERROR' | 'SUCCESS';

export interface Toast {
  description?: string;
  duration?: number;
  icon?: string;
  id: string;
  isOpen: boolean;
  title: string;
  type?: ToastType;
}

export interface OpenToastOptions {
  description?: string;
  duration?: number;
  icon?: string;
  id?: string;
  title: string;
  type?: ToastType;
}

interface ToasterStore {
  toasts: Toast[];
  close: (toast: Toast) => void;
  destroy: (toast: Toast) => void;
  open: (options: OpenToastOptions) => void;
}

export const useToasterStore = create<ToasterStore>((set) => {
  return {
    toasts: [],

    close: (toast) => {
      set((state) => {
        const toasts = state.toasts.map((t) => {
          if (t.id === toast.id) {
            return {
              ...t,
              isOpen: false,
            };
          }

          return t;
        });

        setTimeout(() => {
          state.destroy(toast);
        }, 5000);

        return {
          toasts,
        };
      });
    },

    destroy: (toast) => {
      set((state) => {
        const toasts = state.toasts.filter((t) => t.id !== toast.id);

        return {
          toasts,
        };
      });
    },

    open: (options) => {
      const newToast = {
        ...options,
        isOpen: true,
        id:     options.id || Date.now().toString(),
        type:   options.type || 'INFO',
      };

      set((state) => {
        const toasts = state.toasts.filter((t) => t.id !== newToast.id);

        return {
          toasts: [...toasts, newToast],
        };
      });
    },
  };
});

'''
'''--- packages/near-fast-auth-signer/src/lib/Toast/styles.ts ---
import * as ToastPrimitive from '@radix-ui/react-toast';
import styled, { keyframes } from 'styled-components';

const hideAnimation = keyframes`
  from { opacity: 1; }
  to { opacity: 0; }
`;

const slideInAnimation = keyframes`
  from { transform: translateX(calc(100% + 1rem)) }
  to { transform: translateX(0) }
`;

const swipeOutAnimation = keyframes`
  from { transform: translateX(var(--radix-toast-swipe-end-x)) }
  to { transform: translateX(calc(100% + 1rem)) }
`;

export const Viewport = styled(ToastPrimitive.Viewport)`
  position: fixed;
  bottom: 0;
  right: 0;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  padding: 1rem;
  width: 100%;
  max-height: 100vh;
  max-width: 20rem;
  z-index: 2147483632;
`;

export const Root = styled(ToastPrimitive.Root)`
  display: flex;
  gap: 1rem;
  align-items: center;
  background: #000;
  color: #fff;
  border-radius: 1rem;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
  padding: 1rem;

  i {
    font-size: 1.4rem;
  }

  &[data-state='open'] {
    animation: ${slideInAnimation} 200ms cubic-bezier(0.16, 1, 0.3, 1);
  }
  &[data-state='closed'] {
    animation: ${hideAnimation} 200ms ease-in forwards;
  }
  &[data-swipe='move'] {
    transform: translateX(var(--radix-toast-swipe-move-x));
  }
  &[data-swipe='cancel'] {
    transform: translateX(0);
    transition: transform 200ms ease-out;
  }
  &[data-swipe='end'] {
    animation: ${swipeOutAnimation} 100ms ease-out forwards;
  }

  &[data-type='ERROR'] {
    background: var(--red11);
  }
  &[data-type='SUCCESS'] {
    background: var(--green11);
  }
  &[data-type='INFO'] {
    background: var(--sand12);
  }
`;

export const Content = styled.div`
  display: flex;
  flex-direction: column;
  width: 100%;
  gap: 0rem;
`;

export const Title = styled(ToastPrimitive.Title)`
  font: 450 16px/1.5 'Mona Sans', sans-serif;
  color: currentColor;
`;

export const Description = styled(ToastPrimitive.Description)`
  font: 450 14px/1.5 'Mona Sans', sans-serif;
  color: currentColor;
  opacity: 0.8;
`;

export const CloseButton = styled(ToastPrimitive.Close)`
  display: flex;
  align-items: center;
  justify-content: center;
  width: 1.5rem;
  height: 1.5rem;
  flex-shrink: 0;
  border-radius: 100%;
  cursor: pointer;
  color: #fff;
  border: 2px solid rgba(255, 255, 255, 0.25);
  background: none;
  transition: all 200ms;

  &:hover {
    border-color: rgba(255, 255, 255, 0.5);
  }

  &:focus {
    border-color: rgba(255, 255, 255, 1);
  }

  i {
    font-size: 0.8rem;
  }
`;

'''
'''--- packages/near-fast-auth-signer/src/lib/Tooltip/index.ts ---
export * from './Tooltip';

'''
'''--- packages/near-fast-auth-signer/src/lib/controller.ts ---
import { Account, Connection } from '@near-js/accounts';
import { createKey, getKeys } from '@near-js/biometric-ed25519';
import {
  KeyPair, KeyPairEd25519, KeyType, PublicKey
} from '@near-js/crypto';
import { InMemoryKeyStore } from '@near-js/keystores';
import {
  SCHEMA, actionCreators, encodeSignedDelegate, buildDelegateAction, Signature, SignedDelegate
} from '@near-js/transactions';
import { captureException } from '@sentry/react';
import BN from 'bn.js';
import { baseEncode, serialize } from 'borsh';
import { sha256 } from 'js-sha256';
import { keyStores } from 'near-api-js';

import networkParams from './networkParams';
import { fetchAccountIds } from '../api';
import { deleteOidcKeyPairOnLocalStorage } from '../utils';
import { network } from '../utils/config';
import { firebaseAuth } from '../utils/firebase';
import {
  CLAIM, getSignRequestFrpSignature, getUserCredentialsFrpSignature, verifyMpcSignature,
} from '../utils/mpc-service';

const { addKey, functionCallAccessKey } = actionCreators;
class FastAuthController {
  private accountId: string;

  private networkId: string;

  private keyStore: InMemoryKeyStore;

  private localStore: keyStores.BrowserLocalStorageKeyStore;

  private connection: Connection;

  constructor({ accountId, networkId }) {
    const config = networkParams[networkId];
    if (!config) {
      throw new Error(`Invalid networkId ${networkId}`);
    }

    this.keyStore = new InMemoryKeyStore();
    this.localStore = new keyStores.BrowserLocalStorageKeyStore();

    this.connection = Connection.fromConfig({
      networkId,
      provider: { type: 'JsonRpcProvider', args: { url: config.nodeUrl, headers: config.headers } },
      signer:   { type: 'InMemorySigner', keyStore: this.keyStore },
    });

    this.networkId = networkId;
    this.accountId = accountId;
  }

  setAccountId = (accountId) => {
    this.accountId = accountId;
  };

  async createBiometricKey() {
    const keyPair = await createKey(this.accountId);
    await this.setKey(keyPair);

    return keyPair;
  }

  async getCorrectAccessKey(firstKeyPair, secondKeyPair) {
    const firstPublicKeyB58 = `ed25519:${baseEncode((firstKeyPair.getPublicKey().data))}`;
    const secondPublicKeyB58 = `ed25519:${baseEncode((secondKeyPair.getPublicKey().data))}`;

    if (this.accountId) {
      const account = new Account(this.connection, this.accountId);
      const accessKeys = await account.getAccessKeys();
      const accessKey = accessKeys.find((key) => key.public_key === firstPublicKeyB58 || secondPublicKeyB58);
      if (!accessKey) {
        throw new Error('No access key found');
      } else if (accessKey.public_key === firstPublicKeyB58) {
        return firstKeyPair;
      } else {
        return secondKeyPair;
      }
    }

    // If no account id, then we guess by checking if which key exists
    const accountIdsFromFirstKey = await fetchAccountIds(firstPublicKeyB58);
    if (accountIdsFromFirstKey.length) {
      this.setAccountId(accountIdsFromFirstKey[0]);
      return firstKeyPair;
    }
    const accountIdsFromSecondKey = await fetchAccountIds(secondPublicKeyB58);
    if (accountIdsFromSecondKey.length) {
      this.setAccountId(accountIdsFromSecondKey[0]);
      return secondKeyPair;
    }
    throw new Error('both key paris are invalid');
  }

  private async getBiometricKey() {
    const [firstKeyPair, secondKeyPair] = await getKeys(this.accountId);
    const privKeyStr = await this.getCorrectAccessKey(firstKeyPair, secondKeyPair);
    return new KeyPairEd25519(privKeyStr.split(':')[1]);
  }

  async getKey(key?: string) {
    const keypair = await this.keyStore.getKey(this.networkId, key || this.accountId);
    return keypair;
  }

  async setKey(keyPair) {
    return this.keyStore.setKey(this.networkId, this.accountId, keyPair);
  }

  async clearKey() {
    return this.keyStore.clear();
  }

  async clearUser() {
    await this.keyStore.clear();
  }

  async isSignedIn() {
    return !!(await this.getKey());
  }

  async getLocalStoreKey(accountId) {
    return this.localStore.getKey(this.networkId, accountId);
  }

  async findInKeyStores(key) {
    const keypair = await this.getKey(key) || await this.getLocalStoreKey(key);
    return keypair;
  }

  assertValidSigner(signerId) {
    if (signerId && signerId !== this.accountId) {
      throw new Error(`Cannot sign transactions for ${signerId} while signed in as ${this.accountId}`);
    }
  }

  async getPublicKey() {
    let keyPair = await this.getKey();

    if (!keyPair) {
      const biometricKeyPair = await this.getBiometricKey();
      await this.setKey(biometricKeyPair);

      keyPair = biometricKeyPair;
    }

    return keyPair.getPublicKey().toString();
  }

  async fetchNonce({ accountId, publicKey }) {
    const rawAccessKey = await this.connection.provider.query({
      request_type: 'view_access_key',
      account_id:   accountId,
      public_key:   publicKey,
      finality:     'optimistic',
    });
    // @ts-ignore
    const nonce = rawAccessKey?.nonce;
    return new BN(nonce).add(new BN(1));
  }

  getAccountId() {
    return this.accountId;
  }

  async getAccounts() {
    if (this.accountId) {
      return [this.accountId];
    }

    return [];
  }

  async signDelegateAction({ receiverId, actions, signerId }) {
    this.assertValidSigner(signerId);
    let signedDelegate;
    try {
      // webAuthN supported browser
      const account = new Account(this.connection, this.accountId);
      signedDelegate = await account.signedDelegate({
        actions,
        blockHeightTtl: 60,
        receiverId,
      });
    } catch {
      // fallback, non webAuthN supported browser
      // @ts-ignore
      const oidcToken = await firebaseAuth.currentUser.getIdToken();
      const recoveryPK = await this.getUserCredential(oidcToken);
      // make sure to handle failure, (eg token expired) if fail, redirect to failure_url
      signedDelegate = await this.createSignedDelegateWithRecoveryKey({
        oidcToken,
        accountId: this.accountId,
        actions,
        recoveryPK,
      }).catch((err) => {
        console.log(err);
        captureException(err);
        throw new Error('Unable to sign delegate action');
      });
    }
    return signedDelegate;
  }

  async signAndSendDelegateAction({ receiverId, actions }) {
    const signedDelegate = await this.signDelegateAction({ receiverId, actions, signerId: this.accountId });
    return fetch(network.relayerUrl, {
      method:  'POST',
      mode:    'cors',
      body:    JSON.stringify(Array.from(encodeSignedDelegate(signedDelegate))),
      headers: new Headers({ 'Content-Type': 'application/json' }),
    }).catch((err) => {
      console.log('Unable to sign and send delegate action', err);
      captureException(`Unable to sign and send delegate action, ${err.toString()}`);
    });
  }

  async signAndSendAddKey({
    contractId, methodNames, allowance, publicKey,
  }) {
    return this.signAndSendDelegateAction({
      receiverId: this.accountId,
      actions:    [
        addKey(PublicKey.from(publicKey), functionCallAccessKey(contractId, methodNames || [], allowance))
      ]
    });
  }

  async signTransaction(params) {
    return this.signDelegateAction(params);
  }

  async getAllAccessKeysExceptRecoveryKey(odicToken: string): Promise<string[]> {
    const account = new Account(this.connection, this.accountId);
    const accessKeys = await account.getAccessKeys();
    const recoveryKey = await this.getUserCredential(odicToken);
    return accessKeys
      .filter((key) => key.public_key !== recoveryKey)
      .map(({ public_key }) => public_key);
  }

  // This call need to be called after new oidc token is generated
  async claimOidcToken(oidcToken: string): Promise<{ mpc_signature: string }> {
    let keypair = await this.getKey(`oidc_keypair_${oidcToken}`);

    if (!keypair) {
      keypair = KeyPair.fromRandom('ED25519');
      await this.keyStore.setKey(this.networkId, `oidc_keypair_${oidcToken}`, keypair);
      // Delete old oidc keypair
      deleteOidcKeyPairOnLocalStorage();
      await this.localStore.setKey(this.networkId, `oidc_keypair_${oidcToken}`, keypair);
    }

    const signature = getUserCredentialsFrpSignature({
      salt:            CLAIM + 0,
      oidcToken,
      shouldHashToken: true,
      keypair,
    });

    const data = {
      oidc_token_hash: sha256(oidcToken),
      frp_signature:   signature,
      frp_public_key:  keypair.getPublicKey().toString(),
    };

    // https://github.com/near/mpc-recovery#claim-oidc-id-token-ownership
    try {
      const response = await fetch(`${network.fastAuth.mpcRecoveryUrl}/claim_oidc`, {
        method:  'POST',
        mode:    'cors' as const,
        body:    JSON.stringify(data),
        headers: new Headers({ 'Content-Type': 'application/json' }),
      });

      if (!response.ok) {
        throw new Error('Unable to claim OIDC token');
      }

      const res: {
        type: string,
        mpc_signature: string;
      } = await response.json();

      if (!verifyMpcSignature(res.mpc_signature, signature)) {
        throw new Error('MPC Signature is not valid');
      }

      return res;
    } catch (err) {
      console.log(err);
      captureException(err);
      throw new Error('Unable to claim OIDC token');
    }
  }

  async getUserCredential(oidcToken) {
    // @ts-ignore
    const GET_USER_SALT = CLAIM + 2;
    const keypair = await this.getKey(`oidc_keypair_${oidcToken}`) || await this.getLocalStoreKey(`oidc_keypair_${oidcToken}`);

    if (!keypair) {
      throw new Error('Unable to get oidc keypair');
    }

    const signature = getUserCredentialsFrpSignature({
      salt:            GET_USER_SALT,
      oidcToken,
      shouldHashToken: false,
      keypair,
    });

    const data = {
      oidc_token:     oidcToken,
      frp_signature:  signature,
      frp_public_key: keypair.getPublicKey().toString(),
    };

    // https://github.com/near/mpc-recovery#user-credentials
    return fetch(`${network.fastAuth.mpcRecoveryUrl}/user_credentials`, {
      method:  'POST',
      mode:    'cors' as const,
      body:    JSON.stringify(data),
      headers: new Headers({ 'Content-Type': 'application/json' }),
    }).then(async (response) => {
      if (!response.ok) {
        throw new Error('Unable to get user credential');
      }
      const res = await response.json();
      return res.recovery_pk;
    }).catch((err) => {
      console.log(err);
      throw new Error('Unable to get user credential');
    });
  }

  async getBlock() {
    return this.connection.provider.block({ finality: 'final' });
  }

  async createSignedDelegateWithRecoveryKey({
    oidcToken,
    accountId,
    recoveryPK,
    actions,
  }) {
    const GET_SIGNATURE_SALT = CLAIM + 3;
    const GET_USER_SALT = CLAIM + 2;
    const localKey = await this.getKey(`oidc_keypair_${oidcToken}`) || await this.getLocalStoreKey(`oidc_keypair_${oidcToken}`);

    const { header } = await this.getBlock();
    const delegateAction = buildDelegateAction({
      actions,
      maxBlockHeight: new BN(header.height).add(new BN(60)),
      nonce:          await this.fetchNonce({ accountId, publicKey: recoveryPK }),
      publicKey:      PublicKey.from(recoveryPK),
      receiverId:     accountId,
      senderId:       accountId,
    });
    const encodedDelegateAction = Buffer.from(serialize(SCHEMA, delegateAction)).toString('base64');
    const userCredentialsFrpSignature = getUserCredentialsFrpSignature({
      salt:            GET_USER_SALT,
      oidcToken,
      shouldHashToken: false,
      keypair:         localKey,
    });
    const signRequestFrpSignature = getSignRequestFrpSignature({
      salt:    GET_SIGNATURE_SALT,
      oidcToken,
      keypair: localKey,
      delegateAction,
    });

    const payload = {
      delegate_action:                encodedDelegateAction,
      oidc_token:                     oidcToken,
      frp_signature:                  signRequestFrpSignature,
      user_credentials_frp_signature: userCredentialsFrpSignature,
      frp_public_key:                 localKey.getPublicKey().toString(),
    };

    // https://github.com/near/mpc-recovery#sign
    return fetch(`${network.fastAuth.mpcRecoveryUrl}/sign`, {
      method:  'POST',
      mode:    'cors' as const,
      body:    JSON.stringify(payload),
      headers: new Headers({ 'Content-Type': 'application/json' }),
    }).then(async (response) => {
      if (!response.ok) {
        throw new Error('Unable to get signature');
      }
      const res = await response.json();
      return res.signature;
    }).then((signature) => {
      const signatureObj = new Signature({
        keyType: KeyType.ED25519,
        data:    Buffer.from(signature, 'hex'),
      });
      return new SignedDelegate({
        delegateAction,
        signature: signatureObj,
      });
    });
  }

  async signAndSendActionsWithRecoveryKey({
    oidcToken,
    accountId,
    recoveryPK,
    actions,
  }) {
    const signedDelegate = await this.createSignedDelegateWithRecoveryKey({
      oidcToken,
      accountId,
      recoveryPK,
      actions,
    }).catch((err) => {
      console.log(err);
      captureException(err);
      throw new Error('Unable to sign delegate action');
    });
    const encodedSignedDelegate = encodeSignedDelegate(signedDelegate);
    return fetch(network.relayerUrl, {
      method:  'POST',
      mode:    'cors',
      body:    JSON.stringify(Array.from(encodedSignedDelegate)),
      headers: new Headers({ 'Content-Type': 'application/json' }),
    }).catch((err) => {
      console.log('Unable to sign and send action with recovery key', err);
      captureException(`Unable to sign and send action with recovery key, ${err.toString()}`);
    });
  }

  /**
   * Recovers the account ID and the recovery public key using an OIDC token.
   *
   * @param oidcToken - The OIDC token used for account recovery.
   * @returns A promise that resolves to an object containing the account ID and recovery public key, or undefined if no account IDs are found.
   */
  async recoverAccountWithOIDCToken(oidcToken: string): Promise<undefined | {
    accountId: string;
    recoveryPK: string;
  }> {
    try {
      const recoveryPK = await this.getUserCredential(oidcToken);
      const accountIds = await fetchAccountIds(recoveryPK);

      if (accountIds.length > 0) {
        return {
          accountId: accountIds[0],
          recoveryPK
        };
      }

      return undefined;
    } catch {
      return undefined;
    }
  }

  getConnection() {
    return this.connection;
  }
}

export default FastAuthController;

export const setAccountIdToController = ({ accountId, networkId }: { accountId: string; networkId: string }) => {
  if (window.fastAuthController) {
    window.fastAuthController.setAccountId(accountId);
  } else {
    window.fastAuthController = new FastAuthController({
      accountId,
      networkId
    });
  }
};

'''
'''--- packages/near-fast-auth-signer/src/lib/firestoreController.ts ---
import { captureException } from '@sentry/react';
import { User } from 'firebase/auth';
import {
  getFirestore, Firestore, collection, setDoc, getDoc, getDocs, query, doc, CollectionReference,
  deleteDoc,
} from 'firebase/firestore';
import UAParser from 'ua-parser-js';

import { fetchAccountIds } from '../api';
import { checkFirestoreReady, firebaseApp, firebaseAuth } from '../utils/firebase';
import { getDeleteKeysAction } from '../utils/mpc-service';
import { Device } from '../utils/types';

class FirestoreController {
  private firestore: Firestore;

  private userUid: string;

  private oidcToken: string;

  constructor() {
    this.firestore = getFirestore(firebaseApp);

    firebaseAuth.onIdTokenChanged(async (user: User) => {
      if (!user) {
        return;
      }
      this.userUid = user.uid;
      this.oidcToken = await user.getIdToken();
    });

    checkFirestoreReady();
  }

  async getAccountIdFromOidcToken() {
    const recoveryPK = await window.fastAuthController.getUserCredential(this.oidcToken);
    const accountIds = await fetchAccountIds(recoveryPK);
    if (!accountIds.length) {
      const noAccountIdError = new Error('Unable to retrieve account Id');
      captureException(noAccountIdError);
      throw noAccountIdError;
    }
    return accountIds[0];
  }

  async addDeviceCollection({
    fakPublicKey,
    lakPublicKey,
    gateway,
    accountId
  }: {
    fakPublicKey: string;
    lakPublicKey: string;
    gateway: string;
    accountId?: string;
  }) {
    try {
      const parser = new UAParser();
      const device = parser.getDevice();
      const os = parser.getOS();
      const browser = parser.getBrowser();
      const dateTime = new Date().toISOString();

      const docPromises = [];

      if (accountId && fakPublicKey) {
        await window.firestoreController.addAccountIdPublicKey(fakPublicKey, accountId);
      }

      if (fakPublicKey) {
        const fakDoc = setDoc(doc(this.firestore, `/users/${this.userUid}/devices`, fakPublicKey), {
          device:     `${device.vendor} ${device.model}`,
          os:         `${os.name} ${os.version}`,
          browser:    `${browser.name} ${browser.version}`,
          publicKeys: [fakPublicKey],
          uid:        this.userUid,
          gateway:    gateway || 'Unknown Gateway',
          dateTime,
          keyType:    'fak',
        }, { merge: true });
        docPromises.push(fakDoc);
      }

      if (lakPublicKey) {
        const lakDoc = setDoc(doc(this.firestore, `/users/${this.userUid}/devices`, lakPublicKey), {
          device:     `${device.vendor} ${device.model}`,
          os:         `${os.name} ${os.version}`,
          browser:    `${browser.name} ${browser.version}`,
          publicKeys: [lakPublicKey],
          uid:        this.userUid,
          gateway:    gateway || 'Unknown Gateway',
          dateTime,
          keyType:    'lak',
        }, { merge: true });
        docPromises.push(lakDoc);
      }

      return await Promise.all(docPromises);
    } catch (err) {
      console.error('Failed to add device collection:', err);
      throw new Error('Failed to add device collection');
    }
  }

  async listDevices() {
    const q = query(collection(this.firestore, `/users/${this.userUid}/devices`) as CollectionReference<Device>);
    const querySnapshot = await getDocs(q);
    const collections = [];

    querySnapshot.forEach((document) => {
      const data = document.data();
      collections.push({
        ...data,
        firebaseId: document.id,
        id:         data.publicKeys[0],
        label:      `${data.gateway || 'Unknown Gateway'} (${data.keyType || 'Unknown Key Type'}) ${data.device} - ${data.browser} - ${data.os}`,
        createdAt:  data.dateTime ? new Date(data.dateTime) : 'Unknown',
      });
    });

    const existingKeyPair = window.fastAuthController.findInKeyStores(`oidc_keypair_${this.oidcToken}`);
    if (!existingKeyPair) {
      await (window as any).fastAuthController.claimOidcToken(this.oidcToken);
    }

    const accountId = await this.getAccountIdFromOidcToken();
    window.fastAuthController.setAccountId(accountId);

    const accessKeysWithoutRecoveryKey = await window.fastAuthController
      .getAllAccessKeysExceptRecoveryKey(this.oidcToken);

    // TODO: from the list, exclude record that has same key from recovery service
    return accessKeysWithoutRecoveryKey.map((key) => {
      const item = collections.find((col) => col.publicKeys.includes(key));
      if (item) {
        return item;
      }
      return {
        id:         key,
        firebaseId: null,
        label:      'Unknown Device',
        createdAt:  'Unknown',
        publicKeys: [key],
      };
    });
  }

  async deleteDeviceCollections(list) {
    const recoveryPK = await window.fastAuthController.getUserCredential(this.oidcToken);
    const accountIds = await fetchAccountIds(recoveryPK);

    if (!accountIds.length) {
      const noAccountIdError = new Error('Unable to retrieve account Id');
      captureException(noAccountIdError);
      throw noAccountIdError;
    }
    // delete firebase records
    try {
      const firestoreIds = list
        .map(({ firebaseId }) => firebaseId)
        .filter((id) => id);
      if (firestoreIds.length) {
        // delete all records except the one that has LAK
        const deletePromises = firestoreIds.flatMap((id) => [
          deleteDoc(doc(this.firestore, `/users/${this.userUid}/devices`, id)),
          deleteDoc(doc(this.firestore, '/publicKeys', id))
        ]);
        await Promise.allSettled(deletePromises);
      }
    } catch (err) {
      console.log('Fail to delete firestore records', err);
      throw new Error(err);
    }

    // delete keys from recovery service
    try {
      const publicKeys = list.reduce((acc, curr) => acc.concat(curr.publicKeys), []);
      const deleteAction = getDeleteKeysAction(publicKeys);
      await (window as any).fastAuthController.signAndSendActionsWithRecoveryKey({
        oidcToken: this.oidcToken,
        accountId: accountIds[0],
        recoveryPK,
        actions:   deleteAction
      });
    } catch (err) {
      console.log('Fail to delete keys', err);
      throw new Error(err);
    }
  }

  async getDeviceCollection(fakPublicKey) {
    const docRef = doc(this.firestore, 'users', this.userUid, 'devices', fakPublicKey);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      return docSnap.data();
    }
    return null;
  }

  updateUser = async ({
    userUid,
    oidcToken,
  }) => {
    this.userUid = userUid;
    this.oidcToken = oidcToken;
  };

  getUserOidcToken = () => this.oidcToken;

  async addAccountIdPublicKey(publicKey: string, accountId: string) {
    await setDoc(doc(this.firestore, 'publicKeys', publicKey), {
      accountId,
    });
  }

  async getAccountIdByPublicKey(publicKey: string): Promise<string> {
    const publicKeyDoc = await getDoc(doc(this.firestore, 'publicKeys', publicKey));
    if (!publicKeyDoc.exists()) {
      return undefined;
    }

    const { accountId } = publicKeyDoc.data() as { accountId: string };

    return accountId;
  }
}

export default FirestoreController;

'''
'''--- packages/near-fast-auth-signer/src/lib/networkParams.ts ---
export default {
  mainnet: {
    networkId: 'mainnet',
    nodeUrl:   'https://rpc.mainnet.near.org',
    walletUrl: 'https://wallet.near.org',
    helperUrl: 'https://helper.mainnet.near.org',
  },
  testnet: {
    networkId: 'testnet',
    nodeUrl:   'https://rpc.testnet.near.org',
    walletUrl: 'https://wallet.testnet.near.org',
    helperUrl: 'https://helper.testnet.near.org',
  },
  localnet: {
    // these are defined by https://github.com/kurtosis-tech/near-package
    networkId: 'localnet',
    nodeUrl:   'http://127.0.0.1:8332',
    walletUrl: 'http://127.0.0.1:8334',
    helperUrl: 'http://127.0.0.1:8330',
  },
};

'''
'''--- packages/near-fast-auth-signer/src/styles/globals.css ---
@import 'bootstrap';

@font-face {
  font-family: 'Mona Sans';
  src: url('../../public/fonts/Mona-Sans.woff2') format('woff2 supports variations'),
    url('../../public/fonts/Mona-Sans.woff2') format('woff2-variations');
  font-weight: 200 900;
  font-stretch: 75% 125%;
}

@font-face {
  font-family: 'FK Grotesk';
  src: url('../../public/fonts/FKGrotesk.woff2') format('woff2 supports variations'),
    url('../../public/fonts/FKGrotesk.woff2') format('woff2-variations');
  font-weight: 200 900;
  font-stretch: 75% 125%;
}

html {
  --body-top-padding: 24px;
  -webkit-font-smoothing: antialiased;
  color: var(--sand12);
}

.btn {
  text-decoration: none;
}

#near-wallet-selector-modal .open{
  z-index: 1001;
}

#w3m-modal { z-index: 1002 }

#launcher {
  color-scheme: light;
  width: 48px;
  height: 50px;
  padding: 0px;
  margin: 10px 20px;
  position: fixed;
  bottom: 10px;
  overflow: visible;
  opacity: 1;
  border: 0px;
  z-index: 999998;
  transition-duration: 250ms;
  transition-timing-function: cubic-bezier(0.645, 0.045, 0.355, 1);
  transition-property: opacity, top, bottom;
  right: 10px;
}

@media (max-width: 650px) {
  #launcher {
    right: 2px;
    bottom: 10px;
  }
}

'''
'''--- packages/near-fast-auth-signer/src/styles/theme.css ---
:root {
  --text-xs: 450 12px/1.4 'Mona Sans', sans-serif;
  --text-s: 450 14px/1.5 'Mona Sans', sans-serif;
  --text-base: 450 16px/1.5 'Mona Sans', sans-serif;
  --text-l: 400 20px/1.3 'FK Grotesk', 'Mona Sans', sans-serif;
  --text-xl: 400 24px/1.3 'FK Grotesk', 'Mona Sans', sans-serif;
  --text-2xl: 400 30px/1.3 'FK Grotesk', 'Mona Sans', sans-serif;
  --text-3xl: 400 42px/1.3 'FK Grotesk', 'Mona Sans', sans-serif;
  --text-hero: 500 80px/1.1 'FK Grotesk', 'Mona Sans', sans-serif;

  --black: hsl(0, 0%, 0%);
  --blackA1: hsla(0, 0%, 0%, 0.012);
  --blackA2: hsla(0, 0%, 0%, 0.027);
  --blackA3: hsla(0, 0%, 0%, 0.047);
  --blackA4: hsla(0, 0%, 0%, 0.071);
  --blackA5: hsla(0, 0%, 0%, 0.09);
  --blackA6: hsla(0, 0%, 0%, 0.114);
  --blackA7: hsla(0, 0%, 0%, 0.141);
  --blackA8: hsla(0, 0%, 0%, 0.22);
  --blackA9: hsla(0, 0%, 0%, 0.439);
  --blackA10: hsla(0, 0%, 0%, 0.478);
  --blackA11: hsla(0, 0%, 0%, 0.565);
  --blackA12: hsla(0, 0%, 0%, 0.91);

  --white: hsl(0, 0%, 100%);
  --whiteA1: hsla(0, 0%, 100%, 0);
  --whiteA2: hsla(0, 0%, 100%, 0.013);
  --whiteA3: hsla(0, 0%, 100%, 0.034);
  --whiteA4: hsla(0, 0%, 100%, 0.056);
  --whiteA5: hsla(0, 0%, 100%, 0.086);
  --whiteA6: hsla(0, 0%, 100%, 0.124);
  --whiteA7: hsla(0, 0%, 100%, 0.176);
  --whiteA8: hsla(0, 0%, 100%, 0.249);
  --whiteA9: hsla(0, 0%, 100%, 0.386);
  --whiteA10: hsla(0, 0%, 100%, 0.446);
  --whiteA11: hsla(0, 0%, 100%, 0.592);
  --whiteA12: hsla(0, 0%, 100%, 0.923);

  --amber1: hsl(39, 70%, 99%);
  --amber2: hsl(40, 100%, 96.5%);
  --amber3: hsl(44, 100%, 91.7%);
  --amber4: hsl(43, 100%, 86.8%);
  --amber5: hsl(42, 100%, 81.8%);
  --amber6: hsl(38, 99.7%, 76.3%);
  --amber7: hsl(36, 86.1%, 67.1%);
  --amber8: hsl(35, 85.2%, 55.1%);
  --amber9: hsl(39, 100%, 57%);
  --amber10: hsl(35, 100%, 55.5%);
  --amber11: hsl(30, 100%, 34%);
  --amber12: hsl(20, 80%, 17%);

  --cyan1: hsla(180, 82%, 98%, 1);
  --cyan2: hsla(180, 75%, 97%, 1);
  --cyan3: hsla(178, 78%, 93%, 1);
  --cyan4: hsla(179, 77%, 88%, 1);
  --cyan5: hsla(178, 78%, 82%, 1);
  --cyan6: hsla(178, 73%, 77%, 1);
  --cyan7: hsla(179, 65%, 72%, 1);
  --cyan8: hsla(178, 60%, 52%, 1);
  --cyan9: hsla(179, 72%, 64%, 1);
  --cyan10: hsla(178, 67%, 57%, 1);
  --cyan11: hsla(186, 78%, 33%, 1);
  --cyan12: hsla(186, 78%, 14%, 1);

  --green1: hsla(150, 100%, 98%, 1);
  --green2: hsla(152, 100%, 97%, 1);
  --green3: hsla(150, 94%, 93%, 1);
  --green4: hsla(151, 93%, 88%, 1);
  --green5: hsla(151, 93%, 82%, 1);
  --green6: hsla(151, 93%, 77%, 1);
  --green7: hsla(150, 86%, 72%, 1);
  --green8: hsla(150, 60%, 51%, 1);
  --green9: hsla(150, 80%, 64%, 1);
  --green10: hsla(150, 74%, 58%, 1);
  --green11: hsla(155, 66%, 32%, 1);
  --green12: hsla(150, 79%, 10%, 1);

  --mauve1: hsl(300, 20%, 99%);
  --mauve2: hsl(300, 7.7%, 97.5%);
  --mauve3: hsl(294, 5.5%, 95.3%);
  --mauve4: hsl(289, 4.7%, 93.3%);
  --mauve5: hsl(283, 4.4%, 91.3%);
  --mauve6: hsl(278, 4.1%, 89.1%);
  --mauve7: hsl(271, 3.9%, 86.3%);
  --mauve8: hsl(255, 3.7%, 78.8%);
  --mauve9: hsl(252, 4%, 57.3%);
  --mauve10: hsl(253, 3.5%, 53.5%);
  --mauve11: hsl(252, 4%, 44.8%);
  --mauve12: hsl(260, 25%, 11%);

  --red1: hsla(6, 100%, 98%, 1);
  --red2: hsla(8, 100%, 97%, 1);
  --red3: hsla(8, 100%, 93%, 1);
  --red4: hsla(7, 100%, 88%, 1);
  --red5: hsla(8, 100%, 82%, 1);
  --red6: hsla(7, 100%, 77%, 1);
  --red7: hsla(8, 99%, 72%, 1);
  --red8: hsla(8, 65%, 57%, 1);
  --red9: hsla(7, 90%, 69%, 1);
  --red10: hsla(7, 81%, 65%, 1);
  --red11: hsla(8, 100%, 33%, 1);
  --red12: hsla(7, 95%, 15%, 1);

  --sand1: hsl(50, 20%, 99%);
  --sand2: hsl(60, 7.7%, 97.5%);
  --sand3: hsl(59, 6.5%, 95.1%);
  --sand4: hsl(58, 6.1%, 92.9%);
  --sand5: hsl(57, 6%, 90.7%);
  --sand6: hsl(56, 5.9%, 88.4%);
  --sand7: hsl(55, 5.9%, 85.2%);
  --sand8: hsl(51, 6%, 77.1%);
  --sand9: hsl(50, 2%, 55.7%);
  --sand10: hsl(55, 1.7%, 51.9%);
  --sand11: hsl(50, 2%, 43.1%);
  --sand12: hsl(50, 6%, 10%);

  --violet1: hsla(248, 80%, 98%, 1);
  --violet2: hsla(245, 73%, 97%, 1);
  --violet3: hsla(245, 67%, 93%, 1);
  --violet4: hsla(244, 67%, 88%, 1);
  --violet5: hsla(245, 67%, 82%, 1);
  --violet6: hsla(245, 68%, 77%, 1);
  --violet7: hsla(245, 62%, 72%, 1);
  --violet8: hsla(250, 53%, 54%, 1);
  --violet9: hsla(245, 64%, 68%, 1);
  --violet10: hsla(246, 57%, 61%, 1);
  --violet11: hsla(241, 50%, 32%, 1);
  --violet12: hsla(244, 49%, 17%, 1);
}

'''
'''--- packages/near-fast-auth-signer/src/translations/de.json ---
{
  "main": {
    "title" : "Hallo mein title",
    "titleDesc": "Dies ist die Titelbeschreibung"

  }
}

'''
'''--- packages/near-fast-auth-signer/src/translations/en.json ---
{
  "main": {
    "title" : "Hello main title",
    "titleDesc" : "This is title description"
  }
}

'''
'''--- packages/near-fast-auth-signer/src/types/global.d.ts ---
/* eslint-disable no-unused-vars */
import FastAuthController from '../lib/controller';
import FirestoreController from '../lib/firestoreController';

export {};

declare global {
    interface Window {
        fastAuthController: FastAuthController;
        firestoreController: FirestoreController;
        rudderAnalytics: any;
    }
    interface Navigator {
        userAgentData?: {
            getHighEntropyValues(keys: string[]): Promise<{ [key: string]: string }>;
        }
    }
}

'''
'''--- packages/near-fast-auth-signer/src/utils/analytics.ts ---
import { nanoid } from 'nanoid';
import * as rudderAnalytics from 'rudder-sdk-js';

import { networkId } from './config';

const ANALYTICS_KEYS = {
  testnet: '2R7K9phhzpFzk2zFIq2EFBtJ8BM',
  mainnet: '2RIih8mrVPUTQ9uWe6TFfwXzcMe'
};

const rudderAnalyticsKey = ANALYTICS_KEYS[networkId];
const DATA_PLANE_URL = 'https://near.dataplane.rudderstack.com';

let userAgentDetail: string;

async function getUserAgentDetails() {
  try {
    if (navigator.userAgentData) {
      const ua = await navigator.userAgentData.getHighEntropyValues(['platformVersion', 'model']);
      const { model, platformVersion } = ua;
      userAgentDetail = JSON.stringify({ userAgent: navigator.userAgent, platformVersion, model });
    } else {
      userAgentDetail = navigator.userAgent;
    }
  } catch (error) {
    console.error('Error getting user agent details:', error);
    userAgentDetail = navigator.userAgent;
  }
}

export async function initAnalytics() {
  if (window.rudderAnalytics) return;
  await getUserAgentDetails();
  try {
    rudderAnalytics.load(rudderAnalyticsKey, DATA_PLANE_URL);
    rudderAnalytics.setAnonymousId(nanoid());
    window.rudderAnalytics = rudderAnalytics;
  } catch (e) {
    console.error('Error initializing analytics:', e);
  }
}

export function recordEvent(eventLabel: string, properties?: Record<string, string>) {
  if (!window.rudderAnalytics) return;
  try {
    rudderAnalytics.track(eventLabel, {
      ...properties,
      url: decodeURIComponent(window.location.href),
      userAgentDetail
    });
  } catch (e) {
    console.error('Error recording event:', e);
  }
}

'''
'''--- packages/near-fast-auth-signer/src/utils/config.ts ---
import { KeyType, PublicKey } from '@near-js/crypto';

import environment from './environment';
import type { Network, NetworkId } from './types';

export const networks: Record<NetworkId, Network> = {
  mainnet: {
    networkId:     'mainnet',
    viewAccountId: 'near',
    nodeUrl:       'https://rpc.mainnet.near.org',
    walletUrl:     'https://wallet.near.org',
    helperUrl:     'https://helper.mainnet.near.org',
    relayerUrl:    environment.RELAYER_URL,
    explorerUrl:   'https://explorer.near.org',
    sentryDsn:       environment.SENTRY_DSN,
    fastAuth:      {
      mpcRecoveryUrl:  'https://near-mpc-recovery-mainnet.api.pagoda.co',
      authHelperUrl:   'https://api.kitwallet.app',
      accountIdSuffix: 'near',
      mpcPublicKey:    new PublicKey({
        keyType: KeyType.ED25519,
        data:    new Uint8Array([
          234,
          209,
          125,
          59,
          237,
          74,
          105,
          230,
          240,
          14,
          115,
          94,
          123,
          18,
          34,
          123,
          37,
          83,
          194,
          145,
          205,
          167,
          49,
          21,
          0,
          0,
          248,
          88,
          142,
          137,
          105,
          220
        ])
      }),
      firebase:        {
        apiKey:            environment.FIREBASE_API_KEY,
        authDomain:        environment.FIREBASE_AUTH_DOMAIN,
        projectId:         environment.FIREBASE_PROJECT_ID,
        storageBucket:     environment.FIREBASE_STORAGE_BUCKET,
        messagingSenderId: environment.FIREBASE_MESSAGING_SENDER_ID,
        appId:             environment.FIREBASE_APP_ID,
        measurementId:     environment.FIREBASE_MEASUREMENT_ID,
      },
    },
  },
  testnet: {
    networkId:     'testnet',
    viewAccountId: 'testnet',
    nodeUrl:       'https://rpc.testnet.near.org',
    walletUrl:     'https://wallet.testnet.near.org',
    helperUrl:     'https://helper.testnet.near.org',
    relayerUrl:    environment.RELAYER_URL_TESTNET,
    explorerUrl:    'https://explorer.testnet.near.org',
    sentryDsn:       environment.SENTRY_DSN_TESTNET,
    fastAuth:      {
      mpcRecoveryUrl:    'https://mpc-recovery-leader-testnet.api.pagoda.co',
      authHelperUrl:   'https://testnet-api.kitwallet.app',
      accountIdSuffix: 'testnet',
      mpcPublicKey:    new PublicKey({
        keyType: KeyType.ED25519,
        data:    new Uint8Array([
          187,
          24,
          21,
          82,
          105,
          165,
          254,
          26,
          167,
          89,
          195,
          236,
          44,
          83,
          69,
          87,
          30,
          151,
          139,
          229,
          233,
          182,
          65,
          230,
          7,
          234,
          204,
          91,
          38,
          70,
          254,
          254
        ])
      }),
      firebase:        {
        apiKey:            environment.FIREBASE_API_KEY_TESTNET,
        authDomain:        environment.FIREBASE_AUTH_DOMAIN_TESTNET,
        projectId:         environment.FIREBASE_PROJECT_ID_TESTNET,
        storageBucket:     environment.FIREBASE_STORAGE_BUCKET_TESTNET,
        messagingSenderId: environment.FIREBASE_MESSAGING_SENDER_ID_TESTNET,
        appId:             environment.FIREBASE_APP_ID_TESTNET,
        measurementId:     environment.FIREBASE_MEASUREMENT_ID_TESTNET,
      },
    },
  },
  // localnet: {
  //   // these are defined by https://github.com/kurtosis-tech/near-package
  //   networkId: 'localnet',
  //   viewAccountId: 'test.near',
  //   nodeUrl: 'http://127.0.0.1:8332',
  //   walletUrl: 'http://127.0.0.1:8334',
  //   helperUrl: 'http://127.0.0.1:8330',
  // },
};

export const networkId: NetworkId = (environment.NETWORK_ID as NetworkId);
export const network = networks[networkId];
export const basePath = environment.REACT_APP_BASE_PATH;

'''
'''--- packages/near-fast-auth-signer/src/utils/cookie.ts ---
export function getCookieValue(cookieName: string) {
  const cookieArray = document.cookie.split(';');
  // eslint-disable-next-line no-restricted-syntax
  for (const cookie of cookieArray) {
    const [key, value] = cookie.trim().split('=');
    if (key === cookieName) {
      return decodeURIComponent(value);
    }
  }
  return null; // Return null if the cookie was not found
}

export function setCookie(name: string, value: string, daysToExpire: number) {
  const expirationDate = new Date();
  expirationDate.setDate(expirationDate.getDate() + daysToExpire);

  document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expirationDate.toUTCString()}; path=/`;
}

'''
'''--- packages/near-fast-auth-signer/src/utils/environment.ts ---
/* eslint-disable max-len */
import pickBy from 'lodash.pickby';

const windowEnv = pickBy((window as unknown as {env: any}).env || {}, (v) => !!v);

const environment = {
  DEBUG:                                windowEnv.DEBUG || process.env.DEBUG,
  REACT_APP_BASE_PATH:                  windowEnv.REACT_APP_BASE_PATH || process.env.REACT_APP_BASE_PATH,
  NETWORK_ID:                           windowEnv.NETWORK_ID || process.env.NETWORK_ID,
  RELAYER_URL:                          windowEnv.RELAYER_URL || process.env.RELAYER_URL,
  FIREBASE_API_KEY:                     windowEnv.FIREBASE_API_KEY || process.env.FIREBASE_API_KEY,
  FIREBASE_AUTH_DOMAIN:                 windowEnv.FIREBASE_AUTH_DOMAIN || process.env.FIREBASE_AUTH_DOMAIN,
  FIREBASE_PROJECT_ID:                  windowEnv.FIREBASE_PROJECT_ID || process.env.FIREBASE_PROJECT_ID,
  FIREBASE_STORAGE_BUCKET:              windowEnv.FIREBASE_STORAGE_BUCKET || process.env.FIREBASE_STORAGE_BUCKET,
  FIREBASE_MESSAGING_SENDER_ID:         windowEnv.FIREBASE_MESSAGING_SENDER_ID || process.env.FIREBASE_MESSAGING_SENDER_ID,
  FIREBASE_APP_ID:                      windowEnv.FIREBASE_APP_ID || process.env.FIREBASE_APP_ID,
  FIREBASE_MEASUREMENT_ID:              windowEnv.FIREBASE_MEASUREMENT_ID || process.env.FIREBASE_MEASUREMENT_ID,
  RELAYER_URL_TESTNET:                  windowEnv.RELAYER_URL_TESTNET || process.env.RELAYER_URL_TESTNET,
  FIREBASE_API_KEY_TESTNET:             windowEnv.FIREBASE_API_KEY_TESTNET || process.env.FIREBASE_API_KEY_TESTNET,
  FIREBASE_AUTH_DOMAIN_TESTNET:         windowEnv.FIREBASE_AUTH_DOMAIN_TESTNET || process.env.FIREBASE_AUTH_DOMAIN_TESTNET,
  FIREBASE_PROJECT_ID_TESTNET:          windowEnv.FIREBASE_PROJECT_ID_TESTNET || process.env.FIREBASE_PROJECT_ID_TESTNET,
  FIREBASE_STORAGE_BUCKET_TESTNET:      windowEnv.FIREBASE_STORAGE_BUCKET_TESTNET || process.env.FIREBASE_STORAGE_BUCKET_TESTNET,
  FIREBASE_MESSAGING_SENDER_ID_TESTNET: windowEnv.FIREBASE_MESSAGING_SENDER_ID_TESTNET || process.env.FIREBASE_MESSAGING_SENDER_ID_TESTNET,
  FIREBASE_APP_ID_TESTNET:              windowEnv.FIREBASE_APP_ID_TESTNET || process.env.FIREBASE_APP_ID_TESTNET,
  FIREBASE_MEASUREMENT_ID_TESTNET:      windowEnv.FIREBASE_MEASUREMENT_ID_TESTNET || process.env.FIREBASE_MEASUREMENT_ID_TESTNET,
  SENTRY_DSN:                           windowEnv.SENTRY_DSN || process.env.SENTRY_DSN,
  SENTRY_DSN_TESTNET:                   windowEnv.SENTRY_DSN_TESTNET || process.env.SENTRY_DSN_TESTNET,
  GIT_COMMIT_HASH:                      windowEnv.GIT_COMMIT_HASH || process.env.GIT_COMMIT_HASH,
};

export default environment;

'''
'''--- packages/near-fast-auth-signer/src/utils/firebase.ts ---
/* eslint-disable import/no-extraneous-dependencies */
import { initializeApp, FirebaseError } from 'firebase/app';
import { getAuth } from 'firebase/auth';

import { network } from './config';

const errorCodeMessageMap = {
  'auth/invalid-action-code': 'This link is malformed, expired or has already been used. Please request a new one.',
  // Add more error code-message mappings as needed
};

// Initialize Firebase
export const firebaseApp = initializeApp(network.fastAuth.firebase);
export const firebaseAuth = getAuth(firebaseApp);

export const checkFirestoreReady = async () => firebaseAuth.authStateReady()
  .then(async () => {
    if (firebaseAuth.currentUser) {
      return true;
    }
    return false;
  });

export const isFirebaseError = (error: Error) => error instanceof FirebaseError;

export const getFirebaseErrorMessage = (error: FirebaseError) => {
  const errorCode = error.code;

  return errorCodeMessageMap[errorCode] || 'An unknown error occurred. Please try again later.';
};

'''
'''--- packages/near-fast-auth-signer/src/utils/form-validation.ts ---
/* eslint-disable no-useless-escape */
export const getEmailId = (email: string) => email
  .split('@')[0]
  .toLowerCase()
  .replace(/[^a-zA-Z0-9_\\-]/g, '-');

export const emailPattern = /\S+@\S+\.\S+/;
export const accountAddressPattern = /^(([a-z\d]+[-_])*[a-z\d]+\.)*([a-z\d]+[-_])*[a-z\d]+$/;

/**
 * regex for the body of an account not including TLA and not allowing subaccount
 */
export const accountAddressPatternNoSubAccount = /^([a-z\d]+[-_])*[a-z\d]+$/;

'''
'''--- packages/near-fast-auth-signer/src/utils/index.ts ---
import { basePath } from './config';

export function isUrlNotJavascriptProtocol(url) {
  if (!url) {
    return true;
  }
  try {
    const urlProtocol = new URL(url).protocol;
    // eslint-disable-next-line no-script-url
    if (urlProtocol === 'javascript:') {
      console.log('Invalid URL protocol:', urlProtocol, 'URL cannot execute JavaScript');
      return false;
    }
    return true;
  } catch (error) {
    return false;
  }
}

export function inIframe() {
  try {
    return window.self !== window.top;
  } catch (e) {
    return true;
  }
}

export const decodeIfTruthy = (paramVal) => {
  if (paramVal === 'true' || paramVal === 'false') return paramVal === 'true';
  if (paramVal) {
    return decodeURIComponent(paramVal);
  }

  return paramVal;
};

export const redirectWithError = ({
  failure_url,
  success_url,
  error
}: { failure_url: string; success_url: string; error: Error }): void => {
  const { message } = error;
  const validFailureUrl = isUrlNotJavascriptProtocol(failure_url) && failure_url;
  const validSuccessUrl = isUrlNotJavascriptProtocol(success_url) && success_url;
  const parsedUrl = new URL(validFailureUrl || validSuccessUrl || window.location.origin + (basePath ? `/${basePath}` : ''));
  parsedUrl.searchParams.set('reason', message);
  window.location.replace(parsedUrl.href);
};

/**
 * Safely retrieves a value from local storage.
 * If the retrieval fails (e.g., due to a SecurityError when the localStorage is not accessible),
 * it will return undefined.
 *
 * @param {string} key - The key of the item to retrieve from local storage.
 * @returns {string | undefined} The retrieved item's value, or undefined if the retrieval fails.
 */
export const safeGetLocalStorage = (key: string) => {
  try {
    return window.localStorage.getItem(key);
  } catch {
    return undefined;
  }
};

export const deleteOidcKeyPairOnLocalStorage = () => {
  const itemCount = localStorage.length;
  for (let i = 0; i < itemCount; i += 1) {
    const key = localStorage.key(i);
    if (key && key.startsWith('near-api-js:keystore:oidc_keypair')) {
      console.log(`removing ${key} from localStorage`);
      localStorage.removeItem(key);
    }
  }
};

export const assertNever = (x: never, customErrorMessage?: string): never => {
  throw new Error(customErrorMessage || `Unexpected object: ${x}`);
};

// Use this function to implement wait logic for async process
export const withTimeout = async (promise, timeoutMs) => {
  // Create a promise that resolves with false after timeoutMs milliseconds
  const timeoutPromise = new Promise((resolve) => { setTimeout(() => resolve(false), timeoutMs); });

  // Race the input promise against the timeout
  return Promise.race([promise, timeoutPromise]);
};

export const isSafari = () => /^((?!chrome|android).)*safari/i
  .test(navigator.userAgent);

export const extractQueryParams = (searchParams: URLSearchParams, paramNames: string[]) => {
  const params = {};
  paramNames.forEach((paramName) => {
    const paramValue = searchParams.get(paramName);
    if (paramValue !== null) {
      params[paramName] = paramValue;
    }
  });
  return params;
};

'''
'''--- packages/near-fast-auth-signer/src/utils/keypom-options.ts ---
/* eslint-disable import/prefer-default-export */
import type { NetworkId } from './types';

export const KEYPOM_OPTIONS = (networkId: NetworkId) => {
  return {
    beginTrial: {
      landing: {
        title:            'Create an Account',
        body:             'To start, enter a username.',
        fieldPlaceholder: 'Account ID',
        buttonText:       'Create',
      },
      claiming: {
        title: 'Creating Account',
        body:  'Your account is being created. Please wait...',
      },
      claimed: {
        title:      "You're all set! 🎉",
        body:       'Your account has been successfully created.',
        buttonText: 'Continue to app',
      },
    },
    trialOver: {
      mainBody: {
        title:    'Your trial has ended',
        body:     'Choose a wallet provider and onboard fully into the NEAR ecosystem.',
        imageOne: {
          title: 'Secure Your Digital Assets',
          body:  'Now that your trial is over, secure your account with an official wallet provider!',
        },
        imageTwo: {
          title: 'Log In to Any NEAR App',
          body:  'Once your account is secured, you can use any app on NEAR!',
        },
      },
      offboardingOptions: {
        title: 'Choose a Wallet',
      },
    },
    invalidAction: {
      title: 'Invalid Action',
      body:  'Your trial does not allow you to perform this action. For more information, please contact the site administrator.',
    },
    insufficientBalance: {
      title: 'Insufficient Balance',
      body:  'Your account does not have enough balance for the action you are trying to perform. Please try again with a different action. For more information, please contact the site administrator.',
    },
    wallets: [
      {
        name:        'MyNEARWallet',
        description: 'Secure your account with a Seed Phrase',
        iconUrl:
          'data:image/png;base64,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',
        redirectUrl: `${
          networkId === 'testnet' ? 'https://testnet.mynearwallet.com' : 'https://app.mynearwallet.com'
        }/linkdrop/ACCOUNT_ID/SECRET_KEY`,
      },
    ],
  };
};

'''
'''--- packages/near-fast-auth-signer/src/utils/mpc-service.ts ---
import { PublicKey } from '@near-js/crypto';
import { Action, SCHEMA, actionCreators } from '@near-js/transactions';
import { serialize } from 'borsh';
import { sha256 } from 'js-sha256';

import { network } from './config';
import { SignRequestFrpSignature, UserCredentialsFrpSignature } from './types';

export const CLAIM = 3177899144;

const {
  addKey, functionCallAccessKey, fullAccessKey, deleteKey
} = actionCreators;

const hashToken = (oidcToken: string): number[] => {
  const tokenHash = sha256.create();
  tokenHash.update(oidcToken);
  return tokenHash.array();
};

export const convertToHex = (arr: Uint8Array): string => Buffer.from(arr).toString('hex');

export const getUserCredentialsFrpSignature = ({
  salt, oidcToken, shouldHashToken, keypair
}: UserCredentialsFrpSignature): string => {
  const saltSerialize = serialize(new Map([[Object, { kind: 'struct', fields: [['salt', 'u32']] }]]), ({ salt }));
  const token = shouldHashToken ? hashToken(oidcToken) : oidcToken;
  const tokenType = shouldHashToken ? [32] : 'string';
  const tokenSerialize = serialize(new Map([[Object, { kind: 'struct', fields: [['oidc_token', tokenType]] }]]), ({ oidc_token: token }));
  const publicKeySerialize = serialize(new Map([[Object, { kind: 'struct', fields: [['public_key', [32]]] }]]), ({ public_key: Array.from(keypair.getPublicKey().data) }));

  const mergeArray = new Uint8Array(saltSerialize.length + tokenSerialize.length + publicKeySerialize.length + 1);
  mergeArray.set(saltSerialize);
  mergeArray.set(tokenSerialize, saltSerialize.length);
  mergeArray.set([0], saltSerialize.length + tokenSerialize.length);
  mergeArray.set(publicKeySerialize, saltSerialize.length + tokenSerialize.length + 1);

  const hash = sha256.create();
  hash.update(mergeArray);

  const signature = keypair.sign(new Uint8Array(hash.arrayBuffer()));
  return convertToHex(signature.signature);
};

export const getSignRequestFrpSignature = ({
  salt, oidcToken, keypair, delegateAction
}: SignRequestFrpSignature): string => {
  const saltSerialize = serialize(new Map([[Object, { kind: 'struct', fields: [['salt', 'u32']] }]]), ({ salt }));
  const delegateActionSerialize = serialize(SCHEMA, delegateAction);
  const oidcTokenSerialize = serialize(new Map([[Object, { kind: 'struct', fields: [['oidc_token', 'string']] }]]), ({ oidc_token: oidcToken }));
  const publicKeySerialize = serialize(new Map([[Object, { kind: 'struct', fields: [['public_key', [32]]] }]]), ({ public_key: Array.from(keypair.getPublicKey().data) }));
  const mergeArray = new Uint8Array(
    saltSerialize.length + delegateActionSerialize.length + oidcTokenSerialize.length + publicKeySerialize.length + 1
  );
  mergeArray.set(saltSerialize);
  mergeArray.set(delegateActionSerialize, saltSerialize.length);
  mergeArray.set(oidcTokenSerialize, delegateActionSerialize.length + saltSerialize.length);
  mergeArray.set([0], saltSerialize.length + delegateActionSerialize.length + oidcTokenSerialize.length);
  mergeArray.set(
    publicKeySerialize,
    saltSerialize.length + delegateActionSerialize.length + oidcTokenSerialize.length + 1
  );
  const hash = sha256.create();
  hash.update(mergeArray);

  const signature = keypair.sign(new Uint8Array(hash.arrayBuffer()));
  return convertToHex(signature.signature);
};

export const getAddKeyAction = ({
  publicKeyLak,
  webAuthNPublicKey,
  contractId,
  methodNames,
  allowance,
}): Action[] => [
  addKey(PublicKey.from(webAuthNPublicKey), fullAccessKey())
].concat(
  publicKeyLak
    ? addKey(
      PublicKey.from(publicKeyLak),
      functionCallAccessKey(contractId, methodNames || [], allowance)
    )
    : []
);

export const getAddLAKAction = ({
  publicKeyLak,
  contractId,
  methodNames,
  allowance,
}): [Action] => [
  addKey(
    PublicKey.from(publicKeyLak),
    functionCallAccessKey(contractId, methodNames || [], allowance)
  )
];

export const getDeleteKeysAction = (publicKeys: string[]): Action[] => publicKeys
  .map((key) => deleteKey(PublicKey.from(key)));

export const errorMessages: Record<string, string> = {
  'auth/expired-action-code': 'Link expired, please try again.',
  'auth/invalid-action-code': 'Link expired, please try again.',
  'auth/invalid-email':       'Invalid email address.',
  'auth/user-disabled':       'User disabled',
  'auth/missing-email':       'No email found, please try again.',
};

export const verifyMpcSignature = (mpcSignature: string, originalSignature: string): boolean => {
  const mpcSignatureBytes = Uint8Array.from(Buffer.from(mpcSignature, 'hex'));
  const originalSignatureBytes = Uint8Array.from(Buffer.from(originalSignature, 'hex'));
  const claimData = { salt: CLAIM + 1, signature:  originalSignatureBytes };
  const serializedData = serialize(new Map([
    [Object, { kind: 'struct', fields: [['salt', 'u32'], ['signature', ['u8', 64]]] }]
  ]), claimData);
  const hashedData = new Uint8Array(sha256.array(serializedData));
  return network.fastAuth.mpcPublicKey.verify(hashedData, mpcSignatureBytes);
};

'''
'''--- packages/near-fast-auth-signer/src/utils/types.ts ---
/* eslint-disable no-use-before-define */
/* eslint-disable no-unused-vars */
import { KeyPair, PublicKey } from '@near-js/crypto';
import { DelegateAction } from '@near-js/transactions';

export type NetworkId = ProductionNetwork['networkId'];
export type Network = ProductionNetwork;
// export type NetworkId = ProductionNetwork['networkId'] | DevelopmentNetwork['networkId'];
// export type Network = ProductionNetwork | DevelopmentNetwork;

type ProductionNetwork = {
  networkId: 'testnet' | 'mainnet';
  viewAccountId: string;
  nodeUrl: string;
  walletUrl: string;
  helperUrl: string;
  relayerUrl: string;
  explorerUrl: string;
  sentryDsn?: string;
  fastAuth: {
    mpcRecoveryUrl: string;
    authHelperUrl: string; // TODO refactor: review by fastauth team
    accountIdSuffix: string;
    mpcPublicKey: PublicKey,
    firebase: {
      apiKey: string;
      authDomain: string;
      projectId: string;
      storageBucket: string;
      messagingSenderId: string;
      appId: string;
      measurementId: string;
    };
  };
};

export type UserCredentialsFrpSignature = {
  salt: number;
  oidcToken: string;
  shouldHashToken: boolean;
  keypair: KeyPair;
};

export type SignRequestFrpSignature = {
  salt: number;
  oidcToken: string;
  keypair: KeyPair;
  delegateAction: DelegateAction;
};

export type Device = {
  device: string;
  os: string;
  browser: string;
  publicKeys: string[];
  uid: string;
  gateway: string | null;
  dateTime: Date;
  keyType: string;
};

export type DeleteDevice = {
  firebaseId: string;
  publicKeys: string[];
};

// type DevelopmentNetwork = {
//   networkId: 'localnet';
//   viewAccountId: string;
//   nodeUrl: string;
//   walletUrl: string;
//   helperUrl: string;
// };

'''
'''--- packages/near-fast-auth-signer/tsconfig.json ---
{
  "compilerOptions": {
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "esModuleInterop": true,
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "typeRoots": ["./node_modules/@types", "./src/types"],
    "jsx": "react",
    "incremental": true,
    "sourceMap": true
  },
  "exclude": ["node_modules", "dist"],
  "include": ["**/*.ts", "**/*.tsx", "**/*.js", "config.js.template"]
}

'''
'''--- packages/near-fast-auth-signer/vercel.json ---
{
  "rewrites": [
    { "source": "/(.*)", "destination": "/" }
  ]
}
'''
'''--- packages/near-fast-auth-signer/webpack.config.js ---
const childProcess = require('child_process');
const path = require('path');

const { sentryWebpackPlugin } = require('@sentry/webpack-plugin');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const webpack = require('webpack');

// Execute Git command to get the current commit ID
const commitHash = childProcess.execSync('git rev-parse --short HEAD').toString().trim();

module.exports = (env, argv) => {
  console.log(`Mode: ${argv.mode}`);
  return {
    entry:  './src/index.tsx',
    output: {
      filename:   'main.js',
      path:       path.resolve(__dirname, 'dist'),
      publicPath: '/',
    },
    plugins: [
      new HtmlWebpackPlugin({
        template: path.join(__dirname, 'public', 'index.html'),
      }),
      new webpack.ProvidePlugin({
        process: 'process/browser',
        Buffer:  ['buffer', 'Buffer']
      }),
      new webpack.EnvironmentPlugin({
        DEBUG:                                true,
        REACT_APP_BASE_PATH:                  '',
        NETWORK_ID:                           'mainnet',
        RELAYER_URL:                          'https://near-relayer-mainnet.api.pagoda.co/relay',
        FIREBASE_API_KEY:                     'AIzaSyDhxTQVeoWdnbpYTocBAABbLULGf6H5khQ',
        FIREBASE_AUTH_DOMAIN:                 'near-fastauth-prod.firebaseapp.com',
        FIREBASE_PROJECT_ID:                  'near-fastauth-prod',
        FIREBASE_STORAGE_BUCKET:              'near-fastauth-prod.appspot.com',
        FIREBASE_MESSAGING_SENDER_ID:         '829449955812',
        FIREBASE_APP_ID:                      '1:829449955812:web:532436aa35572be60abff1',
        FIREBASE_MEASUREMENT_ID:              'G-T2PPJ8QRYY',
        RELAYER_URL_TESTNET:                  'https://near-relayer-testnet.api.pagoda.co/relay',
        FIREBASE_API_KEY_TESTNET:             'AIzaSyDAh6lSSkEbpRekkGYdDM5jazV6IQnIZFU',
        FIREBASE_AUTH_DOMAIN_TESTNET:         'pagoda-oboarding-dev.firebaseapp.com',
        FIREBASE_PROJECT_ID_TESTNET:          'pagoda-oboarding-dev',
        FIREBASE_STORAGE_BUCKET_TESTNET:      'pagoda-oboarding-dev.appspot.com',
        FIREBASE_MESSAGING_SENDER_ID_TESTNET: '116526963563',
        FIREBASE_APP_ID_TESTNET:              '1:116526963563:web:053cb0c425bf514007ca2e',
        FIREBASE_MEASUREMENT_ID_TESTNET:      'G-HF2NBGE60S',
        SENTRY_DSN:                           'https://1049553ebca8337848160ca53a49ff2a@o398573.ingest.sentry.io/4506148066164736',
        SENTRY_DSN_TESTNET:                   'https://ce94b1ec626e971719c20fa7979158f3@o398573.ingest.sentry.io/4506702275411968',
        GIT_COMMIT_HASH:                      commitHash,
      }),
      ...(process.env.SENTRY_AUTH_TOKEN
        ? [sentryWebpackPlugin({
          org:        'near-protocol',
          project:    process.env.NETWORK_ID === 'mainnet' ? 'fast-auth-signer' : 'fast-auth-signer-testnet',
          authToken:  process.env.SENTRY_AUTH_TOKEN,
          release:    { name: commitHash },
          sourcemaps: { assets: ['./dist/main.js', './dist/main.js.map'] },
          telemetry:  false,
          urlPrefix:  '~/',
        })]
        : []
      )],
    devServer: {
      static: {
        directory: path.join(__dirname, 'dist'),
      },
      port: 3000,
    },
    devtool: argv.mode === 'production' ? 'source-map' : 'eval-source-map',
    module:  {
      // exclude node_modules
      rules: [
        {
          test:    /\.(js|ts|tsx)$/,
          exclude: /node_modules/,
          use:     ['ts-loader'],
        },
        {
          test: /\.css$/i,
          use:  ['style-loader', 'css-loader'],
        },
        {
          test: /\.(woff(2)?|ttf|eot|svg)(\?v=\d+\.\d+\.\d+)?$/,
          type: 'asset/resource',
        },
      ],
    },
    // pass all js files through Babel
    resolve: {
      extensions: ['.ts', '.tsx', '.js', '.css'],
      fallback:   {
        https:             require.resolve('https-browserify'),
        http:              require.resolve('stream-http'),
        // crypto:   require.resolve('crypto-browserify'),
        crypto:            false,
        stream:            require.resolve('stream-browserify'),
        process:           require.resolve('process/browser'),
        'process/browser': require.resolve('process/browser'),
        url:               require.resolve('url/')
      }
    }
  };
};

'''