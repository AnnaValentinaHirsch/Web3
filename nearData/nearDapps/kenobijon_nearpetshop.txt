*GitHub Repository "kenobijon/nearpetshop"*

'''--- Cargo.toml ---
[package]
name = "pet_shop_contract"
version = "0.1.0"
edition = "2021"
authors = ["Ken Miyachi <ken@near.foundation>"]

[dependencies]
near-sdk = "4.0.0-pre.7"
near-contract-standards = "4.0.0-pre.7"

[lib]
crate-type = ["cdylib"]

[profile.release]
codegen-units = 1
opt-level = "z"
lto = true
debug = false
panic = "abort"
overflow-checks = true
'''
'''--- README.md ---
# NEAR Pet Shop Smart Contract

Sample Pet Shop Contract based upon popular [Truffle Pet Shop Tutorial](https://trufflesuite.com/tutorial/)

# Required Software

- Rust 1.61.1 + cargo
- Node.js
- NEAR CLI 3.4

# Authors

- Ken Miyachi <ken@near.foundation> 

'''
'''--- build.sh ---
#!/usr/bin/env bash

RUSTFLAGS='-C link-arg=-s' cargo build --target wasm32-unknown-unknown --release
cp ./target/wasm32-unknown-unknown/release/pet_shop_contract.wasm ./res/

'''
'''--- clean.sh ---
PET_CONTRACT="petshop.kenobi.testnet"
ACCOUNT="kenobi.testnet"
near delete $PET_CONTRACT $ACCOUNT

'''
'''--- deploy.sh ---
#!/usr/bin/env bash

# WASM_PATH="$(find ./target/wasm32-unknown-unknown/release/ -maxdepth 1 -name "*.wasm")"

# near deploy \
#   --wasmFile $WASM_PATH \
#   --accountId "kenobi.tesnet" \
#   --initFunction new \
#   --initArgs "$(node ./init-args.js)"

WASM_PATH="./res/pet_shop_contract.wasm"
PET_CONTRACT="petshop.kenobi.testnet"
near create-account $PET_CONTRACT --masterAccount kenobi.testnet 
near deploy --accountId $PET_CONTRACT --wasmFile $WASM_PATH --initFunction "new" --initArgs '{}'

'''
'''--- dev-deploy.sh ---
#!/usr/bin/env bash

WASM_PATH="$(find ./target/wasm32-unknown-unknown/release/ -maxdepth 1 -name "*.wasm")"

near dev-deploy \
  --wasmFile $WASM_PATH \
  "$@"

near call "$(<./neardev/dev-account)" new "$(node ./init-args.js)" \
  --accountId "$(<./neardev/dev-account)"

'''
'''--- init-args.js ---
const ONE_DAY = 1_000_000_000 * 60 * 60 * 24;

// 1e24, calculated like this because JS numbers don't work that large
const ONE_NEAR = BigInt(1e12) ** 2n;

console.log(JSON.stringify({}));

'''
'''--- rustfmt.toml ---
tab_spaces = 2

'''
'''--- src/lib.rs ---
use near_sdk::borsh::{self, BorshDeserialize, BorshSerialize};
use near_sdk::{env,log, near_bindgen, AccountId, Balance, EpochHeight};
use std::collections::HashMap;
use near_sdk::env::predecessor_account_id; 
use near_sdk::collections::Vector;

#[derive(BorshDeserialize, BorshSerialize)]
pub struct Pet {
    pub name: String,
    pub pet_id: u8,
}

impl Default for Pet {
    fn default() -> Self {
        Self {
            name: String::from("Mushu"),
            pet_id: 0,
        }
    }
}

/// Voting contract for unlocking transfers. Once the majority of the stake holders agree to
/// unlock transfer, the time will be recorded and the voting ends.
#[near_bindgen]
#[derive(BorshDeserialize, BorshSerialize)]
pub struct PetShopContract {
    /// How much each validator votes
    pub pet_id: u8,
    pub pet_owner_map: HashMap<AccountId, Pet>,
    pub pet_id_map: HashMap<u8, String>,
    pub pet_vec: Vector<String>,
    pub adopters: Vector<AccountId>
}

impl Default for PetShopContract {
    fn default() -> Self {
        env::panic_str("Pet Shop Contract contract should be initialized before usage")
    }
}

#[near_bindgen]
impl PetShopContract {
    #[init]
    pub fn new() -> Self {
        assert!(!env::state_exists(), "The contract is already initialized");
        PetShopContract {
            pet_id: 0,
            pet_owner_map: HashMap::new(),
            pet_id_map: HashMap::new(),
            pet_vec: Vector::new(vec![]),
            adopters: Vector::new(vec![]),
        }
    }

    pub fn adopt(&mut self, pet_name: &mut String) -> String {
        let new_pet = Pet {
            name: pet_name.to_string(),
            pet_id: self.pet_id,
        };
        let account_id = predecessor_account_id(); 
        self.pet_vec.push(&pet_name.to_string());
        self.adopters.push(&account_id);
        self.pet_owner_map.insert(account_id, new_pet);
        self.pet_id_map.insert(self.pet_id, pet_name.to_string());
        self.pet_id += 1; 
        log!("{} has been adopted!!", pet_name);
        return pet_name.to_string();
    }

    pub fn get_pet(&mut self, id: &u8) -> String {
        let s = String::from("No Name");
        let p = self.pet_id_map.get(id).unwrap_or(&s);
        return p.to_string();
    }

    pub fn get_owner(&mut self, id: u64) -> String {
        let s = String::from("No Name");
        let p = self.pet_vec.get(id).unwrap_or(s);
        return p.to_string();
    }

    pub fn list_pet(&mut self) -> String {
        let account_id = predecessor_account_id(); 
        let s = String::from("No Name");
        let new_pet = Pet {
            name: s,
            pet_id: self.pet_id,
        };
        let p = self.pet_owner_map.get(&account_id).unwrap_or(&new_pet);
        let r = &p.name;
        return r.to_string();
    }

    pub fn list_owner(&mut self, id: u64) -> AccountId {
        let s: AccountId = "alice.near".parse().unwrap();
        let p = self.adopters.get(id).unwrap_or(s);
        return p;
    }
    

    pub fn clear(&mut self) {
        self.pet_id = 0;
        self.pet_owner_map =  HashMap::new();
        self.pet_id_map = HashMap::new();
        self.pet_vec = Vector::new(vec![]); 
    }

}

#[cfg(all(test, not(target_arch = "wasm32")))]
mod tests {
    use super::*;
    use near_sdk::test_utils::VMContextBuilder;
    use near_sdk::{testing_env, VMContext};

    #[test]
    fn test_contract_initialization() {
        let mut contract = PetShopContract::new();
        let id = contract.pet_id; 
        assert_eq!(id, 0);
    }
}

'''
'''--- test.sh ---
PET_CONTRACT="petshop.kenobi.testnet"
ACCOUNT="kenobi.testnet"
ACCOUNT2="nearatx.testnet"

# Adopt pet
near call $PET_CONTRACT adopt '{"pet_name": "Mushu"}' --account-id $ACCOUNT

# Get pet name by ID
near call $PET_CONTRACT get_pet '{"id": 0}' --account-id $ACCOUNT

# Get pet owner 
near call $PET_CONTRACT get_owner '{"id": 0}' --account-id $ACCOUNT

# Get pet by owner account id
near call $PET_CONTRACT list_owner '{"id": 0}' --account-id $ACCOUNT

# near call $PET_CONTRACT adopt '{"pet_name": "Speedy"}' --account-id $ACCOUNT
# near call $PET_CONTRACT get_pet '{"id": 1}' --account-id $ACCOUNT

# Adopt pet
near call $PET_CONTRACT adopt '{"pet_name": "Speedy"}' --account-id $ACCOUNT2

# Get pet name by ID
near call $PET_CONTRACT get_pet '{"id": 1}' --account-id $ACCOUNT2

# Get pet owner 
near call $PET_CONTRACT get_owner '{"id": 1}' --account-id $ACCOUNT2

# Get pet by owner account id
near call $PET_CONTRACT list_owner '{"id": 1}' --account-id $ACCOUNT2
'''