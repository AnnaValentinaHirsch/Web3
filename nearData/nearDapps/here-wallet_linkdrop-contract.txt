*GitHub Repository "here-wallet/linkdrop-contract"*

'''--- .env ---
ACCOINT_ID=
DEV_ACCOINT_ID=
SIGN_ACCOINT_ID=
'''
'''--- README.md ---
NEAR access by phone number
====

Smart contract for send NEAR, NFT, FT by sms

Sample send NFT

```
near call tonic_goblin.enleap.near nft_transfer_call '{"receiver_id": "phone.herewallet.near","token_id":"1780", "msg": "[phone number hash]"}' --accountId mydev.near  --gas 242794783120800 --depositYocto 1
```

Sample send NEAR

```
near call phone.herewallet.testnet send_near_to_phone '{"phone":"[phone number hash]"}' --gas 242794783120800 --accountId petr4.testnet --deposit 1

```

Sample send FT
```
near call usdn.testnet ft_transfer_call '{"receiver_id": "phone.herewallet.testnet", "amount": "100000000", "msg": "phone number hash]"}' --accountId petr4.testnet  --gas 242794783120800 --depositYocto 1
```

----------

## Development

1. Install `rustup` via https://rustup.rs/
2. Run the following:

```
rustup default stable
rustup target add wasm32-unknown-unknown
```

### Testing

Contracts have unit tests

```
make run-test
```

### Compiling

You can build release version by running next scripts inside each contract folder:

```
make build
```

### Deploying to TestNet

To deploy to TestNet, you can use next command:
```
make deploy-dev
```

This will use contract ID from `Makefile`

## Bash API

```
near call phone.herewallet.testnet send_near_to_phone '{"phone":"test"}' --gas 242794783120800 --accountId petr4.testnet --deposit 1
near call phone.herewallet.testnet receive_payments '{"phone":"test3"}' --gas 242794783120800 --accountId petr4.testnet
near call phone.herewallet.testnet allocate_phone '{"phone":"test3", "account_id":"petr4.testnet"}' --gas 242794783120800 --accountId herewallet.testnet --depositYocto 1
```
'''
'''--- contract/Cargo.toml ---
[package]
name = "here-linkdrop"
version = "0.1.0"
authors = ["HERE Wallet Inc <team@herewallet.app>"]
edition = "2018"

[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
near-sdk = "3.1.0"
near-contract-standards = "3.2.0"
serde = "1.0.36"
log = "0.4.16"
bs58 = { version="0.4.0", features=["check"] }

[profile.release]
codegen-units = 1
# Tell `rustc` to optimize for small code size.
opt-level = "z"
lto = true
debug = false
panic = "abort"
# Opt into extra safety checks on arithmetic operations https://stackoverflow.com/a/64136471/249801
overflow-checks = true

'''
'''--- contract/src/lib.rs ---
use near_sdk::borsh::{self, BorshDeserialize, BorshSerialize};
use near_sdk::collections::{UnorderedMap};
use near_sdk::env::sha256;
use near_sdk::json_types::ValidAccountId;
use near_sdk::json_types::U128;
use near_sdk::{ext_contract, Balance, Promise};
use near_sdk::{env, near_bindgen, AccountId, PanicOnDefault};
use serde::Serialize;

pub static GAS: u64 = 10_000_000_000_000;

#[derive(BorshDeserialize, BorshSerialize, Serialize)]
pub struct NearTrustTransaction {
    from_account_id: AccountId,
    amount: Balance,
}

#[derive(BorshDeserialize, BorshSerialize, Serialize)]
pub struct NftTrustTransaction {
    from_account_id: AccountId,
    nft_contract_id: AccountId,
    nft_token_id: String,
}

#[derive(BorshDeserialize, BorshSerialize, Serialize)]
pub struct FtTrustTransaction {
    from_account_id: AccountId,
    ft_contract_id: AccountId,
    ft_amount: Balance,
}

#[ext_contract(nft_contract)]
pub trait NftContract {
    fn nft_transfer(&self, receiver_id: String, token_id: String);
}

#[ext_contract(ft_contract)]
pub trait FtContract {
    fn ft_transfer(&self, receiver_id: String, amount: U128);
}

#[near_bindgen]
#[derive(BorshDeserialize, BorshSerialize, PanicOnDefault)]
pub struct Contract {
    near_trusts: UnorderedMap<String, NearTrustTransaction>,
    ft_trusts: UnorderedMap<String, FtTrustTransaction>,
    nft_trusts: UnorderedMap<String, NftTrustTransaction>,
}

#[near_bindgen]
impl Contract {
    #[init]
    pub fn new() -> Self {
        assert!(!env::state_exists(), "Already initialized");
        Self {
            near_trusts: UnorderedMap::new(b"n".to_vec()),
            ft_trusts: UnorderedMap::new(b"ft".to_vec()),
            nft_trusts: UnorderedMap::new(b"nft".to_vec()),
        }
    }

    pub fn receive_transfer(
        &mut self,
        request_id: String,
        key: String,
        kind: u8,
        account_id: ValidAccountId,
    ) {
        let key_b = bs58::decode(key).into_vec().unwrap();
        let request_id_b = bs58::decode(request_id.clone()).into_vec().unwrap();
        assert_eq!(sha256(key_b.as_ref()), request_id_b, "Incorrect key");

        match kind {
            1=> {
                let nt = self.near_trusts.get(&request_id).unwrap();
                Promise::new(account_id.clone().to_string()).transfer(nt.amount);
                self.near_trusts.remove(&request_id);
            },
            2=> {
                let nft = self.nft_trusts.get(&request_id).unwrap();

                env::log(format!("Send NFT {}", nft.nft_token_id).as_bytes());
                nft_contract::nft_transfer(
                    account_id.clone().to_string(),
                    nft.nft_token_id,
                    &nft.nft_contract_id,
                    1,
                    GAS,
                );
                self.nft_trusts.remove(&request_id);
            },
            3=>{
                let ft = self.ft_trusts.get(&request_id).unwrap();

                env::log(format!("Send FT {}", ft.ft_contract_id).as_bytes());
                ft_contract::ft_transfer(
                    account_id.clone().to_string(),
                    U128(ft.ft_amount),
                    &ft.ft_contract_id,
                    1,
                    GAS,
                );
                self.ft_trusts.remove(&request_id);

            },
            _ => panic!()
        }
    }

    #[payable]
    pub fn send_near(&mut self, request_id: String) {
        self.near_trusts.insert(&request_id, &NearTrustTransaction {
            from_account_id: env::predecessor_account_id(),
            amount: env::attached_deposit(),
        });
    }

    pub fn nft_on_transfer(
        &mut self,
        sender_id: String,
        previous_owner_id: String,
        token_id: String,
        msg: String,
    ) -> bool {
        env::log(format!("Send NFT {} from {}", &token_id, &previous_owner_id).as_bytes());
            self.nft_trusts.insert(&msg, &NftTrustTransaction {
                from_account_id: previous_owner_id,
                nft_contract_id: env::predecessor_account_id(),
                nft_token_id: token_id,
            });
        false
    }

    pub fn ft_on_transfer(&mut self, sender_id: String, amount: U128, msg: String) -> U128 {
        env::log(
            format!(
                "Send FT {} from {}",
                &env::predecessor_account_id(),
                &sender_id
            )
            .as_bytes(),
        );
        self.ft_trusts.insert(&msg, &FtTrustTransaction {
            from_account_id: sender_id,
            ft_contract_id: env::predecessor_account_id(),
            ft_amount: amount.into(),
        });
        U128(0)
    }

    pub fn get_request(&self, request_id: String) -> Option<NearTrustTransaction> {
        self.near_trusts.get(&request_id)
    }

    pub fn get_ft_transfers(&self, request_id: String) -> Option<FtTrustTransaction> {
        self.ft_trusts.get(&request_id)
    }

    pub fn get_nft_transfers(&self, request_id: String) -> Option<NftTrustTransaction> {
        self.nft_trusts.get(&request_id)
    }
}

'''
'''--- test.sh ---

near call l.herewallet.testnet send_near '{"request_id":"HugsAPcjSdRRQJp2vfcKns7VTh244nE3RMPvAnNxFxam"}' --gas 242794783120800 --accountId petr4.testnet --deposit 0.1

near call l.herewallet.testnet receive_transfer '{"phone":"test3"}' --gas 242794783120800 --accountId petr4.testnet
near call l.herewallet.testnet allocate_phone '{"phone":"test3", "account_id":"petr4.testnet"}' --gas 242794783120800 --accountId herewallet.testnet --depositYocto 1

NEAR_ENV=mainnet near call l.herewallet.near receive_transfer '{"request_id":"BYdMhfekq4gW6mafbYd4Tr19FL3hLaoxZHmVXto2RXWK", "key":"C9s5FbaqTGxptYpUYxa4kR", "kind":1, "account_id":"mydev.near"}' --gas 242794783120800 --accountId mydev.near 

'''