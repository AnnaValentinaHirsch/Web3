*GitHub Repository "mikedotexe/near-debug-rust-u128"*

'''--- Cargo.toml ---
[package]
name = "debug-u128"
version = "0.1.0"
authors = ["Near Inc <hello@nearprotocol.com>"]
edition = "2018"

[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0.45"
near-sdk = "0.9.2"
borsh = "0.6.1"
wee_alloc = "0.4.5"

[profile.release]
codegen-units = 1
# Tell `rustc` to optimize for small code size.
opt-level = "z"
lto = true
debug = false
panic = "abort"

[workspace]
members = []

'''
'''--- README.md ---
There seems to be an issue with u128.
Note the last three numbers change from 700 to 800 for no apparent reason.
This doesn't happen in the tests. (`./test.sh`)

Try:
`near view debug.mike.testnet small_u '{"val": 1906293427246306700}'`

and

`near view debug.mike.testnet big_u '{"val": "1906293427246306700"}'`
'''
'''--- build.sh ---
#!/bin/bash
set -e

RUSTFLAGS='-C link-arg=-s' cargo build --target wasm32-unknown-unknown --release
cp target/wasm32-unknown-unknown/release/debug_u128.wasm ./res/

'''
'''--- src/lib.rs ---
use borsh::{BorshDeserialize, BorshSerialize};
use near_sdk::json_types::U128; // eventually we may use this for expiration
use near_sdk::{env, near_bindgen};
use borsh::schema::Definition::Tuple;

#[global_allocator]
static ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;

#[near_bindgen]
#[derive(BorshDeserialize, BorshSerialize)]
pub struct DebugU128 {}

impl Default for DebugU128 {
    fn default() -> Self {
        Self {}
    }
}

#[near_bindgen]
impl DebugU128 {
    pub fn small_u(&self, val: u128) -> (u128, Vec<u8>) {
        env::log(format!("(u128) I received: {}", val).as_bytes());
        (val, env::keccak256(format!("{}", val).as_bytes()))
    }

    pub fn big_u(&self, val: U128) -> (U128, Vec<u8>) {
        env::log(format!("(U128) I received: {:?}", val).as_bytes());
        let regular_num: u128 = val.into();
        env::log(format!("(U128 Â» u128) I turned this into: {}", regular_num).as_bytes());
        // env::keccak256(&regular_num.into())
        (val, env::keccak256(format!("{}", regular_num).as_bytes()))
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use near_sdk::{MockedBlockchain};
    use near_sdk::{AccountId, testing_env, VMContext};

    fn alice() -> AccountId { "alice_near".to_string() }

    fn get_context() -> VMContext {
        VMContext {
            current_account_id: alice(),
            signer_account_id: alice(),
            signer_account_pk: vec![0, 1, 2],
            predecessor_account_id: alice(),
            input: vec![],
            block_index: 0,
            block_timestamp: 0,
            epoch_height: 0,
            account_balance: 0,
            account_locked_balance: 0,
            storage_usage: 300,
            attached_deposit: 0,
            prepaid_gas: 10u64.pow(18),
            random_seed: vec![0, 1, 2],
            is_view: true,
            output_data_receivers: vec![],
        }
    }

    #[test]
    fn call_small_u() {
        let context = get_context();
        testing_env!(context);
        let contract = DebugU128::default();

        let num: u128 = 1906293427246306700;
        let tuple = contract.small_u(num.clone());
        let returned_keccak = tuple.1;

        // keccak in test
        let test_keccak = env::keccak256(format!("{}", num).as_bytes());

        assert_eq!(returned_keccak, test_keccak);
        assert_eq!(tuple.0, num);
        println!("Same number back: {:?}", tuple.0);
        println!("Test keccak: {:?}", test_keccak);
    }

    #[test]
    fn call_big_u() {
        let context = get_context();
        testing_env!(context);
        let contract = DebugU128::default();

        let num: U128 = 1906293427246306700u128.into();
        let tuple = contract.big_u(num.clone());
        let returned_keccak = tuple.1;

        // keccak in test
        let regular_num: u128 = num.into();
        let test_keccak = env::keccak256(format!("{}", regular_num).as_bytes());

        assert_eq!(returned_keccak, test_keccak);
        assert_eq!(tuple.0, num);
        println!("Same number back: {:?}", tuple.0);
        println!("{:?}", test_keccak);
    }
}
'''
'''--- test.sh ---
cargo test -- --nocapture

'''