*GitHub Repository "idos-network/idos-access-grants"*

'''--- README.md ---
# idOS access grant contracts

![EVM](https://img.shields.io/badge/EVM-gray?logo=ethereum) ![NEAR](https://img.shields.io/badge/NEAR%20VM-gray?logo=near) ![License](https://img.shields.io/badge/license-MIT-blue?&logo=data:image/svg%2bxml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NHB4IiBoZWlnaHQ9IjY0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRkZGRkZGIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGcgaWQ9IlNWR1JlcG9fYmdDYXJyaWVyIiBzdHJva2Utd2lkdGg9IjAiPjwvZz48ZyBpZD0iU1ZHUmVwb190cmFjZXJDYXJyaWVyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjwvZz48ZyBpZD0iU1ZHUmVwb19pY29uQ2FycmllciI+IDxwYXRoIGQ9Ik0xNiAxNmwzLTggMy4wMDEgOEE1LjAwMiA1LjAwMiAwIDAxMTYgMTZ6Ij48L3BhdGg+IDxwYXRoIGQ9Ik0yIDE2bDMtOCAzLjAwMSA4QTUuMDAyIDUuMDAyIDAgMDEyIDE2eiI+PC9wYXRoPiA8cGF0aCBkPSJNNyAyMWgxMCI+PC9wYXRoPiA8cGF0aCBkPSJNMTIgM3YxOCI+PC9wYXRoPiA8cGF0aCBkPSJNMyA3aDJjMiAwIDUtMSA3LTIgMiAxIDUgMiA3IDJoMiI+PC9wYXRoPiA8L2c+PC9zdmc+Cg==)

When receiving a signed request for data not owned by the signer, idOS nodes use these smart contracts as the source of truth for authorizing (or denying) the request.

The contract functionality is straightforward:

- **a grant** is an idOS object representing a data access grant from an owner to a grantee for a given data ID (optionally with a timelock)
- the contract **stores a collection of grants**
- **anyone** can **list grants**
- a **signer** can
    - **create a grant** that they own
    - **delete a grant** that they own (unless timelocked)

## Contracts

**Implementations:**

| Target VM | Language | Source |
| :- | :- | :- |
| EVM | Solidity | [`evm/`](./evm) |
| NEAR VM | Rust | [`near-rs/`](./near-rs) |

**Deployments:**

| Source | Chain | Address |
| :- | :- | :- |
| `evm/` | Sepolia | [`0x73de8f45c0dFDf59C56a93B483246AC113a1f922`](https://sepolia.etherscan.io/address/0x73de8f45c0dFDf59C56a93B483246AC113a1f922#code) |
| `evm/` | Arbitrum Sepolia | [`0x7D11563Bd4aA096CC83Fbe2cdd0557010dd58477`](https://sepolia.arbiscan.io/address/0x7D11563Bd4aA096CC83Fbe2cdd0557010dd58477#code) |
| `evm/` | Arbitrum One | [`0x7D11563Bd4aA096CC83Fbe2cdd0557010dd58477`](https://arbiscan.io/address/0x7D11563Bd4aA096CC83Fbe2cdd0557010dd58477#code) |
| `near-rs/` | NEAR Testnet | [`idos-dev-4.testnet`](https://explorer.testnet.near.org/accounts/idos-dev-4.testnet) |
| `near-rs/` | NEAR Mainnet | [`idos-dev-4.near`](https://explorer.mainnet.near.org/accounts/idos-dev-4.near) |

### Deploy to Sepolia

1. Copy `.env` file to `.env.local` and fill it in accordingly
1. Run `npx hardhat --network sepolia run scripts/deploy.js`
1. Run `npx hardhat --network sepolia verify $RESULTING_ADDRESS`

### Deploy to local chain

Use [hardhat](https://hardhat.org/) to run local node.
1. Run node in separate process `npx hardhat node`
1. Compile a contract `npx hardhat compile`
1. Deploy the contract `npx hardhat --network locahost run scripts/deploy.js`

## Interface

> [!NOTE]
> This interface description uses mixedCase, but each implementation follows the respective language's style guide, e.g.:
> * in EVM + Solidity, we use mixedCase (`insertGrant`)
> * in NEAR VM + Rust/TypeScript, we use snake_case (`insert_grant`).

### Objects

<details><summary><h4><code>Grant</code></h4></summary>

Represents an access grant from a data owner, to a grantee, for a given data ID, until a given time.

**Variables**
- `owner`: address
- `grantee`: address
- `dataId`: string
- `lockedUntil`: 256-bit unsigned integer

</details>

### Functions

<details><summary><h4><code>insertGrant</code></h4></summary>

Creates a new access grant.

**Arguments**

- required
  - `grantee`: address
  - `dataId`: string
- optional
  - `lockedUntil`: 256-bit unsigned integer

**Implements**

- creates `Grant(signer, grantee, dataId, lockedUntil)`
- reverts if this grant already exists

</details>

<details><summary><h4><code>deleteGrant</code></h4></summary>

Deletes an existing access grant.

**Arguments**

- required
  - `grantee`: address
  - `dataId`: string
- optional
  - `lockedUntil`: 256-bit unsigned integer

**Implements**

- if given `lockedUntil`
    - deletes `Grant(signer, grantee, dataId, lockedUntil)`
    - reverts if `lockedUntil` is in the future
- else
    - deletes all `Grant(signer, grantee, dataId, *)`
    - reverts if any `lockedUntil` is in the future

</details>

<details><summary><h4><code>findGrants</code></h4></summary>

Lists grants matching the provided arguments.

**Arguments**

- required (both or either)
  - `owner`: address
  - `grantee`: address
- optional
  - `dataId`: string

**Implements**

Performs a wildcard search, matching existing grants to given arguments, which must follow one of these patterns:

```
{ owner, grantee, dataId }
{ owner, grantee, ****** }
{ owner, *******, dataId }
{ owner, *******, ****** }
{ *****, grantee, dataId }
{ *****, grantee, ****** }
```

**Returns**

A list of 0+ `Grant`s

</details>

<details><summary><h4><code>grantsFor</code></h4></summary>

Lists grants matching the provided arguments.

**Arguments**

- required
  - `grantee`: address
  - `dataId`: string

**Implements**

Calls `grantsBy` with no `owner` argument.

**Returns**

A list of 0+ `Grant`s

</details>

'''
'''--- evm/.env ---
PRIVATE_KEY=
SEPOLIA_NODE_URL=
SEPOLIA_ETHERSCAN_API_KEY=
ARBITRUM_ETHERSCAN_API_KEY=
ARBITRUM_SEPOLIA_NODE_URL=
ARBITRUM_ONE_NODE_URL=

'''
'''--- evm/README.md ---
# EVM

> [!NOTE]
> You can find the contract's ABI in [this compilation artifact](artifacts/contracts/AccessGrants.sol/AccessGrants.json#L5).

## Testing

```
$ yarn test
```

## Local deployment

First, start a [local Hardhat node](https://hardhat.org/hardhat-runner/docs/getting-started#connecting-a-wallet-or-dapp-to-hardhat-network) on a terminal.

```
$ npx hardhat node

Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/
...
```

On another terminal, run the deployment script.

```
$ npx hardhat run --network localhost scripts/deploy.js

AccessGrants deployed to 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

You can then use the [Hardhat console](https://hardhat.org/hardhat-runner/docs/guides/hardhat-console) to interact with the locally deployed contract. Make sure to use the address you deployed to.

```
$ npx hardhat console --network localhost

> const accessGrants = await ethers.getContractAt("AccessGrants", "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0");

> await accessGrants.findGrants("0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0", "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0", "no");
Result(0) []
...
```

'''
'''--- evm/artifacts/contracts/AccessGrants.sol/AccessGrants.json ---
{
  "_format": "hh-sol-artifact-1",
  "contractName": "AccessGrants",
  "sourceName": "contracts/AccessGrants.sol",
  "abi": [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "lockedUntil",
          "type": "uint256"
        }
      ],
      "name": "GrantAdded",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "lockedUntil",
          "type": "uint256"
        }
      ],
      "name": "GrantDeleted",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "lockedUntil",
          "type": "uint256"
        }
      ],
      "name": "deleteGrant",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "lockedUntil",
          "type": "uint256"
        },
        {
          "internalType": "bytes",
          "name": "signature",
          "type": "bytes"
        }
      ],
      "name": "deleteGrantBySignature",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "lockedUntil",
          "type": "uint256"
        }
      ],
      "name": "deleteGrantBySignatureMessage",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "pure",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        }
      ],
      "name": "findGrants",
      "outputs": [
        {
          "components": [
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "grantee",
              "type": "address"
            },
            {
              "internalType": "string",
              "name": "dataId",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "lockedUntil",
              "type": "uint256"
            }
          ],
          "internalType": "struct AccessGrants.Grant[]",
          "name": "",
          "type": "tuple[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        }
      ],
      "name": "grantsFor",
      "outputs": [
        {
          "components": [
            {
              "internalType": "address",
              "name": "owner",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "grantee",
              "type": "address"
            },
            {
              "internalType": "string",
              "name": "dataId",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "lockedUntil",
              "type": "uint256"
            }
          ],
          "internalType": "struct AccessGrants.Grant[]",
          "name": "",
          "type": "tuple[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "lockedUntil",
          "type": "uint256"
        }
      ],
      "name": "insertGrant",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "lockedUntil",
          "type": "uint256"
        },
        {
          "internalType": "bytes",
          "name": "signature",
          "type": "bytes"
        }
      ],
      "name": "insertGrantBySignature",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "grantee",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "dataId",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "lockedUntil",
          "type": "uint256"
        }
      ],
      "name": "insertGrantBySignatureMessage",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "pure",
      "type": "function"
    }
  ],
  "bytecode": "0x608060405234801561001057600080fd5b50611ea5806100206000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063b14d52d51161005b578063b14d52d5146100fe578063b25875b914610111578063b7dd886514610124578063c28c65241461013757600080fd5b8063236c70621461008d5780632ae12052146100b65780634ba0b062146100c95780637e0cc3a2146100de575b600080fd5b6100a061009b3660046115cc565b61014a565b6040516100ad9190611685565b60405180910390f35b6100a06100c43660046115cc565b610197565b6100dc6100d7366004611698565b6101ca565b005b6100f16100ec3660046117d6565b610286565b6040516100ad9190611834565b6100dc61010c3660046118cd565b6106e1565b6100dc61011f366004611698565b6106f4565b6100f1610132366004611927565b610797565b6100dc610145366004611975565b6107ae565b6060610155866107bf565b61015e866107bf565b8585610169866107d5565b60405160200161017d9594939291906119f7565b604051602081830303815290604052905095945050505050565b60606101a2866107bf565b6101ab866107bf565b85856101b6866107d5565b60405160200161017d959493929190611b19565b61021f876101e36101de8a8a8a8a8a610197565b610875565b84848080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506108b092505050565b6102705760405162461bcd60e51b815260206004820152601760248201527f5369676e617475726520646f65736e2774206d6174636800000000000000000060448201526064015b60405180910390fd5b61027d8787878787610911565b50505050505050565b60608060006001600160a01b038616156102e6576001600160a01b03861660009081526001602052604090206102bb90610b58565b6001600160a01b03871660009081526001602052604090209092506102df90610b6c565b90506103a8565b6001600160a01b0385161561033a576001600160a01b038516600090815260026020526040902061031690610b58565b6001600160a01b03861660009081526002602052604090209092506102df90610b6c565b60405162461bcd60e51b815260206004820152602b60248201527f526571756972656420617267756d656e743a20606f776e65726020616e642f6f60448201527f7220606772616e746565600000000000000000000000000000000000000000006064820152608401610267565b6000808267ffffffffffffffff8111156103c4576103c4611733565b6040519080825280602002602001820160405280156103ed578160200160208202803683370190505b50905060005b838110156104e657600085828151811061040f5761040f611b6c565b602002602001015190506000806001600160a01b03168a6001600160a01b0316148061045857506001600160a01b038a1660009081526002602052604090206104589083610b76565b8015610497575061046889610b8e565b8061049757506104978260038b6040516104829190611b82565b90815260405190819003602001902090610b76565b905080156104d157846104a981611bb4565b95505060018484815181106104c0576104c0611b6c565b911515602092830291909101909101525b505080806104de90611bb4565b9150506103f3565b5060008267ffffffffffffffff81111561050257610502611733565b60405190808252806020026020018201604052801561057057816020015b61055d604051806080016040528060006001600160a01b0316815260200160006001600160a01b0316815260200160608152602001600081525090565b8152602001906001900390816105205790505b5090506000805b858110156106d25783818151811061059157610591611b6c565b6020026020010151156106c0576000808883815181106105b3576105b3611b6c565b6020908102919091018101518252818101929092526040908101600020815160808101835281546001600160a01b03908116825260018301541693810193909352600281018054919284019161060890611bcd565b80601f016020809104026020016040519081016040528092919081815260200182805461063490611bcd565b80156106815780601f1061065657610100808354040283529160200191610681565b820191906000526020600020905b81548152906001019060200180831161066457829003601f168201915b505050505081526020016003820154815250508383815181106106a6576106a6611b6c565b602002602001018190525081806106bc90611bb4565b9250505b806106ca81611bb4565b915050610577565b50909998505050505050505050565b6106ee3385858585610911565b50505050565b610708876101e36101de8a8a8a8a8a61014a565b6107545760405162461bcd60e51b815260206004820152601760248201527f5369676e617475726520646f65736e2774206d617463680000000000000000006044820152606401610267565b61027d878787878080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250899250610be6915050565b60606107a560008484610286565b90505b92915050565b6107ba33848484610be6565b505050565b60606107a86001600160a01b0383166014610e57565b606060006107e28361101c565b600101905060008167ffffffffffffffff81111561080257610802611733565b6040519080825280601f01601f19166020018201604052801561082c576020820181803683370190505b5090508181016020015b600019017f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a850494508461083657509392505050565b600061088182516107d5565b82604051602001610893929190611c07565b604051602081830303815290604052805190602001209050919050565b60008060006108bf85856110fe565b909250905060008160048111156108d8576108d8611c62565b1480156108f65750856001600160a01b0316826001600160a01b0316145b806109075750610907868686611143565b9695505050505050565b60006040518060800160405280876001600160a01b03168152602001866001600160a01b0316815260200185858080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920182905250938552505050602090910184905290915061098882611275565b6000818152602081905260409020549091506001600160a01b0316156109f05760405162461bcd60e51b815260206004820152601460248201527f4772616e7420616c7265616479206578697374730000000000000000000000006044820152606401610267565b600081815260208181526040918290208451815473ffffffffffffffffffffffffffffffffffffffff199081166001600160a01b0392831617835592860151600183018054909416911617909155908301518391906002820190610a549082611cbe565b506060919091015160039091015581516001600160a01b03166000908152600160205260409020610a85908261129e565b506020808301516001600160a01b03166000908152600290915260409020610aad908261129e565b50610adb8160038460400151604051610ac69190611b82565b9081526040519081900360200190209061129e565b508160400151604051610aee9190611b82565b604051809103902082602001516001600160a01b031683600001516001600160a01b03167faa11b1607ce40799434b358e476f60277b9c8879ca956534f8f185a8b7e227a78560600151604051610b4791815260200190565b60405180910390a450505050505050565b60606000610b65836112aa565b9392505050565b60006107a8825490565b600081815260018301602052604081205415156107a5565b604051600360fc1b60208201526000906021016040516020818303038152906040528051906020012082604051602001610bc89190611b82565b60405160208183030381529060405280519060200120149050919050565b6000610bf3858585610286565b90506000815111610c465760405162461bcd60e51b815260206004820152601360248201527f4e6f206772616e747320666f72206f776e6572000000000000000000000000006044820152606401610267565b60005b8151811015610e4f576000828281518110610c6657610c66611b6c565b602002602001015190508360001480610c9b575083838381518110610c8d57610c8d611b6c565b602002602001015160600151145b15610e3c5742816060015110610cf35760405162461bcd60e51b815260206004820152601360248201527f4772616e742069732074696d656c6f636b6564000000000000000000000000006044820152606401610267565b6000610cfe82611275565b6000818152602081905260408120805473ffffffffffffffffffffffffffffffffffffffff1990811682556001820180549091169055919250610d446002830182611518565b50600060039190910181905582516001600160a01b03168152600160205260409020610d709082611306565b506020808301516001600160a01b03166000908152600290915260409020610d989082611306565b50610dc68160038460400151604051610db19190611b82565b90815260405190819003602001902090611306565b508160400151604051610dd99190611b82565b604051809103902082602001516001600160a01b031683600001516001600160a01b03167ffeff9850709af031b875a6b4bea72ef38f7679e252a8aeecd4d176225b1ee3238560600151604051610e3291815260200190565b60405180910390a4505b5080610e4781611bb4565b915050610c49565b505050505050565b60606000610e66836002611d7e565b610e71906002611d95565b67ffffffffffffffff811115610e8957610e89611733565b6040519080825280601f01601f191660200182016040528015610eb3576020820181803683370190505b509050600360fc1b81600081518110610ece57610ece611b6c565b60200101906001600160f81b031916908160001a9053507f780000000000000000000000000000000000000000000000000000000000000081600181518110610f1957610f19611b6c565b60200101906001600160f81b031916908160001a9053506000610f3d846002611d7e565b610f48906001611d95565b90505b6001811115610fcd577f303132333435363738396162636465660000000000000000000000000000000085600f1660108110610f8957610f89611b6c565b1a60f81b828281518110610f9f57610f9f611b6c565b60200101906001600160f81b031916908160001a90535060049490941c93610fc681611da8565b9050610f4b565b5083156107a55760405162461bcd60e51b815260206004820181905260248201527f537472696e67733a20686578206c656e67746820696e73756666696369656e746044820152606401610267565b6000807a184f03e93ff9f4daa797ed6e38ed64bf6a1f0100000000000000008310611065577a184f03e93ff9f4daa797ed6e38ed64bf6a1f010000000000000000830492506040015b6d04ee2d6d415b85acef81000000008310611091576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc1000083106110af57662386f26fc10000830492506010015b6305f5e10083106110c7576305f5e100830492506008015b61271083106110db57612710830492506004015b606483106110ed576064830492506002015b600a83106107a85760010192915050565b60008082516041036111345760208301516040840151606085015160001a61112887828585611312565b9450945050505061113c565b506000905060025b9250929050565b6000806000856001600160a01b0316631626ba7e60e01b868660405160240161116d929190611dbf565b60408051601f198184030181529181526020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff000000000000000000000000000000000000000000000000000000009094169390931790925290516111d89190611b82565b600060405180830381855afa9150503d8060008114611213576040519150601f19603f3d011682016040523d82523d6000602084013e611218565b606091505b509150915081801561122c57506020815110155b8015610907575080517f1626ba7e000000000000000000000000000000000000000000000000000000009061126a9083016020908101908401611de0565b149695505050505050565b600081600001518260200151836040015184606001516040516020016108939493929190611df9565b60006107a583836113d6565b6060816000018054806020026020016040519081016040528092919081815260200182805480156112fa57602002820191906000526020600020905b8154815260200190600101908083116112e6575b50505050509050919050565b60006107a58383611425565b6000807f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a083111561134957506000905060036113cd565b6040805160008082526020820180845289905260ff881692820192909252606081018690526080810185905260019060a0016020604051602081039080840390855afa15801561139d573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b0381166113c6576000600192509250506113cd565b9150600090505b94509492505050565b600081815260018301602052604081205461141d575081546001818101845560008481526020808220909301849055845484825282860190935260409020919091556107a8565b5060006107a8565b6000818152600183016020526040812054801561150e576000611449600183611e46565b855490915060009061145d90600190611e46565b90508181146114c257600086600001828154811061147d5761147d611b6c565b90600052602060002001549050808760000184815481106114a0576114a0611b6c565b6000918252602080832090910192909255918252600188019052604090208390555b85548690806114d3576114d3611e59565b6001900381819060005260206000200160009055905585600101600086815260200190815260200160002060009055600193505050506107a8565b60009150506107a8565b50805461152490611bcd565b6000825580601f10611534575050565b601f0160209004906000526020600020908101906115529190611555565b50565b5b8082111561156a5760008155600101611556565b5090565b80356001600160a01b038116811461158557600080fd5b919050565b60008083601f84011261159c57600080fd5b50813567ffffffffffffffff8111156115b457600080fd5b60208301915083602082850101111561113c57600080fd5b6000806000806000608086880312156115e457600080fd5b6115ed8661156e565b94506115fb6020870161156e565b9350604086013567ffffffffffffffff81111561161757600080fd5b6116238882890161158a565b96999598509660600135949350505050565b60005b83811015611650578181015183820152602001611638565b50506000910152565b60008151808452611671816020860160208601611635565b601f01601f19169290920160200192915050565b6020815260006107a56020830184611659565b600080600080600080600060a0888a0312156116b357600080fd5b6116bc8861156e565b96506116ca6020890161156e565b9550604088013567ffffffffffffffff808211156116e757600080fd5b6116f38b838c0161158a565b909750955060608a0135945060808a013591508082111561171357600080fd5b506117208a828b0161158a565b989b979a50959850939692959293505050565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261175a57600080fd5b813567ffffffffffffffff8082111561177557611775611733565b604051601f8301601f19908116603f0116810190828211818310171561179d5761179d611733565b816040528381528660208588010111156117b657600080fd5b836020870160208301376000602085830101528094505050505092915050565b6000806000606084860312156117eb57600080fd5b6117f48461156e565b92506118026020850161156e565b9150604084013567ffffffffffffffff81111561181e57600080fd5b61182a86828701611749565b9150509250925092565b60006020808301818452808551808352604092508286019150828160051b87010184880160005b838110156118bf57603f19898403018552815160806001600160a01b03808351168652808a840151168a8701525087820151818987015261189e82870182611659565b6060938401519690930195909552509487019492509086019060010161185b565b509098975050505050505050565b600080600080606085870312156118e357600080fd5b6118ec8561156e565b9350602085013567ffffffffffffffff81111561190857600080fd5b6119148782880161158a565b9598909750949560400135949350505050565b6000806040838503121561193a57600080fd5b6119438361156e565b9150602083013567ffffffffffffffff81111561195f57600080fd5b61196b85828601611749565b9150509250929050565b60008060006060848603121561198a57600080fd5b6119938461156e565b9250602084013567ffffffffffffffff8111156119af57600080fd5b6119bb86828701611749565b925050604084013590509250925092565b600081516119de818560208601611635565b9290920192915050565b81818437506000910190815290565b7f6f7065726174696f6e3a2064656c6574654772616e740000000000000000000081526000600560f91b80601684015266037bbb732b91d160cd1b60178401528751611a4a81601e860160208c01611635565b808401905081601e8201527f6772616e7465653a200000000000000000000000000000000000000000000000601f8201528751611a8e816028840160208c01611635565b01602881018290527f6461746149643a200000000000000000000000000000000000000000000000006029820152611aca6031820187896119e8565b915050611ada81600560f91b9052565b7f6c6f636b6564556e74696c3a20000000000000000000000000000000000000006001820152611b0d600e8201856119cc565b98975050505050505050565b7f6f7065726174696f6e3a20696e736572744772616e740000000000000000000081526000600560f91b80601684015266037bbb732b91d160cd1b60178401528751611a4a81601e860160208c01611635565b634e487b7160e01b600052603260045260246000fd5b60008251611b94818460208701611635565b9190910192915050565b634e487b7160e01b600052601160045260246000fd5b600060018201611bc657611bc6611b9e565b5060010190565b600181811c90821680611be157607f821691505b602082108103611c0157634e487b7160e01b600052602260045260246000fd5b50919050565b7f19457468657265756d205369676e6564204d6573736167653a0a000000000000815260008351611c3f81601a850160208801611635565b835190830190611c5681601a840160208801611635565b01601a01949350505050565b634e487b7160e01b600052602160045260246000fd5b601f8211156107ba57600081815260208120601f850160051c81016020861015611c9f5750805b601f850160051c820191505b81811015610e4f57828155600101611cab565b815167ffffffffffffffff811115611cd857611cd8611733565b611cec81611ce68454611bcd565b84611c78565b602080601f831160018114611d215760008415611d095750858301515b600019600386901b1c1916600185901b178555610e4f565b600085815260208120601f198616915b82811015611d5057888601518255948401946001909101908401611d31565b5085821015611d6e5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b80820281158282048414176107a8576107a8611b9e565b808201808211156107a8576107a8611b9e565b600081611db757611db7611b9e565b506000190190565b828152604060208201526000611dd86040830184611659565b949350505050565b600060208284031215611df257600080fd5b5051919050565b60006bffffffffffffffffffffffff19808760601b168352808660601b166014840152508351611e30816028850160208801611635565b6028920191820192909252604801949350505050565b818103818111156107a8576107a8611b9e565b634e487b7160e01b600052603160045260246000fdfea2646970667358221220222c5af3c9ba30e97583ec498a62cafc8eeafaf8586945476f62ac90a608261a64736f6c63430008130033",
  "deployedBytecode": "0x608060405234801561001057600080fd5b50600436106100885760003560e01c8063b14d52d51161005b578063b14d52d5146100fe578063b25875b914610111578063b7dd886514610124578063c28c65241461013757600080fd5b8063236c70621461008d5780632ae12052146100b65780634ba0b062146100c95780637e0cc3a2146100de575b600080fd5b6100a061009b3660046115cc565b61014a565b6040516100ad9190611685565b60405180910390f35b6100a06100c43660046115cc565b610197565b6100dc6100d7366004611698565b6101ca565b005b6100f16100ec3660046117d6565b610286565b6040516100ad9190611834565b6100dc61010c3660046118cd565b6106e1565b6100dc61011f366004611698565b6106f4565b6100f1610132366004611927565b610797565b6100dc610145366004611975565b6107ae565b6060610155866107bf565b61015e866107bf565b8585610169866107d5565b60405160200161017d9594939291906119f7565b604051602081830303815290604052905095945050505050565b60606101a2866107bf565b6101ab866107bf565b85856101b6866107d5565b60405160200161017d959493929190611b19565b61021f876101e36101de8a8a8a8a8a610197565b610875565b84848080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506108b092505050565b6102705760405162461bcd60e51b815260206004820152601760248201527f5369676e617475726520646f65736e2774206d6174636800000000000000000060448201526064015b60405180910390fd5b61027d8787878787610911565b50505050505050565b60608060006001600160a01b038616156102e6576001600160a01b03861660009081526001602052604090206102bb90610b58565b6001600160a01b03871660009081526001602052604090209092506102df90610b6c565b90506103a8565b6001600160a01b0385161561033a576001600160a01b038516600090815260026020526040902061031690610b58565b6001600160a01b03861660009081526002602052604090209092506102df90610b6c565b60405162461bcd60e51b815260206004820152602b60248201527f526571756972656420617267756d656e743a20606f776e65726020616e642f6f60448201527f7220606772616e746565600000000000000000000000000000000000000000006064820152608401610267565b6000808267ffffffffffffffff8111156103c4576103c4611733565b6040519080825280602002602001820160405280156103ed578160200160208202803683370190505b50905060005b838110156104e657600085828151811061040f5761040f611b6c565b602002602001015190506000806001600160a01b03168a6001600160a01b0316148061045857506001600160a01b038a1660009081526002602052604090206104589083610b76565b8015610497575061046889610b8e565b8061049757506104978260038b6040516104829190611b82565b90815260405190819003602001902090610b76565b905080156104d157846104a981611bb4565b95505060018484815181106104c0576104c0611b6c565b911515602092830291909101909101525b505080806104de90611bb4565b9150506103f3565b5060008267ffffffffffffffff81111561050257610502611733565b60405190808252806020026020018201604052801561057057816020015b61055d604051806080016040528060006001600160a01b0316815260200160006001600160a01b0316815260200160608152602001600081525090565b8152602001906001900390816105205790505b5090506000805b858110156106d25783818151811061059157610591611b6c565b6020026020010151156106c0576000808883815181106105b3576105b3611b6c565b6020908102919091018101518252818101929092526040908101600020815160808101835281546001600160a01b03908116825260018301541693810193909352600281018054919284019161060890611bcd565b80601f016020809104026020016040519081016040528092919081815260200182805461063490611bcd565b80156106815780601f1061065657610100808354040283529160200191610681565b820191906000526020600020905b81548152906001019060200180831161066457829003601f168201915b505050505081526020016003820154815250508383815181106106a6576106a6611b6c565b602002602001018190525081806106bc90611bb4565b9250505b806106ca81611bb4565b915050610577565b50909998505050505050505050565b6106ee3385858585610911565b50505050565b610708876101e36101de8a8a8a8a8a61014a565b6107545760405162461bcd60e51b815260206004820152601760248201527f5369676e617475726520646f65736e2774206d617463680000000000000000006044820152606401610267565b61027d878787878080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250899250610be6915050565b60606107a560008484610286565b90505b92915050565b6107ba33848484610be6565b505050565b60606107a86001600160a01b0383166014610e57565b606060006107e28361101c565b600101905060008167ffffffffffffffff81111561080257610802611733565b6040519080825280601f01601f19166020018201604052801561082c576020820181803683370190505b5090508181016020015b600019017f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a850494508461083657509392505050565b600061088182516107d5565b82604051602001610893929190611c07565b604051602081830303815290604052805190602001209050919050565b60008060006108bf85856110fe565b909250905060008160048111156108d8576108d8611c62565b1480156108f65750856001600160a01b0316826001600160a01b0316145b806109075750610907868686611143565b9695505050505050565b60006040518060800160405280876001600160a01b03168152602001866001600160a01b0316815260200185858080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920182905250938552505050602090910184905290915061098882611275565b6000818152602081905260409020549091506001600160a01b0316156109f05760405162461bcd60e51b815260206004820152601460248201527f4772616e7420616c7265616479206578697374730000000000000000000000006044820152606401610267565b600081815260208181526040918290208451815473ffffffffffffffffffffffffffffffffffffffff199081166001600160a01b0392831617835592860151600183018054909416911617909155908301518391906002820190610a549082611cbe565b506060919091015160039091015581516001600160a01b03166000908152600160205260409020610a85908261129e565b506020808301516001600160a01b03166000908152600290915260409020610aad908261129e565b50610adb8160038460400151604051610ac69190611b82565b9081526040519081900360200190209061129e565b508160400151604051610aee9190611b82565b604051809103902082602001516001600160a01b031683600001516001600160a01b03167faa11b1607ce40799434b358e476f60277b9c8879ca956534f8f185a8b7e227a78560600151604051610b4791815260200190565b60405180910390a450505050505050565b60606000610b65836112aa565b9392505050565b60006107a8825490565b600081815260018301602052604081205415156107a5565b604051600360fc1b60208201526000906021016040516020818303038152906040528051906020012082604051602001610bc89190611b82565b60405160208183030381529060405280519060200120149050919050565b6000610bf3858585610286565b90506000815111610c465760405162461bcd60e51b815260206004820152601360248201527f4e6f206772616e747320666f72206f776e6572000000000000000000000000006044820152606401610267565b60005b8151811015610e4f576000828281518110610c6657610c66611b6c565b602002602001015190508360001480610c9b575083838381518110610c8d57610c8d611b6c565b602002602001015160600151145b15610e3c5742816060015110610cf35760405162461bcd60e51b815260206004820152601360248201527f4772616e742069732074696d656c6f636b6564000000000000000000000000006044820152606401610267565b6000610cfe82611275565b6000818152602081905260408120805473ffffffffffffffffffffffffffffffffffffffff1990811682556001820180549091169055919250610d446002830182611518565b50600060039190910181905582516001600160a01b03168152600160205260409020610d709082611306565b506020808301516001600160a01b03166000908152600290915260409020610d989082611306565b50610dc68160038460400151604051610db19190611b82565b90815260405190819003602001902090611306565b508160400151604051610dd99190611b82565b604051809103902082602001516001600160a01b031683600001516001600160a01b03167ffeff9850709af031b875a6b4bea72ef38f7679e252a8aeecd4d176225b1ee3238560600151604051610e3291815260200190565b60405180910390a4505b5080610e4781611bb4565b915050610c49565b505050505050565b60606000610e66836002611d7e565b610e71906002611d95565b67ffffffffffffffff811115610e8957610e89611733565b6040519080825280601f01601f191660200182016040528015610eb3576020820181803683370190505b509050600360fc1b81600081518110610ece57610ece611b6c565b60200101906001600160f81b031916908160001a9053507f780000000000000000000000000000000000000000000000000000000000000081600181518110610f1957610f19611b6c565b60200101906001600160f81b031916908160001a9053506000610f3d846002611d7e565b610f48906001611d95565b90505b6001811115610fcd577f303132333435363738396162636465660000000000000000000000000000000085600f1660108110610f8957610f89611b6c565b1a60f81b828281518110610f9f57610f9f611b6c565b60200101906001600160f81b031916908160001a90535060049490941c93610fc681611da8565b9050610f4b565b5083156107a55760405162461bcd60e51b815260206004820181905260248201527f537472696e67733a20686578206c656e67746820696e73756666696369656e746044820152606401610267565b6000807a184f03e93ff9f4daa797ed6e38ed64bf6a1f0100000000000000008310611065577a184f03e93ff9f4daa797ed6e38ed64bf6a1f010000000000000000830492506040015b6d04ee2d6d415b85acef81000000008310611091576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc1000083106110af57662386f26fc10000830492506010015b6305f5e10083106110c7576305f5e100830492506008015b61271083106110db57612710830492506004015b606483106110ed576064830492506002015b600a83106107a85760010192915050565b60008082516041036111345760208301516040840151606085015160001a61112887828585611312565b9450945050505061113c565b506000905060025b9250929050565b6000806000856001600160a01b0316631626ba7e60e01b868660405160240161116d929190611dbf565b60408051601f198184030181529181526020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff000000000000000000000000000000000000000000000000000000009094169390931790925290516111d89190611b82565b600060405180830381855afa9150503d8060008114611213576040519150601f19603f3d011682016040523d82523d6000602084013e611218565b606091505b509150915081801561122c57506020815110155b8015610907575080517f1626ba7e000000000000000000000000000000000000000000000000000000009061126a9083016020908101908401611de0565b149695505050505050565b600081600001518260200151836040015184606001516040516020016108939493929190611df9565b60006107a583836113d6565b6060816000018054806020026020016040519081016040528092919081815260200182805480156112fa57602002820191906000526020600020905b8154815260200190600101908083116112e6575b50505050509050919050565b60006107a58383611425565b6000807f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a083111561134957506000905060036113cd565b6040805160008082526020820180845289905260ff881692820192909252606081018690526080810185905260019060a0016020604051602081039080840390855afa15801561139d573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b0381166113c6576000600192509250506113cd565b9150600090505b94509492505050565b600081815260018301602052604081205461141d575081546001818101845560008481526020808220909301849055845484825282860190935260409020919091556107a8565b5060006107a8565b6000818152600183016020526040812054801561150e576000611449600183611e46565b855490915060009061145d90600190611e46565b90508181146114c257600086600001828154811061147d5761147d611b6c565b90600052602060002001549050808760000184815481106114a0576114a0611b6c565b6000918252602080832090910192909255918252600188019052604090208390555b85548690806114d3576114d3611e59565b6001900381819060005260206000200160009055905585600101600086815260200190815260200160002060009055600193505050506107a8565b60009150506107a8565b50805461152490611bcd565b6000825580601f10611534575050565b601f0160209004906000526020600020908101906115529190611555565b50565b5b8082111561156a5760008155600101611556565b5090565b80356001600160a01b038116811461158557600080fd5b919050565b60008083601f84011261159c57600080fd5b50813567ffffffffffffffff8111156115b457600080fd5b60208301915083602082850101111561113c57600080fd5b6000806000806000608086880312156115e457600080fd5b6115ed8661156e565b94506115fb6020870161156e565b9350604086013567ffffffffffffffff81111561161757600080fd5b6116238882890161158a565b96999598509660600135949350505050565b60005b83811015611650578181015183820152602001611638565b50506000910152565b60008151808452611671816020860160208601611635565b601f01601f19169290920160200192915050565b6020815260006107a56020830184611659565b600080600080600080600060a0888a0312156116b357600080fd5b6116bc8861156e565b96506116ca6020890161156e565b9550604088013567ffffffffffffffff808211156116e757600080fd5b6116f38b838c0161158a565b909750955060608a0135945060808a013591508082111561171357600080fd5b506117208a828b0161158a565b989b979a50959850939692959293505050565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261175a57600080fd5b813567ffffffffffffffff8082111561177557611775611733565b604051601f8301601f19908116603f0116810190828211818310171561179d5761179d611733565b816040528381528660208588010111156117b657600080fd5b836020870160208301376000602085830101528094505050505092915050565b6000806000606084860312156117eb57600080fd5b6117f48461156e565b92506118026020850161156e565b9150604084013567ffffffffffffffff81111561181e57600080fd5b61182a86828701611749565b9150509250925092565b60006020808301818452808551808352604092508286019150828160051b87010184880160005b838110156118bf57603f19898403018552815160806001600160a01b03808351168652808a840151168a8701525087820151818987015261189e82870182611659565b6060938401519690930195909552509487019492509086019060010161185b565b509098975050505050505050565b600080600080606085870312156118e357600080fd5b6118ec8561156e565b9350602085013567ffffffffffffffff81111561190857600080fd5b6119148782880161158a565b9598909750949560400135949350505050565b6000806040838503121561193a57600080fd5b6119438361156e565b9150602083013567ffffffffffffffff81111561195f57600080fd5b61196b85828601611749565b9150509250929050565b60008060006060848603121561198a57600080fd5b6119938461156e565b9250602084013567ffffffffffffffff8111156119af57600080fd5b6119bb86828701611749565b925050604084013590509250925092565b600081516119de818560208601611635565b9290920192915050565b81818437506000910190815290565b7f6f7065726174696f6e3a2064656c6574654772616e740000000000000000000081526000600560f91b80601684015266037bbb732b91d160cd1b60178401528751611a4a81601e860160208c01611635565b808401905081601e8201527f6772616e7465653a200000000000000000000000000000000000000000000000601f8201528751611a8e816028840160208c01611635565b01602881018290527f6461746149643a200000000000000000000000000000000000000000000000006029820152611aca6031820187896119e8565b915050611ada81600560f91b9052565b7f6c6f636b6564556e74696c3a20000000000000000000000000000000000000006001820152611b0d600e8201856119cc565b98975050505050505050565b7f6f7065726174696f6e3a20696e736572744772616e740000000000000000000081526000600560f91b80601684015266037bbb732b91d160cd1b60178401528751611a4a81601e860160208c01611635565b634e487b7160e01b600052603260045260246000fd5b60008251611b94818460208701611635565b9190910192915050565b634e487b7160e01b600052601160045260246000fd5b600060018201611bc657611bc6611b9e565b5060010190565b600181811c90821680611be157607f821691505b602082108103611c0157634e487b7160e01b600052602260045260246000fd5b50919050565b7f19457468657265756d205369676e6564204d6573736167653a0a000000000000815260008351611c3f81601a850160208801611635565b835190830190611c5681601a840160208801611635565b01601a01949350505050565b634e487b7160e01b600052602160045260246000fd5b601f8211156107ba57600081815260208120601f850160051c81016020861015611c9f5750805b601f850160051c820191505b81811015610e4f57828155600101611cab565b815167ffffffffffffffff811115611cd857611cd8611733565b611cec81611ce68454611bcd565b84611c78565b602080601f831160018114611d215760008415611d095750858301515b600019600386901b1c1916600185901b178555610e4f565b600085815260208120601f198616915b82811015611d5057888601518255948401946001909101908401611d31565b5085821015611d6e5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b80820281158282048414176107a8576107a8611b9e565b808201808211156107a8576107a8611b9e565b600081611db757611db7611b9e565b506000190190565b828152604060208201526000611dd86040830184611659565b949350505050565b600060208284031215611df257600080fd5b5051919050565b60006bffffffffffffffffffffffff19808760601b168352808660601b166014840152508351611e30816028850160208801611635565b6028920191820192909252604801949350505050565b818103818111156107a8576107a8611b9e565b634e487b7160e01b600052603160045260246000fdfea2646970667358221220222c5af3c9ba30e97583ec498a62cafc8eeafaf8586945476f62ac90a608261a64736f6c63430008130033",
  "linkReferences": {},
  "deployedLinkReferences": {}
}

'''
'''--- evm/hardhat.config.js ---
require("dotenv-flow").config();
require("@nomicfoundation/hardhat-toolbox");
require("@nomicfoundation/hardhat-verify");

module.exports = {
  solidity: {
    version: "0.8.19",
    settings: {
      optimizer: {
        enabled: true,
        runs: 1000,
      },
    },
  },
  networks: {
    sepolia: {
      url: process.env.SEPOLIA_NODE_URL,
      accounts: [process.env.PRIVATE_KEY],
    },
    arbitrumSepolia: {
      url: process.env.ARBITRUM_SEPOLIA_NODE_URL,
      accounts: [process.env.PRIVATE_KEY],
    },
    arbitrumOne: {
      url: process.env.ARBITRUM_ONE_NODE_URL,
      accounts: [process.env.PRIVATE_KEY],
    }
  },
  etherscan: {
    apiKey: {
      sepolia: process.env.SEPOLIA_ETHERSCAN_API_KEY,
      arbitrumSepolia: process.env.ARBITRUM_ETHERSCAN_API_KEY,
      arbitrumOne: process.env.ARBITRUM_ETHERSCAN_API_KEY,
    },
  },
  sourcify: {
    enabled: true,
  },
};

'''
'''--- evm/package.json ---
{
  "scripts": {
    "test": "hardhat test"
  },
  "devDependencies": {
    "@nomicfoundation/hardhat-chai-matchers": "^2.0.2",
    "@nomicfoundation/hardhat-ethers": "^3.0.4",
    "@nomicfoundation/hardhat-network-helpers": "^1.0.8",
    "@nomicfoundation/hardhat-toolbox": "^3.0.0",
    "@nomicfoundation/hardhat-verify": "^2.0.4",
    "@openzeppelin/contracts": "^4.9.3",
    "@typechain/ethers-v6": "^0.4.3",
    "@typechain/hardhat": "^8.0.3",
    "chai": "^4.3.7",
    "ethers": "^6.7.0",
    "hardhat": "^2.17.1",
    "hardhat-gas-reporter": "^1.0.9",
    "solidity-coverage": "^0.8.4",
    "typechain": "^8.3.1"
  },
  "dependencies": {
    "dotenv-flow": "^4.1.0"
  }
}

'''
'''--- evm/scripts/deploy.js ---
const hre = require("hardhat");

async function main() {
  const accessGrants = await hre.ethers.deployContract("AccessGrants");

  await accessGrants.waitForDeployment();

  console.log(`AccessGrants deployed to ${accessGrants.target}`);
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});

'''
'''--- evm/test/AccessGrants.js ---
const { loadFixture, time } = require("@nomicfoundation/hardhat-network-helpers");
const { expect } = require("chai");

const WILDCARD_ADDRESS = ethers.ZeroAddress;
const WILDCARD_DATA = "0";
const NO_TIMELOCK = 0n;

describe("AccessGrants", function () {
  async function deployAndPopulateContractFixture() {
    const [_, signer1, signer2, signer3, signer4] = await ethers.getSigners();

    const AccessGrants = await ethers.getContractFactory("AccessGrants");
    const accessGrants = await AccessGrants.deploy();

    await accessGrants.connect(signer1).insertGrant(signer2, "1A", NO_TIMELOCK);
    await accessGrants.connect(signer1).insertGrant(signer2, "1B", NO_TIMELOCK);
    await accessGrants.connect(signer1).insertGrant(signer3, "1A", NO_TIMELOCK);

    await accessGrants.connect(signer2).insertGrant(signer1, "2A", NO_TIMELOCK);
    await accessGrants.connect(signer2).insertGrant(signer3, "2A", NO_TIMELOCK);

    return { accessGrants, signer1, signer2, signer3, signer4 };
  }

  describe("Grant management", function () {
    describe("Creating grants", function () {
      describe("By owner through insertGrant", function () {
        it("A grant can only be owned by its creator", async function () {
          const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

          let grants = await accessGrants.findGrants(owner, grantee, "1A");

          expect(grants.length).to.equal(1);
          expect(grants[0].owner).to.equal(owner.address);
        });

        it("A duplicate grant cannot be created", async function () {
          const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

          await expect(
            accessGrants.connect(owner).insertGrant(grantee, "1A", NO_TIMELOCK)
          ).to.be.revertedWith("Grant already exists");
        });
      });

      describe("By anybody through insertGrantBySignature", function () {
        it("Inserts grant", async function () {
          const { accessGrants, signer1: caller, signer2: owner, signer3: grantee } = await loadFixture(deployAndPopulateContractFixture);
          const contract = accessGrants.connect(caller);

          const dataId = "849690b7-fee1-46d8-8c91-0268b0cc1850";
          const lockedUntil = 50n;

          const signature = await owner.signMessage(await contract.insertGrantBySignatureMessage(owner.address, grantee.address, dataId, lockedUntil));

          await contract.insertGrantBySignature(owner.address, grantee.address, dataId, lockedUntil, signature);
          let grants = await accessGrants.findGrants(owner.address, grantee.address, dataId);

          expect(grants.length).to.equal(1);
          expect(grants).to.eql([
            [owner.address, grantee.address, dataId, lockedUntil],
          ]);
        });

        it("Fails when the signature is wrong", async function () {
          const { accessGrants, signer1: caller, signer2: owner, signer3: grantee } = await loadFixture(deployAndPopulateContractFixture);
          const dataId = "849690b7-fee1-46d8-8c91-0268b0cc1850";
          const lockedUntil = 50n;

          const signature = "0xcda9acd962714be67a2b0fe14c4ffa5e51c2912f463f72a293d9157ccea1a31b15541a5e5dcf35e4bf6e3bb58b3e5ae569859cfd3c6272a8ff647d544f0cea061c";

          await expect(
            accessGrants.connect(caller).insertGrantBySignature(owner.address, grantee.address, dataId, lockedUntil, signature)
          ).to.be.revertedWith("Signature doesn't match");
        });
      });
    });

    describe("Deleting grants", function () {
      it("A grant can be deleted by its owner", async function () {
        const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

        const lockedUntil = await time.latest() - 1000;

        await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil);

        await expect(
          accessGrants.connect(owner).deleteGrant(grantee, "some ID", lockedUntil)
        ).to.not.be.revertedWith("Grant is timelocked");
      });

      it("A grant cannot be deleted by anyone else", async function () {
        const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

        const lockedUntil = await time.latest() - 1000;

        await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil);

        await expect(
          accessGrants.connect(grantee).deleteGrant(grantee, "some ID", lockedUntil)
        ).to.be.revertedWith("No grants for owner");

        let grants = await accessGrants.findGrants(owner, grantee, "some ID");

        expect(grants.length).to.equal(1);
      });

      describe("Timelocks", function () {
        describe("When given", function () {
          it("A grant cannot be deleted while locked", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            const lockedUntil = await time.latest() + 1000;

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil);
            await expect(
              accessGrants.connect(owner).deleteGrant(grantee, "some ID", lockedUntil)
            ).to.be.revertedWith("Grant is timelocked");

            let grants = await accessGrants.findGrants(owner, grantee, "some ID");

            expect(grants.length).to.equal(1);
          });

          it("A grant can be deleted if timelock is expired", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            const lockedUntil = await time.latest() - 1000;

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil);
            await expect(
              accessGrants.connect(owner).deleteGrant(grantee, "some ID", lockedUntil)
            ).to.not.be.revertedWith("Grant is timelocked");

            let grants = await accessGrants.findGrants(owner, grantee, "some ID");

            expect(grants.length).to.equal(0);
          });

          it("A grant can be deleted if timelock is expired", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            const lockedUntil = await time.latest() - 1000;

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil);
            await expect(
              accessGrants.connect(owner).deleteGrant(grantee, "some ID", lockedUntil)
            ).to.not.be.revertedWith("Grant is timelocked");

            let grants = await accessGrants.findGrants(owner, grantee, "some ID");

            expect(grants.length).to.equal(0);
          });
        });

        describe("When not given", function () {
          it("All mathing grants are deleted if all timelocks are expired", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            const lockedUntil = await time.latest() - 1000;

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil + 0);
            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil + 1);
            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil + 2);

            await expect(
              accessGrants.connect(owner).deleteGrant(grantee, "some ID", NO_TIMELOCK)
            ).to.not.be.revertedWith("Grant is timelocked");

            let grants = await accessGrants.findGrants(owner, grantee, "some ID");

            expect(grants.length).to.equal(0);
          });

          it("No grants are deleted if one or more timelocks are expired", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            const lockedUntil = await time.latest() - 1000;

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil + 0);
            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil + 1);
            await accessGrants.connect(owner).insertGrant(grantee, "some ID", lockedUntil + 2000);

            await expect(
              accessGrants.connect(owner).deleteGrant(grantee, "some ID", NO_TIMELOCK)
            ).to.be.revertedWith("Grant is timelocked");

            let grants = await accessGrants.findGrants(owner, grantee, "some ID");

            expect(grants.length).to.equal(3);
          });
        });
      });

      describe("By anybody through deleteGrantBySignature", function () {
        it("Delete grant", async function () {
          const { accessGrants, signer1: caller, signer2: owner, signer3: grantee } = await loadFixture(deployAndPopulateContractFixture);
          const dataId = "some data id";
          const lockedUntil = 50;
          await accessGrants.connect(owner).insertGrant(grantee, dataId, lockedUntil);
          expect((await accessGrants.findGrants(owner.address, grantee.address, dataId)).length).to.equal(1);

          const signature = await owner.signMessage(await accessGrants.deleteGrantBySignatureMessage(owner.address, grantee.address, dataId, lockedUntil));
          await accessGrants.connect(caller).deleteGrantBySignature(owner.address, grantee.address, dataId, lockedUntil, signature);

          expect((await accessGrants.findGrants(owner.address, grantee.address, dataId)).length).to.equal(0);
        });

        it("Fails when the signature is wrong", async function () {
          const { accessGrants, signer1: caller, signer2: owner, signer3: grantee } = await loadFixture(deployAndPopulateContractFixture);
          const dataId = "some data id";
          const lockedUntil = 50;
          await accessGrants.connect(owner).insertGrant(grantee, dataId, lockedUntil);
          expect((await accessGrants.findGrants(owner.address, grantee.address, dataId)).length).to.equal(1);

          const signature = "0x0badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad";

          await expect(
            accessGrants.connect(caller).deleteGrantBySignature(owner.address, grantee.address, dataId, lockedUntil, signature)
          ).to.be.revertedWith("Signature doesn't match");
        });
      });
    });

    describe("Reading grants", function () {
      describe("grantsFor", async function () {
        describe("When the grant doesn't exist", async function () {
          it("Returns no grants", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", NO_TIMELOCK);

            let grants = await accessGrants.grantsFor(grantee, "bad ID");

            expect(grants.length).to.equal(0);
            expect(grants).to.eql([]);
          });
        });

        describe("When the grant exists", async function () {
          it("Returns the grant, regardless of caller", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", NO_TIMELOCK);

            let grants1 = await accessGrants.connect(owner).grantsFor(grantee, "some ID");
            let grants2 = await accessGrants.connect(grantee).grantsFor(grantee, "some ID");

            expect(grants1.length).to.equal(1);
            expect(grants1).to.eql([
              [owner.address, grantee.address, "some ID", NO_TIMELOCK],
            ]);
            expect(grants1).to.eql(grants2);
          });
        });
      });

      describe("findGrants", async function () {
        describe("When the grant doesn't exist", async function () {
          it("Returns no grants", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", NO_TIMELOCK);

            let grants = await accessGrants.findGrants(owner, grantee, "bad ID");

            expect(grants.length).to.equal(0);
            expect(grants).to.eql([]);
          });
        });

        describe("When grants exists", async function () {
          it("Returns the grant, regardless of caller", async function () {
            const { accessGrants, signer1: owner, signer2: grantee } = await loadFixture(deployAndPopulateContractFixture);

            await accessGrants.connect(owner).insertGrant(grantee, "some ID", NO_TIMELOCK);

            let grants1 = await accessGrants.connect(owner).findGrants(owner, grantee, "some ID");
            let grants2 = await accessGrants.connect(grantee).findGrants(owner, grantee, "some ID");

            expect(grants1.length).to.equal(1);
            expect(grants1).to.eql([
              [owner.address, grantee.address, "some ID", 0n],
            ]);
            expect(grants1).to.eql(grants2);
          });

          describe("With wildcard arguments", async function () {
            it("Reverts if neither owner nor grantee provided", async function () {
              const { accessGrants } = await loadFixture(deployAndPopulateContractFixture);

              await expect(
                accessGrants.findGrants(WILDCARD_ADDRESS, WILDCARD_ADDRESS, "some ID")
              ).to.be.revertedWith("Required argument: `owner` and/or `grantee`");
            });

            describe("Given owner", async function () {
              it("Returns grants for any grantee, any data", async function () {
                const { accessGrants, signer1, signer2, signer3 } = await loadFixture(deployAndPopulateContractFixture);

                let grants = await accessGrants.findGrants(signer1, WILDCARD_ADDRESS, WILDCARD_DATA);

                expect(grants.length).to.equal(3);
                expect(grants).to.eql([
                  [signer1.address, signer2.address, "1A", 0n],
                  [signer1.address, signer2.address, "1B", 0n],
                  [signer1.address, signer3.address, "1A", 0n],
                ]);

                grants = await accessGrants.findGrants(signer2, WILDCARD_ADDRESS, WILDCARD_DATA);

                expect(grants.length).to.equal(2);
                expect(grants).to.eql([
                  [signer2.address, signer1.address, "2A", 0n],
                  [signer2.address, signer3.address, "2A", 0n],
                ]);
              });

              it("Returns grants for given grantee, any data", async function () {
                const { accessGrants, signer1, signer2, signer3 } = await loadFixture(deployAndPopulateContractFixture);

                let grants = await accessGrants.findGrants(signer1, signer2, WILDCARD_DATA);

                expect(grants.length).to.equal(2);
                expect(grants).to.eql([
                  [signer1.address, signer2.address, "1A", 0n],
                  [signer1.address, signer2.address, "1B", 0n],
                ]);

                grants = await accessGrants.findGrants(signer1, signer3, WILDCARD_DATA);

                expect(grants.length).to.equal(1);
                expect(grants).to.eql([
                  [signer1.address, signer3.address, "1A", 0n],
                ]);
              });

              it("Returns grants for any grantee, given data", async function () {
                const { accessGrants, signer1, signer2, signer3 } = await loadFixture(deployAndPopulateContractFixture);

                let grants = await accessGrants.findGrants(signer1, WILDCARD_ADDRESS, "1A");

                expect(grants.length).to.equal(2);
                expect(grants).to.eql([
                  [signer1.address, signer2.address, "1A", 0n],
                  [signer1.address, signer3.address, "1A", 0n],
                ]);

                grants = await accessGrants.findGrants(signer2, WILDCARD_ADDRESS, "2A");

                expect(grants.length).to.equal(2);
                expect(grants).to.eql([
                  [signer2.address, signer1.address, "2A", 0n],
                  [signer2.address, signer3.address, "2A", 0n],
                ]);
              });
            });

            describe("Given grantee", async function () {
              it("Returns grants for any ownwer, any data", async function () {
                const { accessGrants, signer1, signer2, signer3 } = await loadFixture(deployAndPopulateContractFixture);

                let grants = await accessGrants.findGrants(WILDCARD_ADDRESS, signer1, WILDCARD_DATA);

                expect(grants.length).to.equal(1);
                expect(grants).to.eql([
                  [signer2.address, signer1.address, "2A", 0n],
                ]);

                grants = await accessGrants.findGrants(WILDCARD_ADDRESS, signer3, WILDCARD_DATA);

                expect(grants.length).to.equal(2);
                expect(grants).to.eql([
                  [signer1.address, signer3.address, "1A", 0n],
                  [signer2.address, signer3.address, "2A", 0n],
                ]);
              });

              it("Returns grants for any ownwer, given data", async function () {
                const { accessGrants, signer1, signer2, signer3 } = await loadFixture(deployAndPopulateContractFixture);

                let grants = await accessGrants.findGrants(WILDCARD_ADDRESS, signer2, "1A");

                expect(grants.length).to.equal(1);
                expect(grants).to.eql([
                  [signer1.address, signer2.address, "1A", 0n],
                ]);

                grants = await accessGrants.findGrants(WILDCARD_ADDRESS, signer3, "2A");

                expect(grants.length).to.equal(1);
                expect(grants).to.eql([
                  [signer2.address, signer3.address, "2A", 0n],
                ]);
              });
            });
          });
        });
      });
    });
  });

  describe("Events", function () {
    describe("when a grant inserted", function () {
      it("Creates GrantAdded event", async function () {
        const { accessGrants, signer1: caller, signer2: owner, signer3: grantee } = await loadFixture(deployAndPopulateContractFixture);
        const dataId = "849690b7-fee1-46d8-8c91-0268b0cc1850";
        const lockedUntil = 50n;
        await accessGrants.connect(owner).insertGrant(grantee, dataId, lockedUntil);

        const eventTopic = ethers.id("GrantAdded(address,address,string,uint256)");
        const logs = await ethers.provider.getLogs({
          address: accessGrants.address,
          topics: [
            eventTopic,
            ethers.zeroPadValue(owner.address, 32),
            ethers.zeroPadValue(grantee.address, 32),
            ethers.keccak256(ethers.toUtf8Bytes(dataId)),
          ],
        });
        expect(logs.length).to.equal(1);
        expect(logs[0].data).to.equal(lockedUntil);
      });
    });
    describe("when a grant deleted", function () {
      it("Creates GrantDeleted event", async function () {
        const { accessGrants, signer1: caller, signer2: owner, signer3: grantee } = await loadFixture(deployAndPopulateContractFixture);
        const dataId = "849690b7-fee1-46d8-8c91-0268b0cc1850";
        const lockedUntil = 50n;
        await accessGrants.connect(owner).insertGrant(grantee, dataId, lockedUntil);
        await accessGrants.connect(owner).deleteGrant(grantee, dataId, lockedUntil);

        const eventTopic = ethers.id("GrantDeleted(address,address,string,uint256)");
        const logs = await ethers.provider.getLogs({
          address: accessGrants.address,
          topics: [
            eventTopic,
            ethers.zeroPadValue(owner.address, 32),
            ethers.zeroPadValue(grantee.address, 32),
            ethers.keccak256(ethers.toUtf8Bytes(dataId)),
          ],
        });
        expect(logs.length).to.equal(1);
        expect(logs[0].data).to.equal(lockedUntil);
      });
    });

  });
});

'''
'''--- near-rs/README.md ---
# NEAR

Initialized with [create-near-app](https://github.com/near/create-near-app)

Requires rust ([installation instructions](https://www.rust-lang.org/tools/install))

---

```
$ yarn test
```

'''
'''--- near-rs/contract/Cargo.toml ---
[package]
name = "access_grants"
version = "1.0.1"

[lib]
crate-type = ["cdylib"]

[dependencies]
near-sdk = "5.0.0"
# I don't know why I need to declare a direct dep to borsh, but that's what it took to compile.
borsh = "*"
hex = "0.4.3"

[dev-dependencies]
near-sdk = { version = "5.0.0", features = ["unit-testing"] }

[profile.release]
codegen-units = 1
opt-level = "z"
lto = true
debug = false
panic = "abort"
overflow-checks = true

[workspace]
members = []

'''
'''--- near-rs/contract/build.sh ---
#!/bin/sh

echo ">> Building contract"

rustup target add wasm32-unknown-unknown
cargo build --all --target wasm32-unknown-unknown --release

'''
'''--- near-rs/contract/deploy.sh ---
#!/bin/sh

./build.sh

if [ $? -ne 0 ]; then
  echo ">> Error building contract"
  exit 1
fi

echo ">> Deploying contract"

NEAR_ENV=mainnet ../node_modules/.bin/near deploy idos-dev-4.near ./target/wasm32-unknown-unknown/release/access_grants.wasm

'''
'''--- near-rs/contract/src/lib.rs ---
// The `#[near_bindgen]` for `impl FractalRegistry` was triggering this, and I couldn't find a way to suppress it.
#![allow(clippy::too_many_arguments)]
extern crate near_sdk;

use std::convert::TryInto;

use near_sdk::borsh::{self, BorshDeserialize, BorshSerialize};
use near_sdk::serde::Serialize;
use near_sdk::store::LookupMap;
use near_sdk::{env, near_bindgen, require, CurveType, EpochHeight, PublicKey};

#[near_bindgen]
#[derive(BorshDeserialize, BorshSerialize)]
pub struct FractalRegistry {
    pub grants_by_id: LookupMap<String, Grant>,

    pub grant_ids_by_owner: LookupMap<PublicKey, Vec<String>>,
    pub grant_ids_by_grantee: LookupMap<PublicKey, Vec<String>>,
    pub grant_ids_by_data_id: LookupMap<String, Vec<String>>,
}

#[derive(BorshDeserialize, BorshSerialize, Serialize, Clone)]
#[serde(crate = "near_sdk::serde")]
pub struct Grant {
    owner: PublicKey,
    grantee: PublicKey,
    data_id: String,
    locked_until: EpochHeight,
}

#[cfg(test)]
#[test]
fn derive_grant_id_example() {
    // Just to make sure we don't accidentally change the way we derive grant_ids.

    let grant = Grant {
        owner: "ed25519:BCUg4havhRURACQAFK48e6ScqcJgPbeqHbfcmNoWp3fZ"
            .parse()
            .unwrap(),
        grantee: "ed25519:mrjrfx8wSA9pYyMEeMm2QnFe9ct1P8CRkmU55h8MxEi"
            .parse()
            .unwrap(),
        data_id: "some data".into(),
        locked_until: 1337,
    };

    assert_eq!(
        "8031eff696fa15a7e4c69530a1d8b634faab8d512fde219b92aae0082adb8606",
        derive_grant_id(&grant)
    );
}

pub fn derive_grant_id(grant: &Grant) -> String {
    let id = format!(
        "{}{}{}{}",
        Into::<String>::into(&grant.owner),
        Into::<String>::into(&grant.grantee),
        grant.data_id,
        grant.locked_until,
    );

    hex::encode(env::keccak256(id.as_bytes()))
}

impl Default for FractalRegistry {
    fn default() -> Self {
        let grants_by_id = LookupMap::new(b"g");
        let grant_ids_by_owner = LookupMap::new(b"h");
        let grant_ids_by_grantee = LookupMap::new(b"i");
        let grant_ids_by_data_id = LookupMap::new(b"j");

        Self {
            grants_by_id,
            grant_ids_by_owner,
            grant_ids_by_grantee,
            grant_ids_by_data_id,
        }
    }
}

#[derive(BorshDeserialize, BorshSerialize, Serialize, Clone)]
#[serde(crate = "near_sdk::serde")]
struct Nep413Payload {
    pub message: String,
    pub nonce: [u8; 32],
    pub recipient: String,
    #[serde(rename = "callbackUrl")]
    pub callback_url: Option<String>,
}

const NEP413_TAG: u32 = 2147484061; // 2**31 + 413
fn nep413_hashed_payload(payload: &Nep413Payload) -> [u8; 32] {
    let mut writer = vec![];

    borsh::to_writer(&mut writer, &NEP413_TAG).expect("Can't borsh encode NEP413_TAG");
    borsh::to_writer(&mut writer, payload).expect("Can't borsh encode payload");

    env::sha256_array(&writer)
}

// Just so people don't pass in the wrong name for the message.
macro_rules! u8_to_fixed_length_array {
    ( $value:expr ) => {
        __u8_to_fixed_length_array($value, stringify!($value))
    };
}

fn __u8_to_fixed_length_array<'a, const N: usize>(
    source: &'a [u8],
    name: &'static str,
) -> &'a [u8; N] {
    source.try_into().unwrap_or_else(|_| {
        panic!(
            "{} doesn't seem to have exactly {} bytes: {:?}",
            name, N, source
        )
    })
}

#[cfg(test)]
#[test]
fn u8_to_fixed_length_array_example_good() {
    assert_eq!(
        [1, 2, 3],
        *u8_to_fixed_length_array!(vec![1, 2, 3].as_slice())
    );
}

#[cfg(test)]
#[test]
#[should_panic(expected = "original.as_slice() doesn't seem to have exactly 1 bytes: [1, 2, 3]")]
fn u8_to_fixed_length_array_example_bad() {
    let original = vec![1, 2, 3];
    let _var_name: [u8; 1] = *u8_to_fixed_length_array!(original.as_slice());
}

pub fn public_key_bytes_ref(public_key: &PublicKey) -> &[u8; 32] {
    // First byte is the curve type.
    u8_to_fixed_length_array!(&public_key.as_bytes()[1..])
}

#[near_bindgen(event_json(standard = "FractalRegistry"))]
pub enum FractalRegistryEvents {
    #[event_version("0")]
    GrantInserted {
        owner: PublicKey,
        grantee: PublicKey,
        data_id: String,
        locked_until: EpochHeight,
    },

    #[event_version("0")]
    GrantDeleted {
        owner: PublicKey,
        grantee: PublicKey,
        data_id: String,
        locked_until: EpochHeight,
    },
}

fn nep413_verify(
    message: String,
    nonce: Vec<u8>,
    recipient: String,
    signature: Vec<u8>,
    owner: &PublicKey,
) {
    require!(
        owner.curve_type() == CurveType::ED25519,
        "Only ed25519 keys are supported",
    );

    // Serde didn't have [u8; 64] implemented, only up to 32. So, I've decided to convert them inside the function.
    let nonce: [u8; 32] = *u8_to_fixed_length_array!(nonce.as_slice());
    let signature: [u8; 64] = *u8_to_fixed_length_array!(signature.as_slice());

    let hashed_payload = nep413_hashed_payload(&Nep413Payload {
        message: message,
        nonce,
        recipient,
        callback_url: None,
    });

    require!(
        env::ed25519_verify(&signature, &hashed_payload, public_key_bytes_ref(owner),),
        "Signature doesn't match"
    );
}

#[near_bindgen]
impl FractalRegistry {
    pub fn grant_message_recipient(&self) -> String {
        "idos.network".into()
    }

    pub fn insert_grant(
        &mut self,
        grantee: PublicKey,
        data_id: String,
        locked_until: Option<EpochHeight>,
    ) {
        self._insert_grant(env::signer_account_pk(), grantee, data_id, locked_until)
    }

    pub fn insert_grant_by_signature_message(
        &self,
        owner: PublicKey,
        grantee: PublicKey,
        data_id: String,
        locked_until: Option<EpochHeight>,
    ) -> String {
        format!(
            "operation: insertGrant\n\
            owner: {}\n\
            grantee: {}\n\
            dataId: {}\n\
            lockedUntil: {}",
            Into::<String>::into(&owner),
            Into::<String>::into(&grantee),
            data_id,
            locked_until.unwrap_or(0)
        )
    }

    pub fn insert_grant_by_signature(
        &mut self,
        owner: PublicKey,
        grantee: PublicKey,
        data_id: String,
        locked_until: Option<EpochHeight>,
        nonce: Vec<u8>,
        signature: Vec<u8>,
    ) {
        nep413_verify(
            self.insert_grant_by_signature_message(
                owner.clone(),
                grantee.clone(),
                data_id.clone(),
                locked_until,
            ),
            nonce,
            self.grant_message_recipient(),
            signature,
            &owner,
        );

        self._insert_grant(owner, grantee, data_id, locked_until)
    }

    fn _insert_grant(
        &mut self,
        owner: PublicKey,
        grantee: PublicKey,
        data_id: String,
        locked_until: Option<EpochHeight>,
    ) {
        let grant = Grant {
            owner: owner.clone(),
            grantee: grantee.clone(),
            data_id: data_id.clone(),
            locked_until: locked_until.unwrap_or(0),
        };

        let grant_id = derive_grant_id(&grant);

        require!(
            !self.grants_by_id.contains_key(&grant_id),
            "Grant already exists"
        );

        self.grants_by_id.insert(grant_id.clone(), grant);

        self.grant_ids_by_owner
            .entry(owner.clone())
            .or_default()
            .push(grant_id.clone());

        self.grant_ids_by_grantee
            .entry(grantee.clone())
            .or_default()
            .push(grant_id.clone());

        self.grant_ids_by_data_id
            .entry(data_id.clone())
            .or_default()
            .push(grant_id.clone());

        let locked_until = locked_until.unwrap_or(0);

        FractalRegistryEvents::GrantInserted {
            owner,
            grantee,
            data_id,
            locked_until,
        }
        .emit();
    }

    pub fn delete_grant(
        &mut self,
        grantee: PublicKey,
        data_id: String,
        locked_until: Option<EpochHeight>,
    ) {
        self._delete_grant(env::signer_account_pk(), grantee, data_id, locked_until)
    }

    pub fn delete_grant_by_signature_message(
        &self,
        owner: PublicKey,
        grantee: PublicKey,
        data_id: String,
        locked_until: Option<EpochHeight>,
    ) -> String {
        format!(
            "operation: deleteGrant\n\
            owner: {}\n\
            grantee: {}\n\
            dataId: {}\n\
            lockedUntil: {}",
            Into::<String>::into(&owner),
            Into::<String>::into(&grantee),
            data_id,
            locked_until.unwrap_or(0)
        )
    }

    pub fn delete_grant_by_signature(
        &mut self,
        owner: PublicKey,
        grantee: PublicKey,
        data_id: String,
        locked_until: Option<EpochHeight>,
        nonce: Vec<u8>,
        signature: Vec<u8>,
    ) {
        nep413_verify(
            self.delete_grant_by_signature_message(
                owner.clone(),
                grantee.clone(),
                data_id.clone(),
                locked_until,
            ),
            nonce,
            self.grant_message_recipient(),
            signature,
            &owner,
        );

        self._delete_grant(owner, grantee, data_id, locked_until)
    }

    fn _delete_grant(
        &mut self,
        owner: PublicKey,
        grantee: PublicKey,
        data_id: String,
        locked_until: Option<EpochHeight>,
    ) {
        self.find_grants(
            Some(owner.clone()),
            Some(grantee.clone()),
            Some(data_id.clone()),
        )
        .iter()
        .filter(|grant| match locked_until {
            None => true,
            Some(0) => true,
            Some(locked_until_) => grant.locked_until == locked_until_,
        })
        .for_each(|grant| {
            require!(
                grant.locked_until < env::block_timestamp(),
                "Grant is timelocked"
            );

            let grant_id = derive_grant_id(grant);

            self.grants_by_id.remove(&grant_id);

            self.grant_ids_by_owner
                .get_mut(&owner)
                .unwrap_or(&mut vec![])
                .retain(|id| *id != *grant_id);

            self.grant_ids_by_grantee
                .get_mut(&grantee)
                .unwrap_or(&mut vec![])
                .retain(|id| *id != *grant_id);

            self.grant_ids_by_data_id
                .get_mut(&data_id)
                .unwrap_or(&mut vec![])
                .retain(|id| *id != *grant_id);
        });

        let locked_until = locked_until.unwrap_or(0);

        FractalRegistryEvents::GrantDeleted {
            owner,
            grantee,
            data_id,
            locked_until,
        }
        .emit();
    }

    pub fn grants_for(&self, grantee: PublicKey, data_id: String) -> Vec<Grant> {
        self.find_grants(None, Some(grantee), Some(data_id))
    }

    pub fn find_grants(
        &self,
        owner: Option<PublicKey>,
        grantee: Option<PublicKey>,
        data_id: Option<String>,
    ) -> Vec<Grant> {
        let mut grant_id_searches = Vec::new();

        require!(
            owner.is_some() || grantee.is_some(),
            "Required argument: `owner` and/or `grantee`",
        );

        let empty = vec![];
        if let Some(owner) = owner {
            grant_id_searches.push(self.grant_ids_by_owner.get(&owner).unwrap_or(&empty));
        }

        if let Some(grantee) = grantee {
            grant_id_searches.push(self.grant_ids_by_grantee.get(&grantee).unwrap_or(&empty));
        }

        if let Some(data_id) = data_id {
            grant_id_searches.push(self.grant_ids_by_data_id.get(&data_id).unwrap_or(&empty));
        }

        let Some((head, tail)) = grant_id_searches.split_first() else {
            return vec![];
        };

        head.iter()
            .filter(|id| tail.iter().all(|s| s.contains(id)))
            .map(|id| self.grants_by_id.get(id).unwrap().clone())
            .collect()
    }
}

'''
'''--- near-rs/integration-tests/Cargo.toml ---
[package]
name = "integration-tests"
version = "1.0.0"
publish = false
edition = "2018"

[dev-dependencies]
anyhow = "1.0"
borsh = "0.9"
maplit = "1.0"
near-units = "0.2.0"
# arbitrary_precision enabled for u128 types that workspaces requires for Balance types
serde = "1.0.183"
serde_json = { version = "1.0", features = ["arbitrary_precision"] }
tokio = { version = "1.18.1", features = ["full"] }
tracing = "0.1"
tracing-subscriber = { version = "0.3.11", features = ["env-filter"] }
near-workspaces = "0.8.0"
pkg-config = "0.3.1"
lazy_static = "1.4.0"
ring = "0.17.8"
rand = "0.8.5"
near-crypto = "0.20.1"

[[example]]
name = "integration-tests"
path = "empty.rs"

'''
'''--- near-rs/integration-tests/empty.rs ---
fn main() {
    panic!("Run yarn test instead.")
}

'''
'''--- near-rs/integration-tests/tests/assert/mod.rs ---
use near_workspaces::result::ExecutionFinalResult;

pub fn transaction_success(result: ExecutionFinalResult) {
    assert!(
        result.is_success(),
        "{}",
        result.into_result().unwrap_err().to_string()
    );
}

pub fn transaction_failure(result: ExecutionFinalResult, expected_error: &str) {
    assert!(result.is_failure());
    assert_eq!(
        result.into_result().unwrap_err().to_string(),
        expected_error
    );
}

'''
'''--- near-rs/integration-tests/tests/delete_grant_by_signature.rs ---
use serde_json::json;

mod helpers;
use helpers::{create_public_key, scenario_base, Grant};

mod assert;

mod nep413;

#[tokio::test]
async fn happy_path() -> anyhow::Result<()> {
    let (worker, contract, some_other_account) = scenario_base().await?;

    let (owner_id, owner_sk) = worker.dev_generate().await;
    let owner_account = worker
        .create_tla(owner_id.clone(), owner_sk.clone())
        .await?
        .unwrap();
    let owner = owner_sk.public_key();

    let grantee = create_public_key();
    let data_id: String = "DATA_ID".into();
    let locked_until = 0;
    let nonce = nep413::generate_nonce();

    assert::transaction_success(
        owner_account
            .call(contract.id(), "insert_grant")
            .args_json(json!({"grantee": grantee, "data_id": data_id}))
            .transact()
            .await?,
    );

    let recipient = some_other_account
        .call(contract.id(), "grant_message_recipient")
        .args_json(json!({}))
        .view()
        .await?
        .json::<String>()
        .unwrap();

    let message = some_other_account
        .call(contract.id(), "delete_grant_by_signature_message")
        .args_json(json!({
            "owner": owner,
            "grantee": grantee,
            "data_id": data_id,
            "locked_until": locked_until,
        }))
        .view()
        .await?
        .json::<String>()
        .unwrap();

    let signature = nep413::Payload {
        message,
        nonce,
        recipient,
        callback_url: None,
    }
    .sign_with(owner_sk);

    assert::transaction_success(
        some_other_account
            .call(contract.id(), "delete_grant_by_signature")
            .args_json(json!({
                "owner": owner,
                "grantee": grantee,
                "data_id": data_id,
                "locked_until": locked_until,
                "nonce": nonce,
                "signature": signature,
            }))
            .transact()
            .await?,
    );

    assert_eq!(
        some_other_account
            .call(contract.id(), "find_grants")
            .args_json(json!({"owner": owner, "grantee": grantee}))
            .view()
            .await?
            .json::<Vec<Grant>>()
            .unwrap(),
        vec![],
    );

    Ok(())
}

#[tokio::test]
async fn wrong_signature() -> anyhow::Result<()> {
    let (_, contract, test_account) = scenario_base().await?;

    let owner = create_public_key();
    let grantee = create_public_key();
    let data_id: String = "DATA_ID".into();
    let locked_until = 0;
    let nonce = nep413::generate_nonce();

    assert::transaction_failure(
        test_account
            .call(contract.id(), "delete_grant_by_signature")
            .args_json(json!({
                "owner": owner,
                "grantee": grantee,
                "data_id": data_id,
                "locked_until": locked_until,
                "nonce": nonce,
                "signature": IntoIterator::into_iter([0u8; 64]).collect::<Vec<u8>>(),
            }))
            .transact()
            .await?,
        r#"Action #0: ExecutionError("Smart contract panicked: Signature doesn't match")"#,
    );

    Ok(())
}

'''
'''--- near-rs/integration-tests/tests/events/mod.rs ---
const EVENT_JSON_PREFIX: &'static str = "EVENT_JSON";
const EVENT_JSON_SEPARATOR: &'static str = ":";
pub fn extract_event(s: &str) -> serde_json::Value {
    if let Some((EVENT_JSON_PREFIX, json_str)) = s.split_once(EVENT_JSON_SEPARATOR) {
        if let Ok(json_value) = json_str.parse::<serde_json::Value>() {
            return json_value;
        }
    }

    panic!(
        "Expected {:?} to start with {:?}, followed by {:?} and a valid JSON value.",
        s, EVENT_JSON_PREFIX, EVENT_JSON_SEPARATOR
    )
}

'''
'''--- near-rs/integration-tests/tests/everything.rs ---
use std::time::{Duration, SystemTime, UNIX_EPOCH};

use serde_json::json;

mod helpers;
use helpers::{create_public_key, scenario_base, Grant};

mod events;
use events::extract_event;

#[tokio::test]
async fn test_everything() -> anyhow::Result<()> {
    let (_, contract, test_account) = scenario_base().await?;
    let bob: &str = &create_public_key();
    let charlie: &str = &create_public_key();
    let dave: &str = &create_public_key();
    let eve: &str = &create_public_key();
    let mut result;
    let mut grants;
    let test_public_key: String = test_account.secret_key().public_key().to_string();

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({"grantee": bob, "data_id": "A1"}))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(grants, vec![]);

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": bob, "data_id": "A1"}))
        .transact()
        .await?;
    assert!(result.is_success());
    assert_eq!(result.logs().len(), 1);
    assert_eq!(
        extract_event(result.logs()[0]),
        json!({
            "standard": "FractalRegistry",
            "version": "0",
            "event": "grant_inserted",
            "data": {
                "owner": test_public_key,
                "grantee": bob,
                "data_id": "A1",
                "locked_until": 0,
            },
        }),
    );

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": bob, "data_id": "A1"}))
        .transact()
        .await?;
    assert!(result.is_failure());
    assert!(result
        .into_result()
        .unwrap_err()
        .to_string()
        .contains("Grant already exists"));

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": bob, "data_id": "A2"}))
        .transact()
        .await?;
    assert!(result.is_success());

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": charlie, "data_id": "A2"}))
        .transact()
        .await?;
    assert!(
        result.is_success(),
        "{}",
        result.into_result().unwrap_err().to_string()
    );

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({ "owner": test_public_key }))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(
        grants,
        vec![
            Grant {
                owner: test_public_key.clone(),
                grantee: bob.into(),
                data_id: "A1".into(),
                locked_until: 0
            },
            Grant {
                owner: test_public_key.clone(),
                grantee: bob.into(),
                data_id: "A2".into(),
                locked_until: 0
            },
            Grant {
                owner: test_public_key.clone(),
                grantee: charlie.into(),
                data_id: "A2".into(),
                locked_until: 0
            },
        ]
    );

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({ "grantee": bob }))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(
        grants,
        vec![
            Grant {
                owner: test_public_key.clone(),
                grantee: bob.into(),
                data_id: "A1".into(),
                locked_until: 0
            },
            Grant {
                owner: test_public_key.clone(),
                grantee: bob.into(),
                data_id: "A2".into(),
                locked_until: 0
            },
        ]
    );

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({"owner": test_public_key, "grantee": bob}))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(
        grants,
        vec![
            Grant {
                owner: test_public_key.clone(),
                grantee: bob.into(),
                data_id: "A1".into(),
                locked_until: 0
            },
            Grant {
                owner: test_public_key.clone(),
                grantee: bob.into(),
                data_id: "A2".into(),
                locked_until: 0
            },
        ]
    );

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({"owner": test_public_key, "data_id": "A2"}))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(
        grants,
        vec![
            Grant {
                owner: test_public_key.clone(),
                grantee: bob.into(),
                data_id: "A2".into(),
                locked_until: 0
            },
            Grant {
                owner: test_public_key.clone(),
                grantee: charlie.into(),
                data_id: "A2".into(),
                locked_until: 0
            },
        ]
    );

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({"grantee": bob, "data_id": "A1"}))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(
        grants,
        vec![Grant {
            owner: test_public_key.clone(),
            grantee: bob.into(),
            data_id: "A1".into(),
            locked_until: 0
        },]
    );

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({"grantee": charlie, "data_id": "A1"}))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(grants, vec![]);

    result = test_account
        .call(contract.id(), "delete_grant")
        .args_json(json!({"grantee": bob, "data_id": "A1"}))
        .transact()
        .await?;
    assert!(result.is_success());
    assert_eq!(result.logs().len(), 1);
    assert_eq!(
        extract_event(result.logs()[0]),
        json!({
            "standard": "FractalRegistry",
            "version": "0",
            "event": "grant_deleted",
            "data": {
                "owner": test_public_key,
                "grantee": bob,
                "data_id": "A1",
                "locked_until": 0,
            },
        })
    );

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({ "grantee": bob }))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(
        grants,
        vec![Grant {
            owner: test_public_key.clone(),
            grantee: bob.into(),
            data_id: "A2".into(),
            locked_until: 0
        },]
    );

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({"grantee": bob, "data_id": "A1"}))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(grants, vec![]);

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({ "owner": test_public_key }))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(
        grants,
        vec![
            Grant {
                owner: test_public_key.clone(),
                grantee: bob.into(),
                data_id: "A2".into(),
                locked_until: 0
            },
            Grant {
                owner: test_public_key.clone(),
                grantee: charlie.into(),
                data_id: "A2".into(),
                locked_until: 0
            },
        ]
    );

    let in_the_future =
        (SystemTime::now().duration_since(UNIX_EPOCH)? + Duration::from_secs(3600)).as_nanos();
    let in_the_past =
        (SystemTime::now().duration_since(UNIX_EPOCH)? - Duration::from_secs(3600)).as_nanos();
    let in_the_paster =
        (SystemTime::now().duration_since(UNIX_EPOCH)? - 2 * Duration::from_secs(3600)).as_nanos();
    let in_the_pastest =
        (SystemTime::now().duration_since(UNIX_EPOCH)? - 3 * Duration::from_secs(3600)).as_nanos();

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": dave, "data_id": "A2", "locked_until": in_the_future}))
        .transact()
        .await?;
    assert!(result.is_success());

    result = test_account
        .call(contract.id(), "delete_grant")
        .args_json(json!({"grantee": dave, "data_id": "A2"}))
        .transact()
        .await?;
    assert!(result.is_failure());
    assert!(result
        .into_result()
        .unwrap_err()
        .to_string()
        .contains("Grant is timelocked"));

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": eve, "data_id": "A3", "locked_until": in_the_past}))
        .transact()
        .await?;
    assert!(result.is_success());

    result = test_account
        .call(contract.id(), "delete_grant")
        .args_json(json!({"grantee": eve, "data_id": "A3", "locked_until": in_the_past}))
        .transact()
        .await?;
    assert!(result.is_success());

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({ "grantee": eve }))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(grants, vec![]);

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": eve, "data_id": "A3", "locked_until": in_the_past}))
        .transact()
        .await?;
    assert!(result.is_success());

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": eve, "data_id": "A3", "locked_until": in_the_paster}))
        .transact()
        .await?;
    assert!(result.is_success());

    result = test_account
        .call(contract.id(), "insert_grant")
        .args_json(json!({"grantee": eve, "data_id": "A3", "locked_until": in_the_pastest}))
        .transact()
        .await?;
    assert!(result.is_success());

    result = test_account
        .call(contract.id(), "delete_grant")
        .args_json(json!({"grantee": eve, "data_id": "A3", "locked_until": in_the_past}))
        .transact()
        .await?;
    assert!(result.is_success());

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({"grantee": eve, "data_id": "A3"}))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(
        grants,
        vec![
            Grant {
                owner: test_public_key.clone(),
                grantee: eve.into(),
                data_id: "A3".into(),
                locked_until: in_the_paster
            },
            Grant {
                owner: test_public_key.clone(),
                grantee: eve.into(),
                data_id: "A3".into(),
                locked_until: in_the_pastest
            },
        ]
    );

    result = test_account
        .call(contract.id(), "delete_grant")
        .args_json(json!({"grantee": eve, "data_id": "A3", "locked_until": 0}))
        .transact()
        .await?;
    assert!(result.is_success());

    grants = test_account
        .call(contract.id(), "find_grants")
        .args_json(json!({"grantee": eve, "data_id": "A3"}))
        .view()
        .await?
        .json::<Vec<Grant>>()
        .unwrap();
    assert_eq!(grants, vec![]);

    assert!(format!(
        "{:?}",
        test_account
            .view(contract.id(), "find_grants")
            .args_json(json!({"data_id": "A2"}))
            .await
            .expect_err("find_grants should have panicked")
    )
    .contains("Required argument: `owner` and/or `grantee`"));

    Ok(())
}

'''
'''--- near-rs/integration-tests/tests/helpers/mod.rs ---
use lazy_static::lazy_static;

use std::{env, fs};

use near_workspaces::{network::Sandbox, types::SecretKey, Account, Contract, Worker};
use serde::Deserialize;

#[derive(Deserialize, Debug, PartialEq)]
pub struct Grant {
    pub owner: String,
    pub grantee: String,
    pub data_id: String,
    pub locked_until: u128,
}

pub fn create_secret_key() -> SecretKey {
    SecretKey::from_random(near_workspaces::types::KeyType::ED25519)
}

pub fn extract_public_key(secret_key: &SecretKey) -> String {
    secret_key.public_key().to_string()
}

pub fn create_public_key() -> String {
    extract_public_key(&create_secret_key())
}

lazy_static! {
    static ref WASM: Vec<u8> = {
        let wasm_arg: String = env::var("CONTRACT_LOCATION").unwrap_or(
            "../contract/target/wasm32-unknown-unknown/release/access_grants.wasm".into(),
        );
        let wasm_filepath = fs::canonicalize(env::current_dir().unwrap().join(wasm_arg)).unwrap();
        std::fs::read(wasm_filepath).unwrap()
    };
}

pub async fn scenario_base() -> anyhow::Result<(Worker<Sandbox>, Contract, Account)> {
    let worker = near_workspaces::sandbox().await?;
    let contract = worker.dev_deploy(&WASM).await?;
    let test_account = worker
        .dev_create_account()
        .await?
        .create_subaccount("test")
        .transact()
        .await?
        .into_result()?;
    Ok((worker, contract, test_account))
}

'''
'''--- near-rs/integration-tests/tests/insert_grant_by_signature.rs ---
use serde_json::json;

mod helpers;
use helpers::{create_public_key, create_secret_key, extract_public_key, scenario_base, Grant};

mod assert;

mod nep413;

#[tokio::test]
async fn happy_path() -> anyhow::Result<()> {
    let (_, contract, test_account) = scenario_base().await?;

    let owner_sk = create_secret_key();
    let owner = extract_public_key(&owner_sk);

    let grantee = create_public_key();
    let data_id: String = "DATA_ID".into();
    let locked_until = 0;
    let nonce = nep413::generate_nonce();

    assert_eq!(
        test_account
            .call(contract.id(), "find_grants")
            .args_json(json!({"owner": owner, "grantee": grantee}))
            .view()
            .await?
            .json::<Vec<Grant>>()
            .unwrap(),
        vec![]
    );

    let recipient = test_account
        .call(contract.id(), "grant_message_recipient")
        .args_json(json!({}))
        .view()
        .await?
        .json::<String>()
        .unwrap();

    let message = test_account
        .call(contract.id(), "insert_grant_by_signature_message")
        .args_json(json!({
            "owner": owner,
            "grantee": grantee,
            "data_id": data_id,
            "locked_until": locked_until,
        }))
        .view()
        .await?
        .json::<String>()
        .unwrap();

    let signature = nep413::Payload {
        message,
        nonce,
        recipient,
        callback_url: None,
    }
    .sign_with(owner_sk);

    assert::transaction_success(
        test_account
            .call(contract.id(), "insert_grant_by_signature")
            .args_json(json!({
                "owner": owner,
                "grantee": grantee,
                "data_id": data_id,
                "locked_until": locked_until,
                "nonce": nonce,
                "signature": signature,
            }))
            .transact()
            .await?,
    );

    assert_eq!(
        test_account
            .call(contract.id(), "find_grants")
            .args_json(json!({"owner": owner, "grantee": grantee}))
            .view()
            .await?
            .json::<Vec<Grant>>()
            .unwrap(),
        vec![Grant {
            owner,
            grantee,
            data_id,
            locked_until,
        }]
    );

    Ok(())
}

#[tokio::test]
async fn wrong_signature() -> anyhow::Result<()> {
    let (_, contract, test_account) = scenario_base().await?;

    let owner = create_public_key();
    let grantee = create_public_key();
    let data_id: String = "DATA_ID".into();
    let locked_until = 0;
    let nonce = nep413::generate_nonce();

    assert::transaction_failure(
        test_account
            .call(contract.id(), "insert_grant_by_signature")
            .args_json(json!({
                "owner": owner,
                "grantee": grantee,
                "data_id": data_id,
                "locked_until": locked_until,
                "nonce": nonce,
                "signature": IntoIterator::into_iter([0u8; 64]).collect::<Vec<u8>>(),
            }))
            .transact()
            .await?,
        r#"Action #0: ExecutionError("Smart contract panicked: Signature doesn't match")"#,
    );

    Ok(())
}

'''
'''--- near-rs/integration-tests/tests/nep413/mod.rs ---
use borsh::BorshSerialize;
use rand::random;
use ring::digest::{digest, SHA256};
use serde::Serialize;

use near_workspaces::types::SecretKey;
use std::str::FromStr;
use std::convert::TryInto;

#[derive(BorshSerialize, Serialize)]
pub struct Payload {
    pub message: String,
    pub nonce: [u8; 32],
    pub recipient: String,
    #[serde(rename = "callbackUrl")]
    pub callback_url: Option<String>,
}

const NEP413_TAG: u32 = 2147484061; // 2**31 + 413

impl Payload {
    pub fn to_hashed(&self) -> [u8; 32] {
        let mut writer = vec![];

        borsh::to_writer(&mut writer, &NEP413_TAG).expect("Can't borsh encode NEP413_TAG");
        borsh::to_writer(&mut writer, self).expect("Can't borsh encode payload");

        digest(&SHA256, writer.as_slice()).as_ref().try_into().unwrap()
    }

    pub fn sign_with(&self, secret_key: SecretKey) -> Vec<u8> {
        let bytes = raw_sign(secret_key, &self.to_hashed());

        IntoIterator::into_iter(bytes).collect()
    }
}

pub fn generate_nonce() -> [u8; 32] {
    let mut result = [0; 32];
    for x in result.iter_mut() {
        *x = random()
    }
    result
}

fn raw_sign(secret_key: SecretKey, data: &[u8]) -> [u8; 64] {
    let crypto_secret_key =
        near_crypto::SecretKey::from_str(secret_key.to_string().as_str()).unwrap();

    match crypto_secret_key.sign(data) {
        near_crypto::Signature::ED25519(signature) => signature.to_bytes(),
        _ => panic!("Only ED25519 keys supported"),
    }
}

'''
'''--- near-rs/package.json ---
{
  "name": "near",
  "version": "1.0.0",
  "license": "(MIT AND Apache-2.0)",
  "scripts": {
    "deploy": "cd contract && ./deploy.sh",
    "build": "yarn build:contract",
    "build:contract": "cd contract && ./build.sh",
    "test": "yarn test:unit && yarn test:integration",
    "test:unit": "cd contract && cargo test",
    "test:integration": "yarn build:contract && cd integration-tests && CONTRACT_LOCATION=\"../contract/target/wasm32-unknown-unknown/release/access_grants.wasm\" cargo test",
    "postinstall": "echo no frontend && echo rs tests && echo rs contract"
  },
  "devDependencies": {
    "near-cli": "^4.0.13"
  },
  "dependencies": {}
}

'''
'''--- near-rs/rust-toolchain.toml ---
[toolchain]
channel = "1.73"

'''