*GitHub Repository "nearprotocol/near-e2e-tests"*

'''--- .gitlab-ci.yml ---
image: node:10

variables:
  NODE_ENV: ci
  SELENIUM_BUILD: '$CI_JOB_NAME-$CI_JOB_ID'

stages:
  - test

test:
  stage: test
  script:
    - yarn
    - yarn test:ci

'''
'''--- README.md ---
# near-e2e-tests

![Build Status](https://gitlab.com/near-protocol/near-e2e-tests/badges/master/pipeline.svg)

End-to-end tests for NEAR apps

## Install dependencies

```
yarn
```

## Running locally
```
yarn test
```

## Running on cloud

Need to have environment variables or `.env` file:

```
ELENIUM_USERNAME=<username>
SELENIUM_ACCESS_KEY=<password/access key>
```

```
NODE_ENV=ci yarn test:ci
```

## Useful links

- [GitLab project](https://gitlab.com/near-protocol/near-e2e-tests)
- [CBT results](https://app.crossbrowsertesting.com/selenium/results)

'''
'''--- nightwatch.conf.js ---
module.exports = {
  src_folders: [
    'tests',
  ],
  test_runner: 'mocha',
  webdriver: {
    start_process: !getTestSettings().selenium_host,
    server_path: './node_modules/.bin/geckodriver',
    cli_args: [
      '--log',
      'debug',
    ],
    port: getTestSettings().selenium_port || 4444,
  },
  test_settings: {
    'default': getTestSettings()
  },
}

function exitWithError(message) {
  console.error(message);
  process.exit(1);
}

function getTestSettings() {
  switch (process.env.NODE_ENV) {
    case 'ci':
      return {
        launch_url: 'https://studio.nearprotocol.com',
        selenium_port: '80',
        selenium_host: 'hub.crossbrowsertesting.com',
        silent: true,
        screenshots: {
          enabled: false,
          path: '',
        },
        username: process.env.SELENIUM_USERNAME || exitWithError('Please set SELENIUM_USERNAME env variable'),
        access_key: process.env.SELENIUM_ACCESS_KEY || exitWithError('Please set SELENIUM_ACCESS_KEY env variable'),
        desiredCapabilities: {
          acceptSslCerts: '1',
          build: process.env.SELENIUM_BUILD || 'default',
          javascriptEnabled: '1',
          name: 'NEAR Studio',
          record_network: 'true',
          record_video: 'true',
          browserName: 'Chrome',
          version: '74',
          platform: 'Windows 10',
          screen_resolution: '1024x768',
        },
      }
    case 'development':
    default:
      return {
        desiredCapabilities: {
          browserName: 'firefox',
          acceptInsecureCerts: true,
          alwaysMatch: {
            'moz:firefoxOptions': {
              args: [
                '-headless',
              ],
            },
          },
        },
      };
  }
}
'''
'''--- package.json ---
{
  "name": "near-e2e-tests",
  "version": "0.0.1",
  "description": "End-to-end tests for NEAR Protocol apps",
  "main": "index.js",
  "scripts": {
    "test": "env $(cat .env || true) nightwatch",
    "test:ci": "env $(cat .env || true) ./run_ci.sh"
  },
  "author": "",
  "license": "MIT",
  "dependencies": {
    "cowsay": "^1.4.0",
    "geckodriver": "^1.16.2",
    "nightwatch": "^1.1.11",
    "ws": "^7.0.0"
  }
}

'''
'''--- run_ci.sh ---
#!/bin/bash
set -exo pipefail
if nightwatch; then
    cowsay GOOD JOB
else
    cowsay FAIL
fi

'''
'''--- tests/guest-book.js ---
describe('NEAR Studio', function() {
  before(function(client, done) {
    done();
  });

  it('Can run guest book project', function (client, done) {
    client
      .url('https://studio.nearprotocol.com')
      .waitForElementVisible('.modal-title-bar', 1000)
      .useXpath().click('//*[contains(text(), "NEAR Guest Book")]').useCss()
      .click('.button[title="Create"]')
      .waitForElementVisible('#near-guest-book', 5000)
      .assert.containsText('#near-guest-book', 'NEAR Guest Book')
      .waitForElementVisible('.button:not(.disabled)[title="Run Project: CtrlCmd + Enter"]')
      .click('.button[title="Run Project: CtrlCmd + Enter"]')
      .windowHandles(({ value: handles }) => {
        const popup = handles[1];
        client
          .switchWindow(popup)
          .waitForElementVisible('#login-button', 20000)
          .assert.containsText('#login-button', 'Login with NEAR Wallet')
          .end(done)
      })
  });

  after(function(client, done) {
    if (client.sessionId) {
      client.end(() => done());
    } else {
      done();
    }
  });

});

'''