*GitHub Repository "nearvndev/vbi-ft"*

'''--- Cargo.toml ---
[package]
name = "vbi-ft"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html
[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
near-sdk = "4.0.0-pre.7"
near-contract-standards = "4.0.0-pre.7"

[profile.release]
codegen-units = 1
# Tell `rustc` to optimize for small code size.
opt-level = "z"
lto = true
debug = false
panic = "abort"
# Opt into extra safety checks on arithmetic operations https://stackoverflow.com/a/64136471/249801
overflow-checks = true
'''
'''--- README.md ---
Fungible Token (FT)
===================

Example implementation of a [Fungible Token] contract which uses [near-contract-standards] and [simulation] tests. This is a contract-only example.

  [Fungible Token]: https://nomicon.io/Standards/FungibleToken/Core.html
  [near-contract-standards]: https://github.com/near/near-sdk-rs/tree/master/near-contract-standards
  [simulation]: https://github.com/near/near-sdk-rs/tree/master/near-sdk-sim

Prerequisites
=============

If you're using Gitpod, you can skip this step.

1. Make sure Rust is installed per the prerequisites in [`near-sdk-rs`](https://github.com/near/near-sdk-rs#pre-requisites)
2. Ensure `near-cli` is installed by running `near --version`. If not installed, install with: `npm install -g near-cli`

## Building

To build run:
```bash
./build.sh
```

Using this contract
===================

### Quickest deploy

You can build and deploy this smart contract to a development account. [Dev Accounts](https://docs.near.org/docs/concepts/account#dev-accounts) are auto-generated accounts to assist in developing and testing smart contracts. Please see the [Standard deploy](#standard-deploy) section for creating a more personalized account to deploy to.

```bash
near dev-deploy --wasmFile res/fungible_token.wasm --helperUrl https://near-contract-helper.onrender.com
```

Behind the scenes, this is creating an account and deploying a contract to it. On the console, notice a message like:

>Done deploying to dev-1234567890123

In this instance, the account is `dev-1234567890123`. A file has been created containing a key pair to
the account, located at `neardev/dev-account`. To make the next few steps easier, we're going to set an
environment variable containing this development account id and use that when copy/pasting commands.
Run this command to the environment variable:

```bash
source neardev/dev-account.env
```

You can tell if the environment variable is set correctly if your command line prints the account name after this command:
```bash
echo $CONTRACT_NAME
```

The next command will initialize the contract using the `new` method:

```bash
near call $CONTRACT_NAME new '{"owner_id": "'$CONTRACT_NAME'", "total_supply": "1000000000000000", "metadata": { "spec": "ft-1.0.0", "name": "Example Token Name", "symbol": "EXLT", "decimals": 8 }}' --accountId $CONTRACT_NAME
```

To get the fungible token metadata:

```bash
near view $CONTRACT_NAME ft_metadata
```

### Standard deploy

This smart contract will get deployed to your NEAR account. For this example, please create a new NEAR account. Because NEAR allows the ability to upgrade contracts on the same account, initialization functions must be cleared. If you'd like to run this example on a NEAR account that has had prior contracts deployed, please use the `near-cli` command `near delete`, and then recreate it in Wallet. To create (or recreate) an account, please follow the directions on [NEAR Wallet](https://wallet.near.org/).

Switch to `mainnet`. You can skip this step to use `testnet` as a default network.

    export NEAR_ENV=mainnet

In the project root, log in to your newly created account  with `near-cli` by following the instructions after this command:

    near login

To make this tutorial easier to copy/paste, we're going to set an environment variable for your account id. In the below command, replace `MY_ACCOUNT_NAME` with the account name you just logged in with, including the `.near`:

    ID=MY_ACCOUNT_NAME

You can tell if the environment variable is set correctly if your command line prints the account name after this command:

    echo $ID

Now we can deploy the compiled contract in this example to your account:

    near deploy --wasmFile res/fungible_token.wasm --accountId $ID

FT contract should be initialized before usage. You can read more about metadata at ['nomicon.io'](https://nomicon.io/Standards/FungibleToken/Metadata.html#reference-level-explanation). Modify the parameters and create a token:

    near call $ID new '{"owner_id": "'$ID'", "total_supply": "1000000000000000", "metadata": { "spec": "ft-1.0.0", "name": "Example Token Name", "symbol": "EXLT", "decimals": 8 }}' --accountId $ID

Get metadata:

    near view $ID ft_metadata

Transfer Example
---------------

Let's set up an account to transfer some tokens to. These account will be a sub-account of the NEAR account you logged in with.

    near create-account bob.$ID --masterAccount $ID --initialBalance 1

Add storage deposit for Bob's account:

    near call $ID storage_deposit '' --accountId bob.$ID --amount 0.00125

Check balance of Bob's account, it should be `0` for now:

    near view $ID ft_balance_of '{"account_id": "'bob.$ID'"}'

Transfer tokens to Bob from the contract that minted these fungible tokens, exactly 1 yoctoNEAR of deposit should be attached:

    near call $ID ft_transfer '{"receiver_id": "'bob.$ID'", "amount": "19"}' --accountId $ID --amount 0.000000000000000000000001

Check the balance of Bob again with the command from before and it will now return `19`.

## Testing

As with many Rust libraries and contracts, there are tests in the main fungible token implementation at `ft/src/lib.rs`.

Additionally, this project has [simulation] tests in `tests/sim`. Simulation tests allow testing cross-contract calls, which is crucial to ensuring that the `ft_transfer_call` function works properly. These simulation tests are the reason this project has the file structure it does. Note that the root project has a `Cargo.toml` which sets it up as a workspace. `ft` and `test-contract-defi` are both small & focused contract projects, the latter only existing for simulation tests. The root project imports `near-sdk-sim` and tests interaction between these contracts.

You can run all these tests with one command:

```bash
cargo test
```

If you want to run only simulation tests, you can use `cargo test simulate`, since all the simulation tests include "simulate" in their names.

## Notes

 - The maximum balance value is limited by U128 (`2**128 - 1`).
 - JSON calls should pass U128 as a base-10 string. E.g. "100".
 - This does not include escrow functionality, as `ft_transfer_call` provides a superior approach. An escrow system can, of course, be added as a separate contract or additional functionality within this contract.

## No AssemblyScript?

[near-contract-standards] is currently Rust-only. We strongly suggest using this library to create your own Fungible Token contract to ensure it works as expected.

Someday NEAR core or community contributors may provide a similar library for AssemblyScript, at which point this example will be updated to include both a Rust and AssemblyScript version.

'''
'''--- build.sh ---
#!/bin/bash
set -e

RUSTFLAGS='-C link-arg=-s' cargo build --target wasm32-unknown-unknown --release
mkdir -p out
cp target/wasm32-unknown-unknown/release/*.wasm out/vbi-ft.wasm
'''
'''--- src/lib.rs ---
use near_contract_standards::fungible_token::metadata::{
    FungibleTokenMetadata, FungibleTokenMetadataProvider, FT_METADATA_SPEC,
};
use near_contract_standards::fungible_token::FungibleToken;
use near_sdk::borsh::{self, BorshDeserialize, BorshSerialize};
use near_sdk::collections::LazyOption;
use near_sdk::json_types::U128;
use near_sdk::{env, log, near_bindgen, AccountId, Balance, PanicOnDefault, PromiseOrValue};

#[near_bindgen]
#[derive(BorshDeserialize, BorshSerialize, PanicOnDefault)]
pub struct Contract {
    token: FungibleToken,
    metadata: LazyOption<FungibleTokenMetadata>,
}

const DATA_ICON: &str = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAX9UlEQVRogaWaaZBc1ZXnf2/Nl3tmZWXtqlJtKm0lECAEYt/cYGyWYbCj7WiMm253e6Lnw3yY7xXzeT5MxER3T8f0uO3BBrNY2AbEIkASCIEMCLSDClVJte9VmZXbW+/EfZmFxCwdE/AUL0qRme++c+7Z/ud/rgIIvtGloio6oNQfVnyE6oX/FRurBhEUoTcWD1AUu/43/FpFBBpCafxY8Rp/Gz+Xiwg1fI8i6h8q9UVRCQgUgRBXhFe/mRJ1wQxTIxAugbDRdB9Na+gUyDuCRpS4lUaTYgubqK6gB6AFEZJ6HlNLoopIKLCCUd+UoL6GZmqNhTyE4vN1kVUQ2tek+RaKgO+7qGqApikoSn3XVAUMNYahWmRTaQK3hEqFtmbY1KqTMMDAJh2xMAKBVt9zNKGiCqO+sNiwsmjcAUIqtaFl46mrxf8WrgWGqaCqKr6n4Hle41MVDSN8hcBFI6B3Mzxw/266u/Kc+ugL3n/7Mosl+dModiANoqBoKl4Q4PhOaAVNV/GDhuANCdWgroAarhog8BAN5fT/h4z/X1cgd1RT8H3x1VIRQ0cJFBS/hkDQ0Qr33NnHww8MM9jfwfVbc8Q8l9+/OoMtquFOKoGGqpooikqganiBtLZ/Zau/uoKrrPB1Z5IqjnxTRYR0YcUg8DUUVFKJKBFDIXAr4WsySbjnji08/OBuerpMdBZoTau0ZmNEjHW+GKtge4QKe4EX7rWiaHXpVe2r3d64rgS91jDSldj5VhbZCDpNNdBU+SKX9VIl3B1DgVoJ9CAgl0yTsTTK61PEYybXD+exrL2cu/waY9MBM7ONJBc4qFoMTTPCWHO84Eo2C0NHhCHz1UZeJcm3sEg92EzDIggUAt8hkK4ioCkLt900RMIULEzNQK3K5vYWsgkDHQdLAdOyiDd1Y0SSFNeXKRaCUDCZvQQGvlAI8OqZq3GF9lDUhthSkSsWkT4xUnfUqwXcSG3/ex5Qr8oPSmhiwzDxw0CvEDWgJQ33397Nz598jD07hzj48kd8+NESHS0+mzrbCXwXIRxMU+ea667DD2zmZ2dYWq5h23VncYXAF/5GHg9dShX19ymN2Ki7XSOO0NHQGaHhlgo6KjoKZphODUsN094VdTR0zUDXtK8ySiadIhbXcCoVmqLw0x9s5WeP72WoNWBnf4aBbpOJS5c48NoCy8XLDO24hlxLglJplsCeoytv0dXRieu5TM2tsVoL8E2IJKOYEQ1NUVBcJRRUx8TUTIQa4OOgGvUtVZUEGlrDIgLUsJLWq7WMK9+3Q0vKzEQYhHoYD9LoQeCRiEdYL6xRq1TY1Ar/5oEB7r91gM05F9WbJ6iu0JzLkslmmZqb4JNPHVbWLtLV2cbQlh7KK+Nk4hq5bDMRK8ZaucTcYomqHWBEFGzbQUhjyywY/qvXFqmILJLhXkq5MaSt1BElrLxXuY5ShxyqFmBGIyiqSeg9Mk3KjCF8FOET1b3wRdkYPPzdLTz+vT0M9SWJGRVMQ7C2vkoml6Onv59oTGX0whTnzriIYJm2pnZy6QjRiEI0GaOlKUo8puE5BQprNoVVjyCQYERDkRup+iiKg1DcUExNVbAiaiixpcuEoygjihB12YXasIaoV1ItQNNNbFuAV3ctU9dRFQctCEIlBjfBv/3+AA/es5P+TgtLL6GoLhHLQLUMynYlLFx9fd10dMaYmJzg7Jkqi0uTDA9vC5MEfhXThI7WDG0tWWqlKpMTJTw3CJGVqoEm06AqY0diLIGqajiOT+DJQikLKMqIGsKxRsSH+U3aywvrjx9Wpw0lImiKh+/VQmTUkYUfPtzJDx7cTV+bhqmtEY0I1qtVLlyawEolicYN1stzqJrN4GAvugHnvpjj3KiDL8roVoymbBxDqZKKBnTks8SiUXR8Lk8W8D0fx/cRofMoBCIIA15TdDxPYGqCgc0Z6f7KCA00GtpswxpSIVVBNyNhwZPfStDnuethFKUt+Msfb+K+WwbY0hVHddewdB3dTHHi3CzPvXSKiblZBod2kstYLM3PkUxkaGnrZ3KuzPFPljj2WYFkRmVz7ybilk5QK2BqAfnmJgYH+/ly9AKBF1AqC/zAD2NUUUwUVQtvqUg2HWPv9QNSETEii5pQ1DADhLC6oYjM9YYWQfHDzI5ODTUQtGfhvjsz/PSHd9LVrBPDQfNUKhWDM18UeemNC7x8sMzJ8x6JZITO1jYs3UJXomhaltFLFY4cH0PCrcVCCeFpJOMpEjEThEMk4tHekiIa1cNqv7a4TrUqIIgilAiuIvClA/kq1VqFXMpHU1RGAmUjNpQG8AyxB77rE/geuDaq8IkhQkvccUuGv37ifvq6oxhBhahmEjGaGZuo8fvXT/Hy4Vlmi1CswOLsHO3pGDsGBojoJvOLJc5emOWTM1Nk29Jcmqxy8cI8Xe1pdmwfIhrRKFUWcJwCu6/bRa20zvTlBdaW/TA+fKHiSWwUCMxECt8pUyuU0YTCiPxcOq+Q4E/UY0SiUXyffDpJwlAQtkcuBn/z5G6e+PN7SMVsSpVpEok4UTPPJ6dm+R9PH+YPby0xVwYtmkPXdZyqw/jpGez1S9y4e5hsNssHH33KiVPLLK7YWBHwa/D52WlWV6bpHxyksztP1V6jVJxjeNsAw9u2Uy4u8/nYGo60ftTCk5Gimqh4uDUf6fwjesQKC12gqnVFNA1DUUlFY5QKRRTHY3sffPfeXm6/qZdNbSamXqGpJc9a2eeTE9O8/PpJ3vlwlbkqBGYKX5XZroTnBGzOwT239jLY30rNLrJcXEXT52lrh/7uOC1pDbvmMTlZYm7+IrGkycBAN26tgGuXSCWjdHS24bgVxi8VKDkOhhXFqdTC5g7PQVfCtKbguC54jZLvBSHeNywdFzAV2Ld3gIcfvJbB7jiWto4tIbyV5ezFRf5w4DPefnuVJQcCmeOjPqXiAhEB7Tm4485mhnd14XgzYfzddssmhnbkiFtxAhGlVknyyYkxnn3+HV46UMITx9jUvZmmVDO+t0LMKLB1e4aH7W1UfZu3P5pnsViqYz09gWaZslCrI74nwA1QNZWIYaJKeBIEWJogl/S5944eHrhvF9v6U8TNdXCL1JyAj88ucODged55Z4GFCqHSsXgSQZnAha5m+OH3evjRY3fQ0RahVFnEiEbI5TtJpxO0NllYqkO+KUNf7yYihsbszASz84KFxYsMbukjn2/Gdkusrq3S1tVNa0cvc7PrXLy0Evbu8o4YUQlR9BFcPwz2RCKGpasI20YRHjKJPPTd23nqyQfYPdyK8Gfw7WVwqxSK8N/++RCH3isyW5BPZ1CVODWniKkIWlPw2HdaefT+G9k6kMPxygSaQcnWOXl2nuMfniGbsCgVV6jVCkSjGn393XR1ZZiduciB110sa5l8aydWIoVqxkhlOpmcWuaDY6dYXXBoSimUKj62Y6NLyOGHRgrAsylVa1/h32rFJ26p5JtjxGMV3HIVVbHRNC3EZZOXYHWtDm00zaLsyxoTsDkPd+3N8NQP7qa12WB9fUHCJZRYjnOfX+aFFz7g3BkHU4uw57pe8m0ZKpUCMSvgtn2DVMsVFheP8tzzi6yuH+ahh+7kmt3bGRub5ZlnX+T8GcHu7VkSiQzvfzzOkgtaRLdGAs9HkRjE88L6njBN9l67E7u0gGsv4rlTJONV0gmXiC5CkkBRkzi+R6VcZGkpwAkqYa/R3QqP3NvN4/fvZufWPKK2hO1VqQiNk58vsP/AZxw+WmF2GUYvLmJGFVpa0qhKFbe6iKE5NGdb2Lp1kE9Pnuf02SqliksQZHjzrQ84dHiR/j6VRx9+kBtCiFNmamkZTdfNEeEHoV0SOuTicNe+rfzkR39GcXmMi6MrTM8s0rkpSv9AH7oewXNcdE3nhj3Xs7S8xJdfrlK1BV3SEjd38sifbWPP3j6Kcxep1KqYyTam1xSefvE99r9SpFCBTDbD5HyN5aVl4nGfvs158k0GbrUYpu2e3i3oZoIj71/k3IUVpmYv8/GfJulog58/9SDfuWs3u7b1EODy5dQEmmEaI5aeIPBqtEQFj9y3nZ/+8FpuvT7Nrp1NKOoM775f5fiJBVLpBJv7t6PrTthPWHqF4a09pKM+3voy99zazr//2ffZviXK5Pin1AKfTNsgh/80w3/6z6/wzjEHTwVPgXLVCwWuVHymJ1dQgiUGNjeRTmlUKwU832fHrj34qsvZ0Qmmpmrs22Pysydu49ZrUkSCKYqFCbbv3EI82yzdXR+xbZcIgttv3MrDD97A8KCJZ18Kd2pzXw/JjM75C4ucOTNFLK7S39tJPKqxvjJBc9qkp6OD7UM5dgzlScYdfHcVxTCJZ/t56+gYz71yihPnq6yWqZMNQg1bAVOT9cNneAgeeXAfg/3N1CpFAt8gmWnn+GejvPHOe8zOedy4J87jD+9jz3AbGaOAW10l2dTC6MQCrx8+UScfZG+saAEiokuyisCIYGhxfH+dnk0tPPbQTSwvzfLMMys895sPaI5b3Lqnl2i0ENKg+RaL5nwLnu9Qs2XkJUmmu/nkTIFf7z/Lq0dXcBoNcsSIEREGnlcA12HPLnj80RvYua2NWnkF30+gRFqYnFf55dN/5PNR6N8MD92/i1tu6iVp1HBKCoHezPSyzoFDJzl05CKaYegjETOK69VYWpqnUJwinTbY3N2GCKosLc4Rjxls3dJP4I7z0XGXS+OXMFTYfc1WPBnIpTUq5WU0USEajVKuaoyOlfnvvznKO8fmKXigR5NEohZa4GD6NpoQXL8T/vonN/O9e6/Bqaywvl4h29zH+LTPL3/zCocOlxnog8cf2skdN28haTqhxVzXpBxkef7AKf548BTnxmTrFAQjesjquVSrcHG8TOAthMizv6cd3ymhYbOps5merh4Ka6Oc/izgzNk5OjpyxKNZWlryKMLBsQtETJPp2SJvHDrF716ZYUFCFjVGLJ0m8Fbxqx5JXXDzbvj5kzey7/oOooZLuVTDjLYxNe/x25eO8Pz+GW7aA499fy8P3bOT5riHWy2jagmmlxTePj7Jr373J86MgaznmhBiRDb+hqmiaELiRFZWHcYvTjA02EV3Vxum6rAwO0W+Oc/w8LX4fomTZ1Y4/fk4EWmtrVuIJaJUKyvoho6mRylWBKfOLVCqQs13Qwvg2BgB3LJH4WdP3M29t2zGry5TLtZIpjuZWvD4h1+8wBtHVujrh3/31EPs2dlJU8LDLa5Sq6kUqlFeO3aJ//qrDxidgpoAMxpv8FpKne2LWFbYp5dKgrk5qFXmySSTZFMxquVVdA06+7roaG1GjZQ59vEKM4vzIX7KZlMYuk8kqpLMJcjl0kRiGqXCCivzAuE5NFlw+00pfvyDfdx5Sz+Gs4pXc/CDHJdnHJ7Zf5gDbxXp6Ye/+au7uXFnHstfxqiWcKsaF8YrvHpklOff/oIzl31cWWR1K+wetUjEGDEMFdcNcO0AiR013cA0fL64YBN4awxt6WVwoJdatURpTaZhg74t0pfH+PSkw/zcLL29rXR0tKGqCtXaGqXSKrfs28fi3CwLU+t45Tr2+vPHb+aB+3fhVOewC2UyqU7WqzF+u/9tnnlhjnwHPPXkjdx163aCyjT22hLxSA7d6uTQ8Wn+8dmTnJ7wieUyuH6AkESeK8lyEYwEfhBSlCHlo+j4wsDxJWjxmbhcY256HFM36dvcQa7JxHEWqdhr3Lh3H7qxztEjq3z4wTjZrEJP3wC6KVD1gPXCHHfddh1po0RMXeWpn9zF3XcMs1IcDUF2vmkLU9MO//Qv+/n9y0tcsxv+7uf3cesN3USUArpv09IzxPKSwn/559f4p99+wVQR/IhGuSypKkHckvI4IasyIqmgemeoNnp3PTSXaUZxXJviqofrVEhnorS2pjEtF9cthTA8n8th6SuMfllm9OICqYxFS7vsO8qkUyaKWwxrzY5tLXRvaiISk4yHhxcYfHFhnd88+zrvfbDGzmFprdsY3tqK7hdQXJt4rJlz5+d54fWTHPxwissrYMv2Qzbevodkf0xTsimuZFHq3O+VFrfBKyoKsWgKx/GoOh4z05Uw92fSMXJNMVJRHa+6RndbE9sGt1KrzHLkvTLj41O0tLfR27cFTfMol5foaIvT1p3Gd0socmoViTExU+EXTx/inXeLpFLwFz/axQN37yRl1MCuYplNXJoRvPjGKX792jinJ6EqlZBMiuujN6gFQ/Pr4aAp6ggbdFBjQqTIW8JIL0A3LISvUfMdFuZrVCuLpJIx2lubiWoO5cICuVyWoaGtrFcmeP9YlbmFMXL5Fjo7W0IywXaKrK8VQuIgkWrjwvgSv/v9u7x2sMLAIPzFj6/lrn1D6MEqgV3G0LOU7BS/2n+cg3+a4PQlH0+mJVPDtwPUAOIROWAS4WgjbGolrxUoOhsERDiakNyREASBj67qGJEogfAo2z7LK25YwZUg4JodPZTW5yiVlkIoPtDfR7kyzmefuXx0YpSe3laSmRZUOZnyLBLp3pBseO75d3n1lTI7d8Bjj97GIw/cQMKsUlxdxDAyzK9ZvHp4lH958TPGFnyqUizLqGMDR6AJiOh6GOyaoZJMJGV3LhWRdJBR540klR2IsK+wNB3bs6lJeK+pKKpHzYXVlQqTl+fY1NlEV1crsZjByupCGC9btwxRtVc4dXqdj098SbopzpahXeSa+xkdXeIXv3yJo++X6e6Bv/vbR7l2W564WcEpr6FpUUpuggNHvuQfnz7O6AKUJcMpqUY/qHexsldSNDw/5E2xYjGGd+yUiogRXzGl3eR4JqRN5YRCD/lgL+zdfbz6OFjXw3qzXhTMzsnCuUxr6ya6u9vw3DJetUhrSxPtHd00Nam89c48S2tTRCJ51isGL+5/kzffXGbLNvjLJ7/Lrde3E1NWsEur+K7KQkHltSOf8+tXT3LqMjihk0iZAlQvwBQyJkwCyaRJckAyPwJ6e7rCifJIIK2h1OcOSqiE34CSAtNQsRLxsImSDZikuRTpigQszjlhMtjU2UKnzFTlFUrry2TSSfp7e1DVZY4eLXD6zBeMjX/JsaNzpNPw5BP7uOeOHVTWxjBVgWVlsEWG9z+Z5u+f/pRTYxBvTlP1NFTNxFIVIqoaBrhEzr58vyqHTAa2LJaeLWlqRsKhScjfu+Ht41PnUQjZEknvh1FV5yLDb2SSk6TL5YtrjE9MYkQtBoY20ZKP4dcWcGrz7L1+F547wYfHbMYnq+zdDf/xP3yHu25up1ocDxvqptZBZpYV/v5Xb/IP//M80ytgxhM4rolTDZBNnyQJZbqVU19XSKJOyurhO5VQnmKxuDF6E42J6cYtGiL/66M3jUSocs1z8AIXM+KTiusk42CZoKsKmVSKiLVMf4/goQdvYqgvjXCmiFsa2eZBzl9c45W3TnLowy+5vAhOoGD7FrVawJXKdmXGHh6I2CDahbhq9PaNZ4gC3TAIsCmUBfOL65TK8yGMb2vNk2lpCenOttYsPd15dmzrZNe2bhIx+WiZeLKVmSWNP755ghdePs35MQkupSJg+xvzRBEOlZSrZoX1eqd8fWr9bcfToWNqIQ1LuSKzWYDrlcMJVWs+R81eh6BKc9YikzJwakUiEY1YLM1iQeHpFz7g4HsXOHsBKj7IYys1r24HMxqrT8xCRUTjHMqGCmpYsPnaUPCbKqLI4YsIh/uiUUtrNSgWHRzPw3VdOtrT6FoNTdTw7FI4Q9fNNJemShx89wK/fGGUsWmoSuElByxPUfj1cYYRMfFc+yqriK/sIDamalcp8q3m7PJwkGQUJb2v6/FQo9mldY4cm2Zqapp88z3sGspi+2sEwieX38ylqTLP/uFj3npvkctzhC2wPJkRBFpYlBWzfkzDcWqhAl/buX/l+lYWCRWRU2ShoYsoShDFEyrFks3CItj2MrFEgly2FTPSzPSiwh/ePM2Lr45zflKCbYNAiePKUYFPeK5FlyMt4RO4zlcD0PqtXrGNEvwfqehbWcSrye7MIEIctypwhNNABxbrTo39B4r4nKGneydmqp2DRw/xwh9PMzYnfyaVjoQFOxwxq2rYy4RIPAxqNQy++rjzSl7dODj0f9nXb3g6SD7ZOFeg+SqakNMlmcXkzkkULU9BBOTScN1wnlQsyoUvZphZ8KgGCQp2/bTChojhKQf8xm5vgHCpRl2R+qf140719HvVqSfgfwE0xC1/7Vkc7gAAAABJRU5ErkJggg==";

#[near_bindgen]
impl Contract {
    /// Initializes the contract with the given total supply owned by the given `owner_id` with
    /// default metadata (for example purposes only).
    #[init]
    pub fn new_default_meta(owner_id: AccountId, total_supply: U128) -> Self {
        Self::new(
            owner_id,
            total_supply,
            FungibleTokenMetadata {
                spec: FT_METADATA_SPEC.to_string(),
                name: "VBI Token".to_string(),
                symbol: "VBIC".to_string(),
                icon: Some(DATA_ICON.to_string()),
                reference: None,
                reference_hash: None,
                decimals: 24,
            },
        )
    }

    /// Initializes the contract with the given total supply owned by the given `owner_id` with
    /// the given fungible token metadata.
    #[init]
    pub fn new(
        owner_id: AccountId,
        total_supply: U128,
        metadata: FungibleTokenMetadata,
    ) -> Self {
        assert!(!env::state_exists(), "Already initialized");
        metadata.assert_valid();
        let mut this = Self {
            token: FungibleToken::new(b"a".to_vec()),
            metadata: LazyOption::new(b"m".to_vec(), Some(&metadata)),
        };
        this.token.internal_register_account(&owner_id);
        this.token.internal_deposit(&owner_id, total_supply.into());
        near_contract_standards::fungible_token::events::FtMint {
            owner_id: &owner_id,
            amount: &total_supply,
            memo: Some("Initial tokens supply is minted"),
        }
        .emit();
        this
    }

    fn on_account_closed(&mut self, account_id: AccountId, balance: Balance) {
        log!("Closed @{} with {}", account_id, balance);
    }

    fn on_tokens_burned(&mut self, account_id: AccountId, amount: Balance) {
        log!("Account @{} burned {}", account_id, amount);
    }
}

near_contract_standards::impl_fungible_token_core!(Contract, token, on_tokens_burned);
near_contract_standards::impl_fungible_token_storage!(Contract, token, on_account_closed);

#[near_bindgen]
impl FungibleTokenMetadataProvider for Contract {
    fn ft_metadata(&self) -> FungibleTokenMetadata {
        self.metadata.get().unwrap()
    }
}

#[cfg(all(test, not(target_arch = "wasm32")))]
mod tests {
    use near_sdk::test_utils::{accounts, VMContextBuilder};
    use near_sdk::MockedBlockchain;
    use near_sdk::{testing_env, Balance};

    use super::*;

    const TOTAL_SUPPLY: Balance = 1_000_000_000_000_000;

    fn get_context(predecessor_account_id: AccountId) -> VMContextBuilder {
        let mut builder = VMContextBuilder::new();
        builder
            .current_account_id(accounts(0))
            .signer_account_id(predecessor_account_id.clone())
            .predecessor_account_id(predecessor_account_id);
        builder
    }

    #[test]
    fn test_new() {
        let mut context = get_context(accounts(1));
        testing_env!(context.build());
        let contract = Contract::new_default_meta(accounts(1).into(), TOTAL_SUPPLY.into());
        testing_env!(context.is_view(true).build());
        assert_eq!(contract.ft_total_supply().0, TOTAL_SUPPLY);
        assert_eq!(contract.ft_balance_of(accounts(1)).0, TOTAL_SUPPLY);
    }

    #[test]
    #[should_panic(expected = "The contract is not initialized")]
    fn test_default() {
        let context = get_context(accounts(1));
        testing_env!(context.build());
        let _contract = Contract::default();
    }

    #[test]
    fn test_transfer() {
        let mut context = get_context(accounts(2));
        testing_env!(context.build());
        let mut contract = Contract::new_default_meta(accounts(2).into(), TOTAL_SUPPLY.into());
        testing_env!(context
            .storage_usage(env::storage_usage())
            .attached_deposit(contract.storage_balance_bounds().min.into())
            .predecessor_account_id(accounts(1))
            .build());
        // Paying for account registration, aka storage deposit
        contract.storage_deposit(None, None);

        testing_env!(context
            .storage_usage(env::storage_usage())
            .attached_deposit(1)
            .predecessor_account_id(accounts(2))
            .build());
        let transfer_amount = TOTAL_SUPPLY / 3;
        contract.ft_transfer(accounts(1), transfer_amount.into(), None);

        testing_env!(context
            .storage_usage(env::storage_usage())
            .account_balance(env::account_balance())
            .is_view(true)
            .attached_deposit(0)
            .build());
        assert_eq!(contract.ft_balance_of(accounts(2)).0, (TOTAL_SUPPLY - transfer_amount));
        assert_eq!(contract.ft_balance_of(accounts(1)).0, transfer_amount);
    }
}
'''