*GitHub Repository "phongnguyen2012/faucet-contract"*

'''--- Cargo.toml ---
[package]
name = "faucet-contract"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
near-sdk = "3.1.0"

[profile.release]
codegen-units = 1
# Tell `rustc` to optimize for small code size.
opt-level = "z"
lto = true
debug = false
panic = "abort"
# Opt into extra safety checks on arithmetic operations https://stackoverflow.com/a/64136471/249801
overflow-checks = true
'''
'''--- README.md ---
<sub>
  
## faucet-contract

  
### environment variable setting
  
  export MAIN_ACCOUNT=phongnguyen2022.testnet
  
  export NEAR_ENV=testnet
  
  export CONTRACT_FAUCET_ID=faucet.$MAIN_ACCOUNT
  
  export CONTRACT_FT_ID=ft.$MAIN_ACCOUNT
  
  export ONE_YOCTO=0.000000000000000000000005
  
  export ACCOUNT_TEST1=test1.$MAIN_ACCOUNT
  
  export ACCOUNT_TEST2=test2.$MAIN_ACCOUNT
  
  export GAS=300000000000000

  echo "################### DELETE ACCOUNT ###################"
 
  near delete $CONTRACT_FAUCET_ID $MAIN_ACCOUNT
  
  near delete $ACCOUNT_TEST1 $MAIN_ACCOUNT
  
  near delete $ACCOUNT_TEST2 $MAIN_ACCOUNT

   echo "################### CREATE ACCOUNT ###################"
  
   near create-account $CONTRACT_FT_ID --masterAccount $MAIN_ACCOUNT --initialBalance 2
  
   near create-account $ACCOUNT_TEST1 --masterAccount $MAIN_ACCOUNT --initialBalance 2
  
   near create-account $ACCOUNT_TEST2 --masterAccount $MAIN_ACCOUNT --initialBalance 2
  

 ### 1. Deploy:
  
   near deploy --wasmFile out/faucetcontract.wasm --accountId $CONTRACT_FAUCET_ID

 ### 2. Init contract: with max_share: 10M
  
   near call $$CONTRACT_FAUCET_ID new '{"owner_id": "'$MAIN_ACCOUNT'", "ft_contract_id": "'$CONTRACT_FT_ID'", "max_share": 10000000}' 
   
   --accountId $MAIN_ACCOUNT

 ### 3. Update contract: with max_share: 30M
  
   near call $CONTRACT_FAUCET_ID update_max_share '{"max_share": "30000000"}' --accountId $MAIN_ACCOUNT

 ### 4. Update contract: Total token in contract 1B, total_share 10M
  
   near call $CONTRACT_FAUCET_ID update_pool '{"total_balance_share": "1000000000", "total_share": "10000000", "total_account_share": "1"}' 
   
    --accountId $MAIN_ACCOUNT

 ### 5. Account faucet token
  
   account (faucet) faucet 1M Token 
   
   near call $CONTRACT_FAUCET_ID faucet_token '{"amount": "1000000"}' --accountId $CONTRACT_FAUCET_ID --deposit $ONE_YOCTO --gas $GAS

   account (test1) faucet 2M Token 
   
   near call $CONTRACT_FAUCET_ID faucet_token '{"amount": "2000000"}' --accountId $ACCOUNT_TEST1 --deposit $ONE_YOCTO --gas $GAS

   account (test2) faucet 3M Token 
  
   near call $CONTRACT_FAUCET_ID faucet_token '{"amount": "3000000"}' --accountId $ACCOUNT_TEST2 --deposit $ONE_YOCTO --gas $GAS

 ### 6. Get info faucet
  
   near call $CONTRACT_FAUCET_ID get_faucet_info '' --accountId $CONTRACT_FAUCET_ID

 ### 7. Get info balance
  
   near call $CONTRACT_FAUCET_ID get_share_balance_of '{"account_id": "'$ACCOUNT_TEST1'"}' --accountId $MAIN_ACCOUNT
  
   near call $CONTRACT_FAUCET_ID get_share_balance_of '{"account_id": "'$ACCOUNT_TEST2'"}' --accountId $MAIN_ACCOUNT
  
</sub>

'''
'''--- build.sh ---
#!/bin/bash
set -e

RUSTFLAGS='-C link-arg=-s' cargo build --target wasm32-unknown-unknown --release
mkdir -p out
cp target/wasm32-unknown-unknown/release/*.wasm out/faucet-contract.wasm
'''
'''--- src/lib.rs ---
use near_sdk::collections::LookupMap;
use near_sdk::{AccountId, env, near_bindgen, Balance, BorshStorageKey, Gas, PromiseOrValue, ext_contract, Promise, PanicOnDefault};
use near_sdk::borsh::{self, BorshDeserialize, BorshSerialize};
use near_sdk::serde::{Serialize, Deserialize};
use near_sdk::json_types::{U128};

pub const FT_TRANSFER_GAS: Gas = 10_000_000_000_000;
pub const WITHDRAW_CALLBACK_GAS: Gas = 10_000_000_000_000;
pub const FAUCET_CALLBACK_GAS: Gas = 10_000_000_000_000;

pub trait FungibleTokenReceiver {
    fn ft_on_transfer(&mut self, sender_id: AccountId, amount: U128, msg: String) -> PromiseOrValue<U128>;
}

#[ext_contract(ext_ft_contract)]
pub trait FungibleTokenCore {
    fn ft_transfer(&mut self, receiver_id: AccountId, amount: U128, memo: Option<String>);
}

#[ext_contract(ext_self)]
pub trait ExtStakingContract {
    fn ft_transfer_callback(&mut self, amount: U128, account_id: AccountId);
}

#[derive(BorshDeserialize, BorshSerialize, PanicOnDefault)]
#[near_bindgen]
struct FaucetContract {
    pub owner_id: AccountId,
    pub ft_contract_id: AccountId,
    pub total_balance_share: Balance,
    pub total_shared: Balance,
    pub total_account_shared: Balance,
    pub accounts: LookupMap<AccountId, Balance>,
    pub max_share_per_account: Balance,
    pub is_paused: bool
}

#[derive(BorshDeserialize, BorshSerialize, BorshStorageKey)]
pub enum StorageKey {
    AccountKey
}

#[derive(Serialize, Deserialize)]
#[serde(crate = "near_sdk::serde")]
pub struct FaucetInfo {
    pub total_balance_share: U128,
    pub total_shared: U128,
    pub total_account_shared: U128,
    pub max_share_per_account: U128,
    pub is_paused: bool
}

#[near_bindgen]
impl FaucetContract {

    #[init]
    pub fn new(owner_id: AccountId, ft_contract_id: AccountId, max_share: U128) -> Self {
        FaucetContract { 
            owner_id, 
            ft_contract_id, 
            total_balance_share: 0, 
            total_shared: 0, 
            total_account_shared: 0, 
            accounts: LookupMap::new(StorageKey::AccountKey),
            max_share_per_account: max_share.0,
            is_paused: false
         }
    }

    #[payable]
    pub fn faucet_token(&mut self, amount: U128) -> Promise {
        assert!(env::attached_deposit() > 1, "ERR_DEPOSIT_GREATER_THAN_ONE_YOCTO");
        assert!(self.total_balance_share >= amount.0, "ERR_NOT_ENOUGH_TOKEN_TO_SHARE");
        assert!(!self.is_paused, "ERR_FAUCET_PAUSED");
        let account_id: AccountId = env::predecessor_account_id();
        let account_balance: Balance = self.accounts.get(&account_id).unwrap_or_else(|| 0);
        assert!(account_balance + amount.0 <= self.max_share_per_account, "ERR_INVALID_AMOUNT");

        ext_ft_contract::ft_transfer(
            account_id.clone(), 
            amount, 
            Some(String::from("Faucet by VBI Dev")), 
            &self.ft_contract_id, 
            1, 
            FT_TRANSFER_GAS
        ).then(ext_self::ft_transfer_callback(
            amount, 
            account_id.clone(), 
            &env::current_account_id(), 
            0, 
            FAUCET_CALLBACK_GAS
        ))
    }

    #[private]
    pub fn ft_transfer_callback(&mut self, amount: U128, account_id: AccountId) {
        let mut account_balance: Balance = self.accounts.get(&account_id).unwrap_or_else(|| 0);
        if account_balance == 0 {
            self.total_account_shared += 1;
        }

        account_balance += amount.0;

        self.accounts.insert(&account_id,&account_balance);
        self.total_shared += amount.0;
        self.total_balance_share -= amount.0;
    }

    pub fn update_max_share(&mut self, max_share: U128) {
        assert_eq!(env::predecessor_account_id(), self.owner_id, "ERR_MUST_BE_OWNER");
        self.max_share_per_account = max_share.0;
    }

    pub fn get_faucet_info(&self) -> FaucetInfo {
        FaucetInfo { 
            total_balance_share: U128(self.total_balance_share), 
            total_shared: U128(self.total_shared), 
            total_account_shared: U128(self.total_account_shared),
            max_share_per_account: U128(self.max_share_per_account), 
            is_paused: self.is_paused
        }
    }

    pub fn get_shared_balance_of(&self, account_id: AccountId) -> U128 {
        let balance: Balance = self.accounts.get(&account_id).unwrap_or_else(|| 0);
        U128(balance)
    }
}

#[near_bindgen]
impl FungibleTokenReceiver for FaucetContract {
    fn ft_on_transfer(&mut self, sender_id: AccountId, amount: U128, msg: String) -> PromiseOrValue<U128> {
        assert_eq!(sender_id, self.owner_id, "ERR_SENDER_MUST_BE_OWNER");
        assert_eq!(env::predecessor_account_id(), self.ft_contract_id, "ERR_INVALID_FT_CONTRACT_ID");

        self.total_balance_share += amount.0;

        PromiseOrValue::Value(U128(0))
    }
}
'''