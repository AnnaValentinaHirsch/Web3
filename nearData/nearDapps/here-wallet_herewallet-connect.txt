*GitHub Repository "here-wallet/herewallet-connect"*

'''--- README.md ---
# @herewallet/connect

```bash
npm i @here-wallet/connect --save
```

> Make sure your near-api-js is version ^1.0.0

## Usage

```ts
import * as near from "near-api-js"
import runHereWallet from "@here-wallet/connect" 
import "@here-wallet/connect/index.css" 

// Initialize here wallet bridge
runHereWallet({ near, onlyHere: true })

// Just keep using the near api just like you did before!
const initialize = async () => {
    const near = await connect({ ... })
    const wallet = new WalletConnection(near, "app");

    wallet.requestSignIn({
      contractId: "contract",
      methodNames: ["method"],
    });
}
```

## Options

* `near`<br/>
  By default Here use global near package

* `onlyHere`<br/>
  By default here show popup with choose between near wallet and here wallet, but with this flag all methods will be redirects to herewallet

## Dispose

You can enable and disable herewallet patching at any time, for example:

```ts
let dispose;
const enableHereWallet = () => {
  dispose = runHereWallet({ near, onlyHere: true })
}

const disableHereWallet = () => {
  if (dispose == null) return
  dispose()
}
```

## Patching
Herewallet bridge absolutely safe, code of this lib just wrap few prototypes methods of WalletConnection and Account:

```ts
// add balance of liquidity stake from here account
acount.getBalance()

// Resolve redirects to herewallet 
wallet.requestSignIn()
wallet.requestSignTransactions()
```

## Networks

At the moment here wallet only supports mainnet and testnet networks. If you specify some other network in the near-api initialization, `@here-wallet/connect` will be ignored and all signatures will go through your near-api settings. Our endpoints:

```ts
  mainnet: {
    hereWallet: "https://web.herewallet.app",
    hereContract: "storage.herewallet.near",
  },
  testnet: {
    hereWallet: "https://web.testnet.herewallet.app",
    hereContract: "storage.herewallet.testnet",
  }
```

'''
'''--- dist/index.d.ts ---
import * as NEAR from "near-api-js";
export declare const defaultConfig: {
    near: typeof NEAR;
    onlyHere: boolean;
    mainnet: {
        hereWallet: string;
        hereContract: string;
    };
    testnet: {
        hereWallet: string;
        hereContract: string;
    };
};
declare const runHereWallet: (_config?: Partial<typeof defaultConfig>) => () => void;
export default runHereWallet;

'''
'''--- dist/index.js ---
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.defaultConfig = void 0;
const bn_js_1 = __importDefault(require("bn.js"));
const NEAR = __importStar(require("near-api-js"));
const selector_1 = require("./selector");
exports.defaultConfig = {
    near: NEAR,
    onlyHere: true,
    mainnet: {
        hereWallet: "https://web.herewallet.app",
        hereContract: "storage.herewallet.near",
    },
    testnet: {
        hereWallet: "https://web.testnet.herewallet.app",
        hereContract: "storage.herewallet.testnet",
    },
};
const runHereWallet = (_config = {}) => {
    const config = Object.assign(Object.assign(Object.assign({}, exports.defaultConfig), _config), { testnet: Object.assign(Object.assign({}, exports.defaultConfig.testnet), _config.testnet), mainnet: Object.assign(Object.assign({}, exports.defaultConfig.mainnet), _config.mainnet) });
    const { near, onlyHere } = config;
    const pathing = {
        fnGetAccountBalance: near.Account.prototype.getAccountBalance,
        fnRequestSignIn: near.WalletConnection.prototype.requestSignIn,
        fnRequestSignTransactions: near.WalletConnection.prototype.requestSignTransactions,
    };
    near.Account.prototype.getAccountBalance = function () {
        return __awaiter(this, void 0, void 0, function* () {
            const result = yield pathing.fnGetAccountBalance.call(this);
            const options = config[this.connection.networkId];
            if (options != null) {
                const params = { account_id: this.accountId };
                const hereCoins = yield this.viewFunction(options.hereContract, "ft_balance_of", params).catch(() => "0");
                let total = new bn_js_1.default(hereCoins).add(new bn_js_1.default(result.available));
                result.available = total.toString();
            }
            return result;
        });
    };
    near.WalletConnection.prototype.requestSignIn = function (...args) {
        return __awaiter(this, void 0, void 0, function* () {
            const realBaseUrl = this._walletBaseUrl;
            const options = config[this._networkId];
            if (options != null) {
                const select = onlyHere ? "here" : yield (0, selector_1.selector)().catch(() => null);
                if (select == null)
                    return;
                if (select === "here") {
                    this._walletBaseUrl = options.hereWallet;
                }
            }
            try {
                yield pathing.fnRequestSignIn.call(this, ...args);
            }
            catch (e) {
                throw e;
            }
            finally {
                this._walletBaseUrl = realBaseUrl;
            }
        });
    };
    near.WalletConnection.prototype.requestSignTransactions = function (...args) {
        return __awaiter(this, void 0, void 0, function* () {
            const realBaseUrl = this._walletBaseUrl;
            const options = config[this._networkId];
            if (options != null) {
                const select = onlyHere ? "here" : yield (0, selector_1.selector)().catch(() => null);
                if (select == null)
                    return;
                if (select === "here") {
                    this._walletBaseUrl = options.hereWallet;
                }
            }
            try {
                // @ts-ignore multi function signatures
                yield pathing.fnRequestSignTransactions.call(this, ...args);
            }
            catch (e) {
                throw e;
            }
            finally {
                this._walletBaseUrl = realBaseUrl;
            }
        });
    };
    return () => {
        near.Account.prototype.getAccountBalance = function () {
            return __awaiter(this, void 0, void 0, function* () {
                return yield pathing.fnGetAccountBalance.call(this);
            });
        };
        near.WalletConnection.prototype.requestSignIn = function (...args) {
            return __awaiter(this, void 0, void 0, function* () {
                return yield pathing.fnRequestSignIn.call(this, ...args);
            });
        };
        near.WalletConnection.prototype.requestSignTransactions = function (...args) {
            return __awaiter(this, void 0, void 0, function* () {
                // @ts-ignore multi function signatures
                return yield pathing.fnRequestSignTransactions.call(this, ...args);
            });
        };
    };
};
exports.default = runHereWallet;

'''
'''--- dist/selector.d.ts ---
export declare class Task<T> {
    promise: Promise<T>;
    resolve: (v: T) => void;
    reject: () => void;
    constructor();
}
export declare const selector: () => Promise<"here" | "near">;

'''
'''--- dist/selector.js ---
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.selector = exports.Task = void 0;
const template = ({ prefix = "herewallet" }) => `
    <div class="${prefix}__overlay">
        <div class="${prefix}__modal">
            <p class="${prefix}__title">Pick wallet</p>
            <div class="${prefix}__picker">
                <button class="${prefix}__button ${prefix}__near">
                    <img src="https://web.herewallet.app/assets/near.svg" alt="here" />
                    NEAR Wallet (web)
                </button>
                <button class="${prefix}__button ${prefix}__here">
                    <img src="https://web.herewallet.app/assets/here.svg" alt="here" />
                    HERE Wallet (mobile)
                </button>
            </div>
            <a class="${prefix}__link" target=”_blank” rel=”noopener noreferrer” href="https://herewallet.app/howto">Learn more about wallets</a>
        </div>
    </div>
`;
class Task {
    constructor() {
        this.promise = new Promise((resolve, reject) => {
            this.resolve = resolve;
            this.reject = reject;
        });
    }
}
exports.Task = Task;
const selector = () => {
    const task = new Task();
    const prefix = "herewallet";
    const container = document.createElement('div');
    container.innerHTML = template({ prefix });
    const $modal = container.getElementsByClassName(`${prefix}__modal`)[0];
    const $overlay = container.getElementsByClassName(`${prefix}__overlay`)[0];
    const $hereButton = container.getElementsByClassName(`${prefix}__here`)[0];
    const $nearButton = container.getElementsByClassName(`${prefix}__near`)[0];
    $overlay === null || $overlay === void 0 ? void 0 : $overlay.addEventListener('click', () => dispose());
    $modal === null || $modal === void 0 ? void 0 : $modal.addEventListener('click', (e) => e.stopPropagation());
    $hereButton === null || $hereButton === void 0 ? void 0 : $hereButton.addEventListener('click', () => task.resolve('here'));
    $nearButton === null || $nearButton === void 0 ? void 0 : $nearButton.addEventListener('click', () => task.resolve('near'));
    document.body.appendChild(container);
    const dispose = () => {
        document.body.removeChild(container);
        task.reject();
    };
    return task.promise;
};
exports.selector = selector;

'''
'''--- index.css ---
.herewallet__overlay {
    background: rgba(0, 0, 0, 0.2);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;

    display: flex;
    align-items: center;
    justify-content: center;

    animation: herewallet-overlay 0.2s forwards;
}

.herewallet__modal * {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}

.herewallet__modal {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 24px 24px 32px;

    width: 402px;
    left: 519px;
    top: 207px;

    background: #FFFFFF;
    border-radius: 8px;

    animation: herewallet-modal 0.3s cubic-bezier(0.38, 0.1, 0.36, 0.9) forwards;
}

.herewallet__title {
    font-style: normal;
    font-weight: 800;
    font-size: 20px;
    line-height: 27px;
    color: #2C3034;
    margin: 0;
}

.herewallet__link {
    font-style: normal;
    font-weight: 500;
    text-decoration: none;
    font-size: 14px;
    line-height: 19px;
    color: #6B6661;
    margin: 0;
    margin-top: 16px;
    transition: 0.2s color;
}

.herewallet__link:hover {
    color: #333;
}

.herewallet__picker {
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
}

.herewallet__button {
    box-sizing: border-box;
    background: #fff;
    width: 100%;

    display: flex;
    align-items: center;

    padding: 12px 8px 12px 16px;
    gap: 8px;

    height: 64px;
    border: 2px solid #EEEEEF;
    border-radius: 8px;

    font-style: normal;
    font-weight: 700;
    font-size: 16px;
    line-height: 22px;
    color: #2C3034;

    cursor: pointer;
    transition: 0.2s box-shadow;
}

.herewallet__button:hover {
    box-shadow: 0 0 8px 0 rgba(0, 0, 0, .08);
}

@keyframes herewallet-overlay {
    0% {
        background: rgba(0, 0, 0, 0);
    }

    100% {
        background: rgba(0, 0, 0, 0.2);
    }
}

@keyframes herewallet-modal {
    0% {
        transform: scale(1) translateY(0px);
        opacity: 0;
        box-shadow: 0 0 0 rgba(241, 241, 241, 0);
    }

    1% {
        transform: scale(0.96) translateY(10px);
        opacity: 0;
        box-shadow: 0 0 0 rgba(241, 241, 241, 0);
    }

    100% {
        transform: scale(1) translateY(0px);
        opacity: 1;
        box-shadow: 0 0 500px rgba(241, 241, 241, 0);
    }
}
'''
'''--- package-lock.json ---
{
  "name": "@here-wallet/connect",
  "version": "0.1.1",
  "lockfileVersion": 2,
  "requires": true,
  "packages": {
    "": {
      "name": "@here-wallet/connect",
      "version": "0.1.1",
      "license": "ISC",
      "devDependencies": {
        "@types/bn.js": "^5.1.0",
        "typescript": "^4.7.4"
      },
      "peerDependencies": {
        "bn.js": "^5.2.1",
        "near-api-js": "^1.0.0"
      }
    },
    "node_modules/@types/bn.js": {
      "version": "5.1.0",
      "resolved": "https://registry.npmjs.org/@types/bn.js/-/bn.js-5.1.0.tgz",
      "integrity": "sha512-QSSVYj7pYFN49kW77o2s9xTCwZ8F2xLbjLLSEVh8D2F4JUhZtPAGOFLTD+ffqksBx/u4cE/KImFjyhqCjn/LIA==",
      "dev": true,
      "dependencies": {
        "@types/node": "*"
      }
    },
    "node_modules/@types/node": {
      "version": "18.7.9",
      "resolved": "https://registry.npmjs.org/@types/node/-/node-18.7.9.tgz",
      "integrity": "sha512-0N5Y1XAdcl865nDdjbO0m3T6FdmQ4ijE89/urOHLREyTXbpMWbSafx9y7XIsgWGtwUP2iYTinLyyW3FatAxBLQ==",
      "dev": true
    },
    "node_modules/base-x": {
      "version": "3.0.9",
      "resolved": "https://registry.npmjs.org/base-x/-/base-x-3.0.9.tgz",
      "integrity": "sha512-H7JU6iBHTal1gp56aKoaa//YUxEaAOUiydvrV/pILqIHXTtqxSkATOnDA2u+jZ/61sD+L/412+7kzXRtWukhpQ==",
      "peer": true,
      "dependencies": {
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/bn.js": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/bn.js/-/bn.js-5.2.1.tgz",
      "integrity": "sha512-eXRvHzWyYPBuB4NBy0cmYQjGitUrtqwbvlzP3G6VFnNRbsZQIxQ10PbKKHt8gZ/HW/D/747aDl+QkDqg3KQLMQ==",
      "peer": true
    },
    "node_modules/borsh": {
      "version": "0.7.0",
      "resolved": "https://registry.npmjs.org/borsh/-/borsh-0.7.0.tgz",
      "integrity": "sha512-CLCsZGIBCFnPtkNnieW/a8wmreDmfUtjU2m9yHrzPXIlNbqVs0AQrSatSG6vdNYUqdc83tkQi2eHfF98ubzQLA==",
      "peer": true,
      "dependencies": {
        "bn.js": "^5.2.0",
        "bs58": "^4.0.0",
        "text-encoding-utf-8": "^1.0.2"
      }
    },
    "node_modules/bs58": {
      "version": "4.0.1",
      "resolved": "https://registry.npmjs.org/bs58/-/bs58-4.0.1.tgz",
      "integrity": "sha512-Ok3Wdf5vOIlBrgCvTq96gBkJw+JUEzdBgyaza5HLtPm7yTHkjRy8+JzNyHF7BHa0bNWOQIp3m5YF0nnFcOIKLw==",
      "peer": true,
      "dependencies": {
        "base-x": "^3.0.2"
      }
    },
    "node_modules/capability": {
      "version": "0.2.5",
      "resolved": "https://registry.npmjs.org/capability/-/capability-0.2.5.tgz",
      "integrity": "sha512-rsJZYVCgXd08sPqwmaIqjAd5SUTfonV0z/gDJ8D6cN8wQphky1kkAYEqQ+hmDxTw7UihvBfjUVUSY+DBEe44jg==",
      "peer": true
    },
    "node_modules/depd": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/depd/-/depd-2.0.0.tgz",
      "integrity": "sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==",
      "peer": true,
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/error-polyfill": {
      "version": "0.1.3",
      "resolved": "https://registry.npmjs.org/error-polyfill/-/error-polyfill-0.1.3.tgz",
      "integrity": "sha512-XHJk60ufE+TG/ydwp4lilOog549iiQF2OAPhkk9DdiYWMrltz5yhDz/xnKuenNwP7gy3dsibssO5QpVhkrSzzg==",
      "peer": true,
      "dependencies": {
        "capability": "^0.2.5",
        "o3": "^1.0.3",
        "u3": "^0.1.1"
      }
    },
    "node_modules/http-errors": {
      "version": "1.8.1",
      "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-1.8.1.tgz",
      "integrity": "sha512-Kpk9Sm7NmI+RHhnj6OIWDI1d6fIoFAtFt9RLaTMRlg/8w49juAStsrBgp0Dp4OdxdVbRIeKhtCUvoi/RuAhO4g==",
      "peer": true,
      "dependencies": {
        "depd": "~1.1.2",
        "inherits": "2.0.4",
        "setprototypeof": "1.2.0",
        "statuses": ">= 1.5.0 < 2",
        "toidentifier": "1.0.1"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/http-errors/node_modules/depd": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/depd/-/depd-1.1.2.tgz",
      "integrity": "sha512-7emPTl6Dpo6JRXOXjLRxck+FlLRX5847cLKEn00PLAgc3g2hTZZgr+e4c2v6QpSmLeFP3n5yUo7ft6avBK/5jQ==",
      "peer": true,
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/inherits": {
      "version": "2.0.4",
      "resolved": "https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz",
      "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==",
      "peer": true
    },
    "node_modules/js-sha256": {
      "version": "0.9.0",
      "resolved": "https://registry.npmjs.org/js-sha256/-/js-sha256-0.9.0.tgz",
      "integrity": "sha512-sga3MHh9sgQN2+pJ9VYZ+1LPwXOxuBJBA5nrR5/ofPfuiJBE2hnjsaN8se8JznOmGLN2p49Pe5U/ttafcs/apA==",
      "peer": true
    },
    "node_modules/mustache": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/mustache/-/mustache-4.2.0.tgz",
      "integrity": "sha512-71ippSywq5Yb7/tVYyGbkBggbU8H3u5Rz56fH60jGFgr8uHwxs+aSKeqmluIVzM0m0kB7xQjKS6qPfd0b2ZoqQ==",
      "peer": true,
      "bin": {
        "mustache": "bin/mustache"
      }
    },
    "node_modules/near-api-js": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/near-api-js/-/near-api-js-1.0.0.tgz",
      "integrity": "sha512-OYItaQIYlKK27FG5PrqqtkTI8Vv9TEOCi7gXePYigS4o6WofXciAXNjr4sihDJ8Vzi6s7+eEkf3zTNP3042FBw==",
      "peer": true,
      "dependencies": {
        "bn.js": "5.2.1",
        "borsh": "^0.7.0",
        "bs58": "^4.0.0",
        "depd": "^2.0.0",
        "error-polyfill": "^0.1.3",
        "http-errors": "^1.7.2",
        "js-sha256": "^0.9.0",
        "mustache": "^4.0.0",
        "node-fetch": "^2.6.1",
        "text-encoding-utf-8": "^1.0.2",
        "tweetnacl": "^1.0.1"
      }
    },
    "node_modules/node-fetch": {
      "version": "2.6.7",
      "resolved": "https://registry.npmjs.org/node-fetch/-/node-fetch-2.6.7.tgz",
      "integrity": "sha512-ZjMPFEfVx5j+y2yF35Kzx5sF7kDzxuDj6ziH4FFbOp87zKDZNx8yExJIb05OGF4Nlt9IHFIMBkRl41VdvcNdbQ==",
      "peer": true,
      "dependencies": {
        "whatwg-url": "^5.0.0"
      },
      "engines": {
        "node": "4.x || >=6.0.0"
      },
      "peerDependencies": {
        "encoding": "^0.1.0"
      },
      "peerDependenciesMeta": {
        "encoding": {
          "optional": true
        }
      }
    },
    "node_modules/o3": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/o3/-/o3-1.0.3.tgz",
      "integrity": "sha512-f+4n+vC6s4ysy7YO7O2gslWZBUu8Qj2i2OUJOvjRxQva7jVjYjB29jrr9NCjmxZQR0gzrOcv1RnqoYOeMs5VRQ==",
      "peer": true,
      "dependencies": {
        "capability": "^0.2.5"
      }
    },
    "node_modules/safe-buffer": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.2.1.tgz",
      "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "peer": true
    },
    "node_modules/setprototypeof": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/setprototypeof/-/setprototypeof-1.2.0.tgz",
      "integrity": "sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw==",
      "peer": true
    },
    "node_modules/statuses": {
      "version": "1.5.0",
      "resolved": "https://registry.npmjs.org/statuses/-/statuses-1.5.0.tgz",
      "integrity": "sha512-OpZ3zP+jT1PI7I8nemJX4AKmAX070ZkYPVWV/AaKTJl+tXCTGyVdC1a4SL8RUQYEwk/f34ZX8UTykN68FwrqAA==",
      "peer": true,
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/text-encoding-utf-8": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/text-encoding-utf-8/-/text-encoding-utf-8-1.0.2.tgz",
      "integrity": "sha512-8bw4MY9WjdsD2aMtO0OzOCY3pXGYNx2d2FfHRVUKkiCPDWjKuOlhLVASS+pD7VkLTVjW268LYJHwsnPFlBpbAg==",
      "peer": true
    },
    "node_modules/toidentifier": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
      "peer": true,
      "engines": {
        "node": ">=0.6"
      }
    },
    "node_modules/tr46": {
      "version": "0.0.3",
      "resolved": "https://registry.npmjs.org/tr46/-/tr46-0.0.3.tgz",
      "integrity": "sha512-N3WMsuqV66lT30CrXNbEjx4GEwlow3v6rr4mCcv6prnfwhS01rkgyFdjPNBYd9br7LpXV1+Emh01fHnq2Gdgrw==",
      "peer": true
    },
    "node_modules/tweetnacl": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/tweetnacl/-/tweetnacl-1.0.3.tgz",
      "integrity": "sha512-6rt+RN7aOi1nGMyC4Xa5DdYiukl2UWCbcJft7YhxReBGQD7OAM8Pbxw6YMo4r2diNEA8FEmu32YOn9rhaiE5yw==",
      "peer": true
    },
    "node_modules/typescript": {
      "version": "4.7.4",
      "resolved": "https://registry.npmjs.org/typescript/-/typescript-4.7.4.tgz",
      "integrity": "sha512-C0WQT0gezHuw6AdY1M2jxUO83Rjf0HP7Sk1DtXj6j1EwkQNZrHAg2XPWlq62oqEhYvONq5pkC2Y9oPljWToLmQ==",
      "dev": true,
      "bin": {
        "tsc": "bin/tsc",
        "tsserver": "bin/tsserver"
      },
      "engines": {
        "node": ">=4.2.0"
      }
    },
    "node_modules/u3": {
      "version": "0.1.1",
      "resolved": "https://registry.npmjs.org/u3/-/u3-0.1.1.tgz",
      "integrity": "sha512-+J5D5ir763y+Am/QY6hXNRlwljIeRMZMGs0cT6qqZVVzzT3X3nFPXVyPOFRMOR4kupB0T8JnCdpWdp6Q/iXn3w==",
      "peer": true
    },
    "node_modules/webidl-conversions": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/webidl-conversions/-/webidl-conversions-3.0.1.tgz",
      "integrity": "sha512-2JAn3z8AR6rjK8Sm8orRC0h/bcl/DqL7tRPdGZ4I1CjdF+EaMLmYxBHyXuKL849eucPFhvBoxMsflfOb8kxaeQ==",
      "peer": true
    },
    "node_modules/whatwg-url": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/whatwg-url/-/whatwg-url-5.0.0.tgz",
      "integrity": "sha512-saE57nupxk6v3HY35+jzBwYa0rKSy0XR8JSxZPwgLr7ys0IBzhGviA1/TUGJLmSVqs8pb9AnvICXEuOHLprYTw==",
      "peer": true,
      "dependencies": {
        "tr46": "~0.0.3",
        "webidl-conversions": "^3.0.0"
      }
    }
  },
  "dependencies": {
    "@types/bn.js": {
      "version": "5.1.0",
      "resolved": "https://registry.npmjs.org/@types/bn.js/-/bn.js-5.1.0.tgz",
      "integrity": "sha512-QSSVYj7pYFN49kW77o2s9xTCwZ8F2xLbjLLSEVh8D2F4JUhZtPAGOFLTD+ffqksBx/u4cE/KImFjyhqCjn/LIA==",
      "dev": true,
      "requires": {
        "@types/node": "*"
      }
    },
    "@types/node": {
      "version": "18.7.9",
      "resolved": "https://registry.npmjs.org/@types/node/-/node-18.7.9.tgz",
      "integrity": "sha512-0N5Y1XAdcl865nDdjbO0m3T6FdmQ4ijE89/urOHLREyTXbpMWbSafx9y7XIsgWGtwUP2iYTinLyyW3FatAxBLQ==",
      "dev": true
    },
    "base-x": {
      "version": "3.0.9",
      "resolved": "https://registry.npmjs.org/base-x/-/base-x-3.0.9.tgz",
      "integrity": "sha512-H7JU6iBHTal1gp56aKoaa//YUxEaAOUiydvrV/pILqIHXTtqxSkATOnDA2u+jZ/61sD+L/412+7kzXRtWukhpQ==",
      "peer": true,
      "requires": {
        "safe-buffer": "^5.0.1"
      }
    },
    "bn.js": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/bn.js/-/bn.js-5.2.1.tgz",
      "integrity": "sha512-eXRvHzWyYPBuB4NBy0cmYQjGitUrtqwbvlzP3G6VFnNRbsZQIxQ10PbKKHt8gZ/HW/D/747aDl+QkDqg3KQLMQ==",
      "peer": true
    },
    "borsh": {
      "version": "0.7.0",
      "resolved": "https://registry.npmjs.org/borsh/-/borsh-0.7.0.tgz",
      "integrity": "sha512-CLCsZGIBCFnPtkNnieW/a8wmreDmfUtjU2m9yHrzPXIlNbqVs0AQrSatSG6vdNYUqdc83tkQi2eHfF98ubzQLA==",
      "peer": true,
      "requires": {
        "bn.js": "^5.2.0",
        "bs58": "^4.0.0",
        "text-encoding-utf-8": "^1.0.2"
      }
    },
    "bs58": {
      "version": "4.0.1",
      "resolved": "https://registry.npmjs.org/bs58/-/bs58-4.0.1.tgz",
      "integrity": "sha512-Ok3Wdf5vOIlBrgCvTq96gBkJw+JUEzdBgyaza5HLtPm7yTHkjRy8+JzNyHF7BHa0bNWOQIp3m5YF0nnFcOIKLw==",
      "peer": true,
      "requires": {
        "base-x": "^3.0.2"
      }
    },
    "capability": {
      "version": "0.2.5",
      "resolved": "https://registry.npmjs.org/capability/-/capability-0.2.5.tgz",
      "integrity": "sha512-rsJZYVCgXd08sPqwmaIqjAd5SUTfonV0z/gDJ8D6cN8wQphky1kkAYEqQ+hmDxTw7UihvBfjUVUSY+DBEe44jg==",
      "peer": true
    },
    "depd": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/depd/-/depd-2.0.0.tgz",
      "integrity": "sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==",
      "peer": true
    },
    "error-polyfill": {
      "version": "0.1.3",
      "resolved": "https://registry.npmjs.org/error-polyfill/-/error-polyfill-0.1.3.tgz",
      "integrity": "sha512-XHJk60ufE+TG/ydwp4lilOog549iiQF2OAPhkk9DdiYWMrltz5yhDz/xnKuenNwP7gy3dsibssO5QpVhkrSzzg==",
      "peer": true,
      "requires": {
        "capability": "^0.2.5",
        "o3": "^1.0.3",
        "u3": "^0.1.1"
      }
    },
    "http-errors": {
      "version": "1.8.1",
      "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-1.8.1.tgz",
      "integrity": "sha512-Kpk9Sm7NmI+RHhnj6OIWDI1d6fIoFAtFt9RLaTMRlg/8w49juAStsrBgp0Dp4OdxdVbRIeKhtCUvoi/RuAhO4g==",
      "peer": true,
      "requires": {
        "depd": "~1.1.2",
        "inherits": "2.0.4",
        "setprototypeof": "1.2.0",
        "statuses": ">= 1.5.0 < 2",
        "toidentifier": "1.0.1"
      },
      "dependencies": {
        "depd": {
          "version": "1.1.2",
          "resolved": "https://registry.npmjs.org/depd/-/depd-1.1.2.tgz",
          "integrity": "sha512-7emPTl6Dpo6JRXOXjLRxck+FlLRX5847cLKEn00PLAgc3g2hTZZgr+e4c2v6QpSmLeFP3n5yUo7ft6avBK/5jQ==",
          "peer": true
        }
      }
    },
    "inherits": {
      "version": "2.0.4",
      "resolved": "https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz",
      "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==",
      "peer": true
    },
    "js-sha256": {
      "version": "0.9.0",
      "resolved": "https://registry.npmjs.org/js-sha256/-/js-sha256-0.9.0.tgz",
      "integrity": "sha512-sga3MHh9sgQN2+pJ9VYZ+1LPwXOxuBJBA5nrR5/ofPfuiJBE2hnjsaN8se8JznOmGLN2p49Pe5U/ttafcs/apA==",
      "peer": true
    },
    "mustache": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/mustache/-/mustache-4.2.0.tgz",
      "integrity": "sha512-71ippSywq5Yb7/tVYyGbkBggbU8H3u5Rz56fH60jGFgr8uHwxs+aSKeqmluIVzM0m0kB7xQjKS6qPfd0b2ZoqQ==",
      "peer": true
    },
    "near-api-js": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/near-api-js/-/near-api-js-1.0.0.tgz",
      "integrity": "sha512-OYItaQIYlKK27FG5PrqqtkTI8Vv9TEOCi7gXePYigS4o6WofXciAXNjr4sihDJ8Vzi6s7+eEkf3zTNP3042FBw==",
      "peer": true,
      "requires": {
        "bn.js": "5.2.1",
        "borsh": "^0.7.0",
        "bs58": "^4.0.0",
        "depd": "^2.0.0",
        "error-polyfill": "^0.1.3",
        "http-errors": "^1.7.2",
        "js-sha256": "^0.9.0",
        "mustache": "^4.0.0",
        "node-fetch": "^2.6.1",
        "text-encoding-utf-8": "^1.0.2",
        "tweetnacl": "^1.0.1"
      }
    },
    "node-fetch": {
      "version": "2.6.7",
      "resolved": "https://registry.npmjs.org/node-fetch/-/node-fetch-2.6.7.tgz",
      "integrity": "sha512-ZjMPFEfVx5j+y2yF35Kzx5sF7kDzxuDj6ziH4FFbOp87zKDZNx8yExJIb05OGF4Nlt9IHFIMBkRl41VdvcNdbQ==",
      "peer": true,
      "requires": {
        "whatwg-url": "^5.0.0"
      }
    },
    "o3": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/o3/-/o3-1.0.3.tgz",
      "integrity": "sha512-f+4n+vC6s4ysy7YO7O2gslWZBUu8Qj2i2OUJOvjRxQva7jVjYjB29jrr9NCjmxZQR0gzrOcv1RnqoYOeMs5VRQ==",
      "peer": true,
      "requires": {
        "capability": "^0.2.5"
      }
    },
    "safe-buffer": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.2.1.tgz",
      "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
      "peer": true
    },
    "setprototypeof": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/setprototypeof/-/setprototypeof-1.2.0.tgz",
      "integrity": "sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw==",
      "peer": true
    },
    "statuses": {
      "version": "1.5.0",
      "resolved": "https://registry.npmjs.org/statuses/-/statuses-1.5.0.tgz",
      "integrity": "sha512-OpZ3zP+jT1PI7I8nemJX4AKmAX070ZkYPVWV/AaKTJl+tXCTGyVdC1a4SL8RUQYEwk/f34ZX8UTykN68FwrqAA==",
      "peer": true
    },
    "text-encoding-utf-8": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/text-encoding-utf-8/-/text-encoding-utf-8-1.0.2.tgz",
      "integrity": "sha512-8bw4MY9WjdsD2aMtO0OzOCY3pXGYNx2d2FfHRVUKkiCPDWjKuOlhLVASS+pD7VkLTVjW268LYJHwsnPFlBpbAg==",
      "peer": true
    },
    "toidentifier": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
      "peer": true
    },
    "tr46": {
      "version": "0.0.3",
      "resolved": "https://registry.npmjs.org/tr46/-/tr46-0.0.3.tgz",
      "integrity": "sha512-N3WMsuqV66lT30CrXNbEjx4GEwlow3v6rr4mCcv6prnfwhS01rkgyFdjPNBYd9br7LpXV1+Emh01fHnq2Gdgrw==",
      "peer": true
    },
    "tweetnacl": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/tweetnacl/-/tweetnacl-1.0.3.tgz",
      "integrity": "sha512-6rt+RN7aOi1nGMyC4Xa5DdYiukl2UWCbcJft7YhxReBGQD7OAM8Pbxw6YMo4r2diNEA8FEmu32YOn9rhaiE5yw==",
      "peer": true
    },
    "typescript": {
      "version": "4.7.4",
      "resolved": "https://registry.npmjs.org/typescript/-/typescript-4.7.4.tgz",
      "integrity": "sha512-C0WQT0gezHuw6AdY1M2jxUO83Rjf0HP7Sk1DtXj6j1EwkQNZrHAg2XPWlq62oqEhYvONq5pkC2Y9oPljWToLmQ==",
      "dev": true
    },
    "u3": {
      "version": "0.1.1",
      "resolved": "https://registry.npmjs.org/u3/-/u3-0.1.1.tgz",
      "integrity": "sha512-+J5D5ir763y+Am/QY6hXNRlwljIeRMZMGs0cT6qqZVVzzT3X3nFPXVyPOFRMOR4kupB0T8JnCdpWdp6Q/iXn3w==",
      "peer": true
    },
    "webidl-conversions": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/webidl-conversions/-/webidl-conversions-3.0.1.tgz",
      "integrity": "sha512-2JAn3z8AR6rjK8Sm8orRC0h/bcl/DqL7tRPdGZ4I1CjdF+EaMLmYxBHyXuKL849eucPFhvBoxMsflfOb8kxaeQ==",
      "peer": true
    },
    "whatwg-url": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/whatwg-url/-/whatwg-url-5.0.0.tgz",
      "integrity": "sha512-saE57nupxk6v3HY35+jzBwYa0rKSy0XR8JSxZPwgLr7ys0IBzhGviA1/TUGJLmSVqs8pb9AnvICXEuOHLprYTw==",
      "peer": true,
      "requires": {
        "tr46": "~0.0.3",
        "webidl-conversions": "^3.0.0"
      }
    }
  }
}

'''
'''--- package.json ---
{
  "name": "@here-wallet/connect",
  "version": "0.2.1",
  "description": "HereWallet lib for connect with near-api-js",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "homepage": "https://github.com/here-wallet/herewallet-connect",
  "repository": {
    "type": "git",
    "url": "git+ssh://git@github.com/here-wallet/herewallet-connect.git"
  },
  "scripts": {
    "build": "tsc"
  },
  "author": "here-wallet",
  "devDependencies": {
    "@types/bn.js": "^5.1.0",
    "typescript": "^4.7.4"
  },
  "peerDependencies": {
    "bn.js": "^5.2.1",
    "near-api-js": "^1.0.0"
  },
  "bugs": {
    "url": "https://github.com/here-wallet/herewallet-connect/issues"
  },
  "license": "ISC"
}

'''
'''--- src/index.ts ---
import BN from "bn.js";
import * as NEAR from "near-api-js";
import { selector } from "./selector";

export const defaultConfig = {
  near: NEAR,
  onlyHere: true,
  mainnet: {
    hereWallet: "https://web.herewallet.app",
    hereContract: "storage.herewallet.near",
  },
  testnet: {
    hereWallet: "https://web.testnet.herewallet.app",
    hereContract: "storage.herewallet.testnet",
  },
};

const runHereWallet = (_config: Partial<typeof defaultConfig> = {}) => {
  const config: typeof defaultConfig = {
    ...defaultConfig,
    ..._config,
    testnet: { ...defaultConfig.testnet, ..._config.testnet },
    mainnet: { ...defaultConfig.mainnet, ..._config.mainnet },
  };

  const { near, onlyHere } = config;
  const pathing = {
    fnGetAccountBalance: near.Account.prototype.getAccountBalance,
    fnRequestSignIn: near.WalletConnection.prototype.requestSignIn,
    fnRequestSignTransactions: near.WalletConnection.prototype.requestSignTransactions,
  };

  near.Account.prototype.getAccountBalance = async function () {
    const result = await pathing.fnGetAccountBalance.call(this);

    const options = config[this.connection.networkId];
    if (options != null) {
      const params = { account_id: this.accountId };
      const hereCoins = await this.viewFunction(options.hereContract, "ft_balance_of", params).catch(() => "0");
      let total = new BN(hereCoins).add(new BN(result.available));
      result.available = total.toString();
    }

    return result;
  };

  near.WalletConnection.prototype.requestSignIn = async function (...args) {
    const realBaseUrl = this._walletBaseUrl;
    const options = config[this._networkId];

    if (options != null) {
      const select = onlyHere ? "here" : await selector().catch(() => null);
      if (select == null) return;
      if (select === "here") {
        this._walletBaseUrl = options.hereWallet;
      }
    }

    try {
      await pathing.fnRequestSignIn.call(this, ...args);
    } catch (e) {
      throw e;
    } finally {
      this._walletBaseUrl = realBaseUrl;
    }
  };

  near.WalletConnection.prototype.requestSignTransactions = async function (...args) {
    const realBaseUrl = this._walletBaseUrl;
    const options = config[this._networkId];

    if (options != null) {
      const select = onlyHere ? "here" : await selector().catch(() => null);
      if (select == null) return;
      if (select === "here") {
        this._walletBaseUrl = options.hereWallet;
      }
    }

    try {
      // @ts-ignore multi function signatures
      await pathing.fnRequestSignTransactions.call(this, ...args);
    } catch (e) {
      throw e;
    } finally {
      this._walletBaseUrl = realBaseUrl;
    }
  };

  return () => {
    near.Account.prototype.getAccountBalance = async function () {
      return await pathing.fnGetAccountBalance.call(this);
    };

    near.WalletConnection.prototype.requestSignIn = async function (...args) {
      return await pathing.fnRequestSignIn.call(this, ...args);
    };

    near.WalletConnection.prototype.requestSignTransactions = async function (...args) {
      // @ts-ignore multi function signatures
      return await pathing.fnRequestSignTransactions.call(this, ...args);
    };
  };
};

export default runHereWallet;

'''
'''--- src/selector.ts ---
const template = ({ prefix = "herewallet" }) => `
    <div class="${prefix}__overlay">
        <div class="${prefix}__modal">
            <p class="${prefix}__title">Pick wallet</p>
            <div class="${prefix}__picker">
                <button class="${prefix}__button ${prefix}__near">
                    <img src="https://web.herewallet.app/assets/near.svg" alt="here" />
                    NEAR Wallet (web)
                </button>
                <button class="${prefix}__button ${prefix}__here">
                    <img src="https://web.herewallet.app/assets/here.svg" alt="here" />
                    HERE Wallet (mobile)
                </button>
            </div>
            <a class="${prefix}__link" target=”_blank” rel=”noopener noreferrer” href="https://herewallet.app/howto">Learn more about wallets</a>
        </div>
    </div>
`

export class Task<T> {
    promise: Promise<T>
    resolve!: (v: T) => void
    reject!: () => void;

    constructor() {
        this.promise = new Promise<T>((resolve, reject) => {
            this.resolve = resolve
            this.reject = reject
        })
    }
}

export const selector = () => {
    const task = new Task<"here" | "near">()

    const prefix = "herewallet"
    const container = document.createElement('div');
    container.innerHTML = template({ prefix });

    const $modal = container.getElementsByClassName(`${prefix}__modal`)[0]
    const $overlay = container.getElementsByClassName(`${prefix}__overlay`)[0]
    const $hereButton = container.getElementsByClassName(`${prefix}__here`)[0]
    const $nearButton = container.getElementsByClassName(`${prefix}__near`)[0]

    $overlay?.addEventListener('click', () => dispose());
    $modal?.addEventListener('click', (e) => e.stopPropagation())
    $hereButton?.addEventListener('click', () => task.resolve('here'))
    $nearButton?.addEventListener('click', () => task.resolve('near'))
    document.body.appendChild(container)

    const dispose = () => {
        document.body.removeChild(container)
        task.reject()
    }

    return task.promise
}
'''
'''--- tsconfig.json ---
{
  "compilerOptions": {
    "esModuleInterop": true,
    "lib": ["es2015", "esnext", "dom"],
    "module": "commonjs",
    "target": "es2015",
    "moduleResolution": "node",
    "alwaysStrict": true,
    "outDir": "./dist",
    "declaration": true
  },
  "exclude": ["node_modules", "dist"]
}

'''